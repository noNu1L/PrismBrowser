<template>
  <div class="tabs-bar drag-region">
    <div class="tabs-bar-left">
      <!-- æ ‡ç­¾åŒºåŸŸ -->
      <div class="tabs-area" ref="tabsAreaRef" @mouseenter="onTabAreaMouseEnter" @mouseleave="onTabAreaMouseLeave">
        <!-- è‡ªå®šä¹‰æ ‡ç­¾é¡µ -->
        <div class="tabs-container" ref="sortableContainer">
          <div
              v-for="tab in localTabs"
              :key="tab.id"
              :class="['tab-item', {
                'active': tab.id === tabsStore.activeTabId,
                'closing': closingTabs.has(tab.id),
                'entering': enteringTabs.has(tab.id),
                'hide-close-btn': tab.width < 80
              }]"
              :style="getTabStyle(tab)"
              @click="setActiveTab(tab.id)"
              :id="`tab-${tab.id}`"
              :data-tab-id="tab.id"
          >
            <div class="tab-content no-drag">
              <el-icon class="tab-icon"><Document /></el-icon>
              <span class="tab-title">{{ tab.title }}</span>
              <button
                  class="tab-close-btn"
                  @click.stop="closeTab(tab.id)"
              >
                <el-icon><Close /></el-icon>
              </button>
            </div>
          </div>
        </div>
        <!-- æ–°å¢æ ‡ç­¾æŒ‰é’® -->
        <el-button
            class="no-drag add-tab-btn"
            size="small"
            :icon="Plus"
            @click="addTab"
        />
      </div>
    </div>
    <el-button-group class="window-controls">
      <el-button class="window-btn" @click.stop="minimize" title="æœ€å°åŒ–" size="small" :icon="Minus"/>
      <el-button class="window-btn" @click.stop="maximize" title="æœ€å¤§åŒ–/è¿˜åŸ" size="small" :icon="FullScreen"/>
      <el-button class="window-btn close" @click.stop="close" title="å…³é—­" size="small" :icon="Close"/>
    </el-button-group>
  </div>
</template>

<script setup>
import { ref, watch, onMounted, onUnmounted, nextTick } from 'vue'
import { useTabsStore } from '../../store/tabsStore'
import {Close, FullScreen, Minus, Plus, Document, CloseBold} from "@element-plus/icons-vue"
import Sortable from 'sortablejs'

const tabsStore = useTabsStore()
const tabsAreaRef = ref(null)
const sortableContainer = ref(null)

// [GPT-4, 2024-06-28 19:00:00 Asia/Hong_Kong] æœ¬åœ°UIçŠ¶æ€ï¼šå…³é—­åŠ¨ç”»ã€è¿›å…¥åŠ¨ç”»ã€å®½åº¦ã€æ‚¬åœã€æ‹–æ‹½
const closingTabs = ref(new Set()) // æ­£åœ¨å…³é—­çš„æ ‡ç­¾idé›†åˆ
const enteringTabs = ref(new Set()) // æ­£åœ¨è¿›å…¥çš„æ ‡ç­¾idé›†åˆ
const tabWidths = ref({}) // { [tabId]: width }
const isHoveringTabArea = ref(false)
const pendingWidthUpdate = ref(false)
const localTabs = ref([])

// æ‹–æ‹½ç›¸å…³çŠ¶æ€
const isDragging = ref(false)
const draggedTabId = ref(null)
let sortableInstance = null

onMounted(() => {
  syncTabsFromStore()
  window.addEventListener('resize', handleResize)
  updateAllTabWidths()
  
  // åˆå§‹åŒ–SortableJS
  initSortable()

      // æš´éœ²ç»„ä»¶å®ä¾‹åˆ°å…¨å±€ï¼Œä¾›è°ƒè¯•é¢æ¿ä½¿ç”¨
    window.tabsBarInstance = {
      tabsStore,
      updateAllTabWidths,
      // è°ƒè¯•é¢æ¿éœ€è¦çš„æ–¹æ³•å’Œå±æ€§
      addTab,
      closeTab,
      setActiveTab,
      updateTab,
      // æš´éœ²å“åº”å¼æ•°æ®
      localTabs,
      tabWidths,
      isHoveringTabArea,
      closingTabs,
      enteringTabs,
      isDragging,
      draggedTabId,
      // æš´éœ²SortableJSå®ä¾‹
      sortableInstance,
      // æš´éœ² tabsStore çš„æ–¹æ³•
      closeAllTabs: () => tabsStore.closeAllTabs(),
      closeHalfTabs: () => tabsStore.closeHalfTabs(),
      addMultipleTabs: (count) => {
        for (let i = 0; i < count; i++) {
          tabsStore.addTab({ active: i === count - 1, loading: true })
        }
      },
      // åœ¨æŒ‡å®šä½ç½®æ’å…¥æ ‡ç­¾çš„æ–¹æ³•
      insertTabAt: (position, tabOptions) => {
        return tabsStore.insertTabAt(position, tabOptions)
      },
      // ä¾¿æ·æ–¹æ³•ï¼šåœ¨ç¬¬2ä¸ªä½ç½®æ’å…¥æ ‡ç­¾
      insertTabAtSecond: () => {
        return tabsStore.insertTabAt(1, { active: true, loading: true, title: 'æ–°æ ‡ç­¾(ä½ç½®2)' })
      },
      // ä¾¿æ·æ–¹æ³•ï¼šåœ¨ç¬¬5ä¸ªä½ç½®æ’å…¥æ ‡ç­¾
      insertTabAtFifth: () => {
        return tabsStore.insertTabAt(4, { active: true, loading: true, title: 'æ–°æ ‡ç­¾(ä½ç½®5)' })
      }
    }
})

onUnmounted(() => {
  window.removeEventListener('resize', handleResize)
  // æ¸…ç†SortableJSå®ä¾‹
  if (sortableInstance) {
    sortableInstance.destroy()
    sortableInstance = null
  }
})

watch(() => tabsStore.tabs, (newStoreTabs) => {
  const localTabIds = new Set(localTabs.value.map(t => t.id));
  const storeTabIds = new Set(newStoreTabs.map(t => t.id));

  // [GPT-4, 2024-06-28 20:05:00 Asia/Hong_Kong] æ£€æŸ¥IDé›†åˆæ˜¯å¦ä¸€è‡´ï¼Œé¿å…ä¸å¿…è¦é‡æ¸²æŸ“
  if (localTabIds.size !== storeTabIds.size || [...localTabIds].some(id => !storeTabIds.has(id))) {
    nextTick(() => {
      syncTabsFromStore()
    });
  }
}, { deep: true });

function diffAndSyncTabs(newTabs, oldTabs) {
  console.log('[TabsBar][diffAndSyncTabs] æ¯”è¾ƒå¹¶åŒæ­¥tabs', {
    newTabs: newTabs.map(t => ({ id: t.id, width: t.width })),
    oldTabs: oldTabs.map(t => ({ id: t.id, width: t.width })),
    localTabs: localTabs.value.map(t => ({ id: t.id, width: t.width })),
    isHoveringTabArea: isHoveringTabArea.value,
    pendingWidthUpdate: pendingWidthUpdate.value
  })
  // æ–°å¢æ ‡ç­¾
  newTabs.forEach(tab => {
    if (!localTabs.value.find(t => t.id === tab.id)) {
      console.log(`[TabsBar][diffAndSyncTabs][${now()}] æ–°å¢æ ‡ç­¾:`, tab)
      localTabs.value.push({ ...tab })
      
      // è§¦å‘è¿›å…¥åŠ¨ç”»
      enteringTabs.value.add(tab.id)
      setTimeout(() => {
        enteringTabs.value.delete(tab.id)
        console.log(`[TabsBar][diffAndSyncTabs] è¿›å…¥åŠ¨ç”»ç»“æŸ: ${tab.id}`)
      }, 250)
    }
  })
  // åˆ é™¤æ ‡ç­¾ï¼ˆè®¾ç½®closingï¼ŒåŠ¨ç”»åç§»é™¤ï¼‰
  localTabs.value.forEach((tab, idx) => {
    if (!newTabs.find(t => t.id === tab.id)) {
      console.log(`[TabsBar][diffAndSyncTabs][${now()}] åˆ é™¤æ ‡ç­¾:`, tab)
      closingTabs.value.add(tab.id)
      setTimeout(() => {
        const i = localTabs.value.findIndex(t => t.id === tab.id)
        if (i !== -1) localTabs.value.splice(i, 1)
        closingTabs.value.delete(tab.id)
        updateAllTabWidths()
      }, 250)
    }
  })
  // æ›´æ–°æ ‡ç­¾å†…å®¹
  newTabs.forEach(tab => {
    const local = localTabs.value.find(t => t.id === tab.id)
    if (local) {
      for (const key in tab) {
        if (key !== 'id' && local[key] !== tab[key]) {
          console.log(`[TabsBar][diffAndSyncTabs][${now()}] æ›´æ–°æ ‡ç­¾${tab.id}å­—æ®µ${key}: ${local[key]} â†’ ${tab[key]}`)
          local[key] = tab[key]
        }
      }
    }
  })
  updateAllTabWidths()
}

function syncTabsFromStore() {
  console.log('[TabsBar][syncTabsFromStore] ä»PiniaåŒæ­¥tabs', {
    tabsStoreTabs: tabsStore.tabs.map(t => ({ id: t.id, width: t.width })),
    localTabs: localTabs.value.map(t => ({ id: t.id, width: t.width })),
    isHoveringTabArea: isHoveringTabArea.value,
    pendingWidthUpdate: pendingWidthUpdate.value
  })
  localTabs.value = tabsStore.tabs.map(tab => ({ ...tab }))
  updateAllTabWidths()
}

function addTab() {
  console.log(`[TabsBar][addTab][${now()}] æ–°å¢æ ‡ç­¾`)
  tabsStore.addTab({ active: true, loading: true })
}

function closeTab(tabId) {
  console.log(`[TabsBar][closeTab] å¼€å§‹å…³é—­æ ‡ç­¾: ${tabId}`)
  console.log(`[TabsBar][closeTab] localTabs:`)
  localTabs.value.forEach(t => console.log(`  - æ ‡ç­¾${t.id}: width=${t.width}`))
  console.log(`[TabsBar][closeTab] tabWidths:`, { ...tabWidths.value })
  console.log(`[TabsBar][closeTab] isHoveringTabArea:`, isHoveringTabArea.value)
  console.log(`[TabsBar][closeTab] pendingWidthUpdate:`, pendingWidthUpdate.value)
  closingTabs.value.add(tabId)
  pendingWidthUpdate.value = true

  // å…ˆæ‰§è¡Œå…³é—­åŠ¨ç”»
  const index = localTabs.value.findIndex(tab => tab.id === tabId)
  if (index !== -1) {
    const tab = localTabs.value[index]
    tab.closing = true
  }

  setTimeout(() => {
    // åŠ¨ç”»ç»“æŸåï¼Œç§»é™¤å…³é—­çŠ¶æ€å¹¶åŒæ­¥åˆ°Pinia
    closingTabs.value.delete(tabId)
    tabsStore.removeTab(tabId)
    // æœ¬åœ°ä¹Ÿç§»é™¤
    const idx = localTabs.value.findIndex(tab => tab.id === tabId)
    if (idx !== -1) localTabs.value.splice(idx, 1)

    // å¦‚æœé¼ æ ‡å·²ç»ç¦»å¼€ï¼Œç«‹å³æ›´æ–°å®½åº¦
    if (!isHoveringTabArea.value) {
      updateAllTabWidths()
      pendingWidthUpdate.value = false
    }
    console.log(`[TabsBar][closeTab] åŠ¨ç”»ç»“æŸï¼Œç§»é™¤æ ‡ç­¾: ${tabId}`)
    console.log(`[TabsBar][closeTab] localTabs:`)
    localTabs.value.forEach(t => console.log(`  - æ ‡ç­¾${t.id}: width=${t.width}`))
    console.log(`[TabsBar][closeTab] tabWidths:`, { ...tabWidths.value })
    console.log(`[TabsBar][closeTab] isHoveringTabArea:`, isHoveringTabArea.value)
    console.log(`[TabsBar][closeTab] pendingWidthUpdate:`, pendingWidthUpdate.value)
  }, 250)
}

function setActiveTab(tabId) {
  console.log(`[TabsBar][setActiveTab][${now()}] æ¿€æ´»æ ‡ç­¾: ${tabId}`)
  tabsStore.setActiveTab(tabId)
}

function updateTab(id, patch) {
  const tab = localTabs.value.find(t => t.id === id)
  if (tab) {
    let changed = false
    for (const key in patch) {
      if (key !== 'id' && tab[key] !== patch[key]) {
        console.log(`[TabsBar][updateTab][${now()}] æ›´æ–°æ ‡ç­¾${id}å­—æ®µ${key}: ${tab[key]} â†’ ${patch[key]}`)
        tab[key] = patch[key]
        changed = true
      }
    }
    if ('active' in patch && patch.active === true) {
      localTabs.value.forEach(t => {
        if (t.id !== id && t.active) t.active = false
      })
    }
    if (changed) {
      tabsStore.updateTab(id, patch)
    }
  }
}

function calculateOptimalWidth() {
  const maxWidth = 240
  const minWidth = 40
  if (!tabsAreaRef.value) return maxWidth
  const containerWidth = tabsAreaRef.value.offsetWidth
  const addBtnWidth = 34
  const availableWidth = containerWidth - addBtnWidth
  const tabCount = localTabs.value.filter(t => !closingTabs.value.has(t.id)).length
  if (tabCount === 0) return maxWidth
  const width = Math.max(minWidth, Math.min(maxWidth, availableWidth / tabCount))
  console.log(`[TabsBar][calculateOptimalWidth][${now()}] è®¡ç®—å®½åº¦: ${width}, æ ‡ç­¾æ•°: ${tabCount}, å®¹å™¨å®½: ${containerWidth}`)
  return width
}

function updateAllTabWidths() {
  console.log('[TabsBar][updateAllTabWidths] è°ƒæ•´æ‰€æœ‰æ ‡ç­¾å®½åº¦', {
    localTabs: localTabs.value.map(t => ({ id: t.id, width: t.width, closing: closingTabs.value.has(t.id) })),
    tabWidths: { ...tabWidths.value },
    isHoveringTabArea: isHoveringTabArea.value,
    pendingWidthUpdate: pendingWidthUpdate.value
  })
  const newWidth = calculateOptimalWidth()
  localTabs.value.forEach(tab => {
    if (!closingTabs.value.has(tab.id)) {
      if (tabWidths.value[tab.id] !== newWidth) {
        console.log(`[TabsBar][updateAllTabWidths] æ ‡ç­¾${tab.id}å®½åº¦: ${tabWidths.value[tab.id]} â†’ ${newWidth}`)
      }
      tabWidths.value[tab.id] = newWidth
      tab.width = newWidth
    }
  })
}

function onTabAreaMouseEnter() {
  isHoveringTabArea.value = true
  console.log(`[TabsBar][onTabAreaMouseEnter][${now()}] é¼ æ ‡è¿›å…¥æ ‡ç­¾åŒºåŸŸ`)
}
function onTabAreaMouseLeave() {
  isHoveringTabArea.value = false
  console.log('[TabsBar][onTabAreaMouseLeave] é¼ æ ‡ç¦»å¼€æ ‡ç­¾åŒºåŸŸ', {
    localTabs: localTabs.value.map(t => ({ id: t.id, width: t.width })),
    tabWidths: { ...tabWidths.value },
    isHoveringTabArea: isHoveringTabArea.value,
    pendingWidthUpdate: pendingWidthUpdate.value
  })
  if (pendingWidthUpdate.value) {
    setTimeout(() => {
      if (!isHoveringTabArea.value) {
        console.log('[TabsBar][onTabAreaMouseLeave] æ‰§è¡Œå»¶è¿Ÿçš„å®½åº¦æ›´æ–°', {
          localTabs: localTabs.value.map(t => ({ id: t.id, width: t.width })),
          tabWidths: { ...tabWidths.value },
          isHoveringTabArea: isHoveringTabArea.value,
          pendingWidthUpdate: pendingWidthUpdate.value
        })
        updateAllTabWidths()
        pendingWidthUpdate.value = false
      }
    }, 200)
  }
}

function handleResize() {
  if (pendingWidthUpdate.value) return
  updateAllTabWidths()
}

function now() {
  // [GPT-4, 2024-06-28 19:00:00 Asia/Hong_Kong] è·å–å½“å‰æ—¶é—´å­—ç¬¦ä¸²
  const date = new Date()
  return date.toLocaleString('zh-HK', { hour12: false })
}

// åˆå§‹åŒ–SortableJSæ‹–æ‹½åŠŸèƒ½
function initSortable() {
  if (!sortableContainer.value) return
  
  sortableInstance = new Sortable(sortableContainer.value, {
    // åŸºç¡€é…ç½®
    group: 'tabs',
    animation: 300, // å¢åŠ åŠ¨ç”»æ—¶é•¿ï¼Œè®©æ»‘åŠ¨æ›´æ˜æ˜¾
    easing: 'cubic-bezier(0.23, 1, 0.32, 1)', // æ›´å¹³æ»‘çš„ç¼“åŠ¨å‡½æ•°
    
    // æ‹–æ‹½å¥æŸ„ - æ•´ä¸ªæ ‡ç­¾å†…å®¹åŒºåŸŸéƒ½å¯æ‹–æ‹½ï¼Œä½†æ’é™¤å…³é—­æŒ‰é’®
    handle: '.tab-content',
    filter: '.tab-close-btn',
    preventOnFilter: false,
    
    // æ‹–æ‹½é˜ˆå€¼å’Œå»¶è¿Ÿ
    delay: 100,
    delayOnTouchStart: true,
    touchStartThreshold: 10,
    
    // æ ·å¼ç±»å
    ghostClass: 'tab-ghost',        // æ‹–æ‹½å ä½ç¬¦æ ·å¼
    chosenClass: 'tab-chosen',      // è¢«é€‰ä¸­æ—¶çš„æ ·å¼
    dragClass: 'tab-dragging',      // æ‹–æ‹½ä¸­çš„æ ·å¼
    
    // å¼ºåˆ¶å›é€€æœºåˆ¶ï¼Œç¡®ä¿åœ¨æ‰€æœ‰æµè§ˆå™¨ä¸­ä¸€è‡´
    forceFallback: true,
    fallbackClass: 'tab-fallback',
    fallbackOnBody: true,
    
    // æ°´å¹³æ‹–æ‹½é™åˆ¶ - é˜²æ­¢ä¸Šä¸‹æŠ–åŠ¨
    swapThreshold: 0.65, // æ ‡ç­¾äº¤æ¢é˜ˆå€¼
    invertSwap: false, // ç¦ç”¨åå‘äº¤æ¢
    direction: 'horizontal', // æ˜ç¡®æŒ‡å®šä¸ºæ°´å¹³æ–¹å‘
    
    // äº‹ä»¶å¤„ç†
    onStart: onDragStart,
    onMove: onDragMove,
    onEnd: onDragEnd,
    onClone: onDragClone
  })
  
  console.log('[TabsBar][initSortable] SortableJSå·²åˆå§‹åŒ–')
}

// æ‹–æ‹½å¼€å§‹äº‹ä»¶
function onDragStart(evt) {
  const tabId = evt.item.dataset.tabId
  if (!tabId) return
  
  isDragging.value = true
  draggedTabId.value = tabId
  
  console.log(`[TabsBar][onDragStart] å¼€å§‹æ‹–æ‹½æ ‡ç­¾: ${tabId}`)
  console.log(`[TabsBar][onDragStart] åŸå§‹ä½ç½®: ${evt.oldIndex}`)
  console.log(`[TabsBar][onDragStart] ğŸ¬ å¼€å§‹å·¦å³æ»‘åŠ¨åŠ¨ç”»`)
  
  // ç»™è¢«æ‹–æ‹½çš„æ ‡ç­¾æ·»åŠ ç‰¹æ®Šæ ·å¼
  evt.item.classList.add('tab-being-dragged')
  
  // ç»™å®¹å™¨æ·»åŠ æ‹–æ‹½çŠ¶æ€ç±»
  if (sortableContainer.value) {
    sortableContainer.value.classList.add('sortable-drag')
  }
  
  // æš‚åœé¼ æ ‡æ‚¬åœæ£€æµ‹ï¼Œé¿å…å¹²æ‰°æ‹–æ‹½
  isHoveringTabArea.value = false
}

// æ‹–æ‹½ç§»åŠ¨äº‹ä»¶ï¼ˆç”¨äºè‡ªå®šä¹‰äº¤æ¢é€»è¾‘ï¼‰
function onDragMove(evt) {
  // å¼ºåˆ¶æ°´å¹³æ‹–æ‹½ï¼Œé˜²æ­¢å‚ç›´æŠ–åŠ¨
  if (evt.related && evt.related.parentNode) {
    const container = evt.related.parentNode
    const containerRect = container.getBoundingClientRect()
    const itemRect = evt.related.getBoundingClientRect()
    
    // ç¡®ä¿æ‰€æœ‰æ ‡ç­¾éƒ½åœ¨åŒä¸€æ°´å¹³çº¿ä¸Š
    if (Math.abs(itemRect.top - containerRect.top) > 5) {
      console.log('[TabsBar][onDragMove] æ£€æµ‹åˆ°å‚ç›´åç§»ï¼Œå¼ºåˆ¶æ°´å¹³å¯¹é½')
      return false // é˜»æ­¢ç§»åŠ¨
    }
  }
  
  return true // å…è®¸æ°´å¹³ç§»åŠ¨
}

// æ‹–æ‹½ç»“æŸäº‹ä»¶
function onDragEnd(evt) {
  const tabId = evt.item.dataset.tabId
  if (!tabId) return
  
  console.log(`[TabsBar][onDragEnd] æ‹–æ‹½ç»“æŸ: ${tabId}`)
  console.log(`[TabsBar][onDragEnd] åŸå§‹ä½ç½®: ${evt.oldIndex}, æ–°ä½ç½®: ${evt.newIndex}`)
  
  if (evt.oldIndex !== evt.newIndex) {
    console.log(`[TabsBar][onDragEnd] ğŸ¬ æ ‡ç­¾æ»‘åŠ¨å®Œæˆï¼Œä½ç½®ä» ${evt.oldIndex + 1} â†’ ${evt.newIndex + 1}`)
  }
  
  // ç§»é™¤æ‹–æ‹½æ ·å¼
  evt.item.classList.remove('tab-being-dragged')
  
  // ç§»é™¤å®¹å™¨çš„æ‹–æ‹½çŠ¶æ€ç±»
  if (sortableContainer.value) {
    sortableContainer.value.classList.remove('sortable-drag')
  }
  
  // å¦‚æœä½ç½®å‘ç”Ÿäº†å˜åŒ–ï¼Œæ›´æ–°æ•°æ®
  if (evt.oldIndex !== evt.newIndex) {
    reorderTabs(evt.oldIndex, evt.newIndex)
  }
  
  // é‡ç½®æ‹–æ‹½çŠ¶æ€
  isDragging.value = false
  draggedTabId.value = null
  
  // é‡æ–°è®¡ç®—å®½åº¦
  nextTick(() => {
    updateAllTabWidths()
  })
  
  console.log(`[TabsBar][onDragEnd] æ ‡ç­¾é‡æ’å®Œæˆ`)
}

// æ‹–æ‹½å…‹éš†äº‹ä»¶ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
function onDragClone(evt) {
  console.log(`[TabsBar][onDragClone] å…‹éš†æ ‡ç­¾:`, evt.item.dataset.tabId)
}

// é‡æ’åºæ ‡ç­¾
function reorderTabs(oldIndex, newIndex) {
  if (oldIndex === newIndex) return
  
  console.log(`[TabsBar][reorderTabs] é‡æ’åº: ${oldIndex} â†’ ${newIndex}`)
  
  // æ›´æ–°æœ¬åœ°æ ‡ç­¾æ•°ç»„
  const movedTab = localTabs.value.splice(oldIndex, 1)[0]
  localTabs.value.splice(newIndex, 0, movedTab)
  
  // æ›´æ–°Pinia storeä¸­çš„é¡ºåº
  const newOrder = localTabs.value.map(tab => tab.id)
  tabsStore.reorderTabs(newOrder)
  
  console.log(`[TabsBar][reorderTabs] æ–°é¡ºåº:`, newOrder)
}

// è·å–æ ‡ç­¾æ ·å¼
function getTabStyle(tab) {
  return {
    width: `${tabWidths.value[tab.id] || 240}px`
  }
}

function minimize() { window.api?.sendWindowControl('minimize') }
function maximize() { window.api?.sendWindowControl('maximize') }
function close() { window.api?.sendWindowControl('close') }
</script>

<style scoped>
.tabs-bar {
  display: flex;
  align-items: center;
  height: 40px;
  padding: 0 140px 0 8px;
  background-color: #e8e8e8;
  position: relative;
  box-sizing: border-box;
}

.tabs-bar-left {
  display: flex;
  align-items: flex-end;
  flex: 1;
  min-width: 0;
  height: 100%;
}

.tabs-area {
  display: flex;
  align-items: flex-end;
  margin-top: 8px;
  flex: 1;
  min-width: 0;
  overflow: hidden;
}

.tabs-container {
  display: flex;
  align-items: flex-end;
  overflow-x: auto;
  flex-shrink: 1; /* å…è®¸æ”¶ç¼©ä½†ä¸ä¸»åŠ¨æ‰©å±• */
  /* ç¡®ä¿æ‹–æ‹½æ—¶æ ‡ç­¾ä¸ä¼šå‚ç›´ç§»åŠ¨ */
  min-height: 32px;
  max-height: 32px;
  position: relative;
}

.tabs-container::-webkit-scrollbar {
  display: none;
}

.tab-item {
  height: 32px;
  min-width: 40px;
  max-width: 240px;
  background: #e8e8e8;
  border-bottom: none;
  cursor: default;
  position: relative;
  /* åŸºç¡€è¿‡æ¸¡ï¼šåªå¤„ç†å®½åº¦å’Œé€æ˜åº¦ï¼Œtransformç”±æ‹–æ‹½ä¸“ç”¨æ ·å¼å¤„ç† */
  transition: width 0.25s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.25s;
  box-sizing: border-box;
  container-type: inline-size; /* è®©æ¯ä¸ªæ ‡ç­¾æˆä¸ºå®¹å™¨ */
  /* ç¡®ä¿å‚ç›´å¯¹é½ç¨³å®š */
  vertical-align: top;
  flex-shrink: 0;
}

.tab-item:last-child {
  margin-right: 0;
}

/* æ ‡ç­¾å…³é—­åŠ¨ç”» - Edgeé£æ ¼ä»å³åˆ°å·¦æ”¶ç¼© */
.tab-item.closing {
  width: 0 !important;
  min-width: 0 !important;
  opacity: 0;
  transform: scaleX(0);
  transform-origin: center;
  overflow: hidden;
  margin: 0 !important;
  padding: 0 !important;
  border: none !important;
  transition: width 0.25s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.25s, transform 0.25s;
}

/* æ ‡ç­¾è¿›å…¥åŠ¨ç”» - Edgeé£æ ¼ä»å·¦åˆ°å³å±•å¼€ */
.tab-item.entering {
  animation: tab-enter-edge 0.25s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  overflow: hidden;
}

@keyframes tab-enter-edge {
  0% {
    width: 0;
    min-width: 0;
    opacity: 0;
    transform: scaleX(0);
    transform-origin: left center;
  }
  100% {
    opacity: 1;
    transform: scaleX(1);
    transform-origin: left center;
  }
}

/* æœªæ¿€æ´»æ ‡ç­¾å³ä¾§åˆ†å‰²çº¿ */
.tab-item:not(.active)::after {
  content: '';
  position: absolute;
  right: 0;
  top: 25%;
  height: 50%;
  width: 1px;
  background: #2d2d2d;
  opacity: 0.6;
}

/* å¦‚æœå³ä¾§ç›¸é‚»çš„æ˜¯æ¿€æ´»/å…³é—­ä¸­çš„æ ‡ç­¾ï¼Œåˆ™ä¸æ˜¾ç¤ºåˆ†å‰²çº¿ */
.tab-item:not(.active):has(+ .tab-item.active)::after,
.tab-item:not(.active):has(+ .tab-item.closing)::after,
.tab-item:not(.active):last-child::after {
  display: none;
}

/* é¼ æ ‡æ‚¬åœæ—¶éšè—åˆ†å‰²çº¿ */
.tab-item:not(.active):hover::after,
.tab-item:not(.active):has(+ .tab-item:hover)::after {
  display: none;
}

.tab-item:hover {
  background: #dadada;
}

.tab-item.active {
  background: #ffffff;
  border-color: #c0c0c0;
  z-index: 1;
}

.tab-item.hide-close-btn:not(.active) .tab-close-btn {
  display: none;
}

.tab-content {
  display: flex;
  align-items: center;
  height: 100%;
  padding: 0 12px;
  gap: 10px;
  background: inherit;
}

.tab-icon {
  font-size: 18px;
  color: #666;
  flex-shrink: 0;
}

.tab-title {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-size: 12px;
  font-weight: 400;
  color: #000000;
  line-height: 1;
}

.tab-close-btn {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  width: 18px;
  height: 18px;
  padding: 0;
  border: none;
  color: #000000;
  background: inherit;
  border-radius: 25%;
  cursor: default;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  z-index: 2;
}

.tab-item.active .tab-close-btn {
  opacity: 1;
}

.tab-close-btn:hover {
  background: #bababa !important;
  color: black !important;
  opacity: 1;
}

@container (max-width: 18px) {
  .tab-close-btn {
    display: none;
  }
}

.add-tab-btn {
  height: 32px !important;
  width: 32px !important;
  min-width: 32px !important;
  min-height: 32px !important;
  color: black !important;
  background: #e8e8e8;
  padding: 0 !important;
  border : none !important;
  cursor: default;
  position: relative;
  transition: all 0.2s;
  box-sizing: border-box;
}

.add-tab-btn:hover {
  background: #dadada;
}

.add-tab-btn.active {
  background: #ffffff;
  border-color: #c0c0c0;
  z-index: 1;
}

.window-controls {
  position: absolute;
  top: 0;
  right: 0;
  display: flex;
  height: 40px;
  -webkit-app-region: no-drag;
  user-select: none;
}

.window-btn {
  width: 46px;
  height: 100%;
  border: none;
  border-radius: 0;
  background: transparent;
  color: #444;
  outline: none;
  cursor: default;
  transition: background 0.2s, color 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.window-btn:hover {
  background: #e0e0e0;
}

.window-btn.close:hover {
  background: #e57373;
  color: #fff;
}

.drag-region {
  -webkit-app-region: drag;
}

.no-drag {
  -webkit-app-region: no-drag;
}

/* ===== SortableJS æ‹–æ‹½æ ·å¼ - Edgeæµè§ˆå™¨é£æ ¼ ===== */

/* æ‹–æ‹½å ä½ç¬¦æ ·å¼ - æ˜¾ç¤ºæ ‡ç­¾å°†è¦æ’å…¥çš„ä½ç½®ï¼Œå¢å¼ºè§†è§‰æ•ˆæœ */
.tab-ghost {
  opacity: 0.6 !important;
  background: linear-gradient(45deg, #e0e0e0 25%, #f0f0f0 25%, #f0f0f0 50%, #e0e0e0 50%, #e0e0e0 75%, #f0f0f0 75%) !important;
  background-size: 8px 8px !important;
  border: 2px dashed #2196F3 !important;
  border-radius: 4px !important;
  transform: none !important;
  animation: ghost-pulse 1s ease-in-out infinite alternate !important;
  /* ç¡®ä¿å ä½ç¬¦ä¸ä¼šæœ‰å‚ç›´åç§» */
  height: 32px !important;
  position: relative !important;
  top: 0 !important;
  bottom: auto !important;
}

@keyframes ghost-pulse {
  from { border-color: #2196F3; }
  to { border-color: #64B5F6; }
}

.tab-ghost .tab-content {
  opacity: 0.7;
}

/* è¢«é€‰ä¸­å‡†å¤‡æ‹–æ‹½çš„æ ‡ç­¾æ ·å¼ */
.tab-chosen {
  cursor: grabbing !important;
}

/* æ­£åœ¨è¢«æ‹–æ‹½çš„æ ‡ç­¾æ ·å¼ - å¢å¼ºè§†è§‰æ•ˆæœï¼Œç¡®ä¿æ°´å¹³æ‹–æ‹½ */
.tab-dragging {
  opacity: 0.9 !important;
  transform: rotate(0deg) scale(1.05) translateY(0px) !important; /* è½»å¾®æ”¾å¤§æ•ˆæœï¼Œå¼ºåˆ¶Yè½´ä¸º0 */
  box-shadow: 0 8px 25px rgba(33, 150, 243, 0.3), 0 4px 12px rgba(0, 0, 0, 0.15) !important;
  z-index: 1000 !important;
  border: 2px solid #2196F3 !important;
  border-radius: 4px !important;
  background: rgba(255, 255, 255, 0.95) !important;
  /* ç¡®ä¿æ‹–æ‹½æ—¶é«˜åº¦ä¿æŒå›ºå®š */
  height: 32px !important;
  position: relative !important;
  top: 0 !important;
}

/* SortableJSå›é€€æ‹–æ‹½æ ·å¼ - å¢å¼ºç‰ˆï¼Œç¡®ä¿æ°´å¹³æ‹–æ‹½ */
.tab-fallback {
  opacity: 0.9 !important;
  box-shadow: 0 10px 30px rgba(33, 150, 243, 0.4), 0 6px 16px rgba(0, 0, 0, 0.2) !important;
  transform: rotate(0deg) scale(1.05) translateY(0px) !important;
  z-index: 1000 !important;
  cursor: grabbing !important;
  border: 2px solid #2196F3 !important;
  border-radius: 4px !important;
  background: rgba(255, 255, 255, 0.95) !important;
  /* ç¡®ä¿å›é€€æ ·å¼ä¹Ÿä¿æŒå›ºå®šé«˜åº¦ */
  height: 32px !important;
  position: relative !important;
  top: 0 !important;
}

/* è‡ªå®šä¹‰è¢«æ‹–æ‹½æ ‡ç­¾æ ·å¼ - Edgeé£æ ¼å¢å¼ºç‰ˆï¼Œæ°´å¹³æ‹–æ‹½ */
.tab-being-dragged {
  box-shadow: 0 8px 25px rgba(33, 150, 243, 0.3), 0 4px 12px rgba(0, 0, 0, 0.15) !important;
  z-index: 999 !important;
  cursor: grabbing !important;
  transition: box-shadow 0.2s ease !important; /* ç§»é™¤transform transitionï¼Œé¿å…å†²çª */
  transform: scale(1.03) translateY(0px) !important;
  border: 1px solid #2196F3 !important;
  border-radius: 3px !important;
  background: rgba(255, 255, 255, 0.98) !important;
  /* ç¡®ä¿è¢«æ‹–æ‹½æ ‡ç­¾ä¿æŒå›ºå®šé«˜åº¦å’Œä½ç½® */
  height: 32px !important;
  position: relative !important;
  top: 0 !important;
}

/* ç§»é™¤é‡å¤çš„å®¹å™¨æ ·å¼å®šä¹‰ï¼Œå·²åœ¨ä¸Šé¢å¢å¼ºç‰ˆä¸­å®šä¹‰ */

/* ç¡®ä¿æ‹–æ‹½æ—¶æ ‡ç­¾å†…å®¹ä¸è¢«é€‰ä¸­ */
.tabs-container * {
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}

/* æ‹–æ‹½æ—¶ç¦ç”¨æ ‡ç­¾çš„hoveræ•ˆæœ */
.tabs-container.sortable-drag .tab-item:hover {
  background: inherit !important;
}

/* æ‹–æ‹½æ—¶æ ‡ç­¾çš„å¹³æ»‘å·¦å³æ»‘åŠ¨æ•ˆæœ - åªé’ˆå¯¹éæ‹–æ‹½çŠ¶æ€çš„æ ‡ç­¾ */
.tab-item:not(.sortable-chosen):not(.sortable-ghost):not(.tab-being-dragged) {
  transition: transform 0.3s cubic-bezier(0.23, 1, 0.32, 1), 
              width 0.25s cubic-bezier(0.4, 0, 0.2, 1), 
              opacity 0.25s,
              background-color 0.2s ease;
}

/* æ‹–æ‹½æ—¶ç›¸é‚»æ ‡ç­¾çš„è§†è§‰åé¦ˆ */
.tabs-container.sortable-drag .tab-item:not(.sortable-chosen):not(.sortable-ghost):hover {
  background-color: rgba(33, 150, 243, 0.1) !important;
  transition: background-color 0.1s ease !important;
}

/* æ‹–æ‹½æ—¶å®¹å™¨çš„çŠ¶æ€æŒ‡ç¤º */
.tabs-container.sortable-drag {
  cursor: grabbing;
  position: relative;
}

.tabs-container.sortable-drag::before {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  background: rgba(33, 150, 243, 0.05);
  border: 1px solid rgba(33, 150, 243, 0.2);
  border-radius: 6px;
  pointer-events: none;
  z-index: -1;
}

/* æ‹–æ‹½çŠ¶æ€ä¸‹ç¦ç”¨æ ‡ç­¾è‡ªèº«çš„è¿‡æ¸¡æ•ˆæœï¼Œé¿å…å†²çª */
.tab-item.sortable-chosen,
.tab-item.sortable-ghost,
.tab-item.tab-being-dragged,
.tab-item.entering {
  transition: none !important;
}

/* ç¡®ä¿å…³é—­æŒ‰é’®åœ¨æ‹–æ‹½æ—¶ä¸å¯ç‚¹å‡» */
.tab-being-dragged .tab-close-btn {
  pointer-events: none !important;
}

/* æ‹–æ‹½æ—¶çš„æ ‡ç­¾å†…å®¹æ ·å¼ */
.tab-being-dragged .tab-content {
  pointer-events: none !important;
}

/* Edgeé£æ ¼ï¼šæ‹–æ‹½æ—¶æ ‡ç­¾æ çš„æ•´ä½“æ•ˆæœ */
.tabs-container {
  position: relative;
}

/* ç¡®ä¿æ‹–æ‹½å ä½ç¬¦ä¸å…¶ä»–æ ‡ç­¾ä¸€è‡´ */
.tab-ghost .tab-icon,
.tab-ghost .tab-title,
.tab-ghost .tab-close-btn {
  opacity: 0.5;
}

/* æ‹–æ‹½æ—¶ç¦ç”¨æ ‡ç­¾ç‚¹å‡»äº‹ä»¶ï¼Œé¿å…æ„å¤–æ¿€æ´» */
.tab-item.sortable-chosen,
.tab-item.tab-being-dragged {
  pointer-events: none !important;
}

.tab-item.sortable-chosen .tab-content,
.tab-item.tab-being-dragged .tab-content {
  pointer-events: none !important;
}

/*
åŸæœ‰çš„æ‹–æ‹½è®¾è®¡æƒ³æ³•ï¼ˆå·²ç”±SortableJSå®ç°ï¼‰ï¼š
- æ£€æµ‹æ‹–æ‹½è¡Œä¸ºåæå–æ ‡ç­¾DOMï¼Œåˆ›å»ºè™šæ‹Ÿæ ‡ç­¾æ›¿æ¢
- è¢«æ‹–æ‹½æ ‡ç­¾è„±ç¦»DOMè·Ÿéšé¼ æ ‡ç§»åŠ¨
- è™šæ‹Ÿæ ‡ç­¾ä¸å…¶ä»–æ ‡ç­¾äº¤æ¢ä½ç½®
- æ‹–æ‹½ç»“æŸæ—¶åˆ é™¤è™šæ‹Ÿæ ‡ç­¾ï¼Œç”¨å®é™…æ ‡ç­¾æ›¿æ¢

Edgeæµè§ˆå™¨é£æ ¼å®ç°ï¼š
- æ ‡ç­¾åªåšå·¦å³ç§»åŠ¨ï¼Œæ— æ—‹è½¬æè¾¹ç‰¹æ•ˆ
- äº¤æ¢ä½ç½®çš„æ ‡ç­¾ç®€å•æ»‘åŠ¨
- ç§»åŠ¨åŠä¸ªæ ‡ç­¾è·ç¦»å³å¯äº¤æ¢ä½ç½®
- ä½¿ç”¨SortableJSçš„å¹½çµæ ‡ç­¾æ–¹æ¡ˆ
*/
</style>