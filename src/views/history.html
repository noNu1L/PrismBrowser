<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å†å²è®°å½•</title>
    <link rel="stylesheet" href="../styles/theme.css">
    <link rel="stylesheet" href="../vendor/vue/element-plus.css">
    <link rel="stylesheet" href="../styles/page-theme.css">
    <script src="../vendor/vue/vue.global.js"></script>
    <script src="../vendor/vue/element-plus.full.js"></script>
    <script src="../vendor/vue/element-plus-icons.js"></script>
</head>
<body>
    <div id="app">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1 class="sidebar-title">å†å²è®°å½•</h1>
                <p class="sidebar-subtitle">æµè§ˆå†å²å’Œæœ€è¿‘å…³é—­çš„æ ‡ç­¾é¡µ</p>
            </div>
            
            <div class="search-container">
                <el-input
                    v-model="searchQuery"
                    placeholder="æœç´¢å†å²è®°å½•..."
                    :prefix-icon="Search"
                    clearable
                    @input="handleSearch"
                />
            </div>

            <el-menu 
                :default-active="activeView"
                @select="handleViewChange"
                mode="vertical"
            >
                <el-menu-item index="all">
                    <el-icon><Grid /></el-icon>
                    <span>å…¨éƒ¨</span>
                </el-menu-item>
                <el-menu-item index="recent">
                    <el-icon><Clock /></el-icon>
                    <span>æœ€è¿‘å…³é—­</span>
                </el-menu-item>
            </el-menu>
        </div>

        <!-- ä¸»å†…å®¹ -->
        <div class="main-content">
            <div class="content-header">
                <h1 class="page-title">{{ currentViewTitle }}</h1>
                <div class="header-actions">
                    <el-button 
                        v-if="selectedItems.length > 0"
                        type="danger"
                        :icon="Delete"
                        @click="deleteSelected"
                    >
                        åˆ é™¤é€‰ä¸­ ({{ selectedItems.length }})
                    </el-button>
                    <el-popconfirm
                        title="ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ"
                        @confirm="clearAllHistory"
                    >
                        <template #reference>
                            <el-button 
                                type="danger" 
                                :icon="DeleteFilled"
                                plain
                            >
                                æ¸…é™¤æµè§ˆæ•°æ®
                            </el-button>
                        </template>
                    </el-popconfirm>
                </div>
            </div>

            <div class="content-container">
                <!-- ç©ºçŠ¶æ€ -->
                <div v-if="!loading && filteredGroups.length === 0" class="empty-state">
                    <div class="empty-icon">ğŸ“±</div>
                    <p class="empty-text">{{ emptyStateText }}</p>
                </div>

                <!-- åŠ è½½çŠ¶æ€ -->
                <div v-if="loading" style="text-align: center; padding: 80px;">
                    <el-icon class="is-loading" size="32">
                        <Loading />
                    </el-icon>
                    <p style="margin-top: 16px; color: #909399;">åŠ è½½ä¸­...</p>
                </div>

                <!-- å†å²è®°å½•åˆ—è¡¨ -->
                <div v-for="group in filteredGroups" :key="group.date" class="date-group">
                    <div class="date-header">
                        <h3 class="date-title">{{ group.dateLabel }}</h3>
                        <el-checkbox
                            :model-value="isGroupSelected(group)"
                            :indeterminate="isGroupIndeterminate(group)"
                            @change="toggleGroupSelection(group, $event)"
                        >
                            å…¨é€‰
                        </el-checkbox>
                    </div>
                    <div class="history-list">
                        <div 
                            v-for="item in group.items" 
                            :key="item.url"
                            class="history-item"
                            :class="{ selected: selectedItems.includes(item.url) }"
                            @click="openHistoryItem(item)"
                        >
                            <div class="history-item-left">
                                <el-checkbox
                                    :model-value="selectedItems.includes(item.url)"
                                    @change="toggleItemSelection(item.url, $event)"
                                    @click.stop
                                />
                                <div class="history-favicon-container">
                                    <img 
                                        v-if="item.favicon && !item.faviconError"
                                        :src="item.favicon"
                                        class="history-favicon"
                                        @error="handleFaviconError(item)"
                                    />
                                    <div 
                                        v-if="!item.favicon || item.faviconError" 
                                        class="history-favicon-default"
                                        v-html="getDefaultGlobeIcon()"
                                    ></div>
                                </div>
                            </div>
                            
                            <div class="history-content">
                                <div class="history-info">
                                    <span class="history-title">{{ item.title || item.url }}</span>
                                    <span class="history-url">{{ getHostname(item.url) }}</span>
                                </div>
                            </div>
                            
                            <div class="history-item-right">
                                <span class="history-time">{{ formatTime(item.timestamp) }}</span>
                                <el-button
                                    type="danger"
                                    :icon="Delete"
                                    size="small"
                                    text
                                    @click.stop="deleteItem(item.url)"
                                />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;
        const { Search, Grid, Clock, Delete, DeleteFilled, Loading } = ElementPlusIconsVue;

        createApp({
            data() {
                return {
                    activeView: 'all',
                    searchQuery: '',
                    loading: true,
                    historyData: [],
                    recentlyClosedData: [],
                    selectedItems: []
                };
            },
            computed: {
                currentViewTitle() {
                    return this.activeView === 'all' ? 'å…¨éƒ¨' : 'æœ€è¿‘å…³é—­';
                },
                emptyStateText() {
                    if (this.searchQuery) {
                        return 'æœªæ‰¾åˆ°åŒ¹é…çš„å†å²è®°å½•';
                    }
                    return this.activeView === 'all' ? 'æš‚æ— æµè§ˆå†å²' : 'æš‚æ— æœ€è¿‘å…³é—­çš„æ ‡ç­¾é¡µ';
                },
                currentData() {
                    return this.activeView === 'all' ? this.historyData : this.recentlyClosedData;
                },
                filteredData() {
                    if (!this.searchQuery) {
                        return this.currentData;
                    }
                    const query = this.searchQuery.toLowerCase();
                    return this.currentData.filter(item =>
                        (item.title && item.title.toLowerCase().includes(query)) ||
                        (item.url && item.url.toLowerCase().includes(query))
                    );
                },
                filteredGroups() {
                    // æŒ‰æ—¥æœŸåˆ†ç»„
                    const groups = {};
                    this.filteredData.forEach(item => {
                        const date = item.timestamp.split('T')[0];
                        if (!groups[date]) {
                            groups[date] = [];
                        }
                        groups[date].push(item);
                    });

                    // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
                    return Object.keys(groups)
                        .sort((a, b) => new Date(b) - new Date(a))
                        .map(date => ({
                            date,
                            dateLabel: this.formatDateGroup(date),
                            items: groups[date].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                        }));
                }
            },
            async mounted() {
                await this.loadData();
                
                // ç›‘å¬å†å²è®°å½•æ›´æ–°
                if (window.api?.onHistoryUpdated) {
                    window.api.onHistoryUpdated(() => {
                        this.loadData();
                    });
                }
            },
            methods: {
                // å¤„ç†faviconåŠ è½½é”™è¯¯
                handleFaviconError(item) {
                    this.$set(item, 'faviconError', true);
                },
                
                // è·å–é»˜è®¤åœ°çƒå›¾æ ‡
                getDefaultGlobeIcon() {
                    return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width: 20px; height: 20px; color: #909399;"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>`;
                },
                
                async loadData() {
                    this.loading = true;
                    try {
                        if (!window.api) {
                            ElMessage.error('APIæœªåˆå§‹åŒ–');
                            return;
                        }
                        
                        this.historyData = await window.api.getHistory() || [];
                        this.recentlyClosedData = await window.api.getRecentlyClosed() || [];
                        this.selectedItems = [];
                        
                    } catch (error) {
                        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                        ElMessage.error('åŠ è½½æ•°æ®å¤±è´¥');
                    } finally {
                        this.loading = false;
                    }
                },
                
                handleViewChange(view) {
                    this.activeView = view;
                    this.selectedItems = [];
                    this.searchQuery = '';
                },
                
                handleSearch() {
                    this.selectedItems = [];
                },
                
                openHistoryItem(item) {
                    window.api.openInNewTab(item.url);
                },
                
                getHostname(url) {
                    try {
                        return new URL(url).hostname;
                    } catch {
                        return url;
                    }
                },
                
                formatTime(timestamp) {
                    return new Date(timestamp).toLocaleTimeString('zh-CN', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                },
                
                formatDateGroup(dateStr) {
                    const date = new Date(dateStr);
                    const today = new Date();
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);

                    if (date.toDateString() === today.toDateString()) return 'ä»Šå¤©';
                    if (date.toDateString() === yesterday.toDateString()) return 'æ˜¨å¤©';
                    
                    return date.toLocaleDateString('zh-CN', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                },
                
                toggleItemSelection(url, checked) {
                    if (checked) {
                        if (!this.selectedItems.includes(url)) {
                            this.selectedItems.push(url);
                        }
                    } else {
                        const index = this.selectedItems.indexOf(url);
                        if (index > -1) {
                            this.selectedItems.splice(index, 1);
                        }
                    }
                },
                
                isGroupSelected(group) {
                    const groupUrls = group.items.map(item => item.url);
                    return groupUrls.length > 0 && groupUrls.every(url => this.selectedItems.includes(url));
                },
                
                isGroupIndeterminate(group) {
                    const groupUrls = group.items.map(item => item.url);
                    const selectedInGroup = groupUrls.filter(url => this.selectedItems.includes(url));
                    return selectedInGroup.length > 0 && selectedInGroup.length < groupUrls.length;
                },
                
                toggleGroupSelection(group, checked) {
                    const groupUrls = group.items.map(item => item.url);
                    if (checked) {
                        groupUrls.forEach(url => {
                            if (!this.selectedItems.includes(url)) {
                                this.selectedItems.push(url);
                            }
                        });
                    } else {
                        groupUrls.forEach(url => {
                            const index = this.selectedItems.indexOf(url);
                            if (index > -1) {
                                this.selectedItems.splice(index, 1);
                            }
                        });
                    }
                },
                
                async deleteItem(url) {
                    try {
                        await window.api.deleteHistoryItems([url]);
                        ElMessage.success('åˆ é™¤æˆåŠŸ');
                        await this.loadData();
                    } catch (error) {
                        console.error('åˆ é™¤å¤±è´¥:', error);
                        ElMessage.error('åˆ é™¤å¤±è´¥');
                    }
                },
                
                async deleteSelected() {
                    if (this.selectedItems.length === 0) return;
                    
                    try {
                        await ElMessageBox.confirm(
                            `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${this.selectedItems.length} é¡¹è®°å½•å—ï¼Ÿ`,
                            'ç¡®è®¤åˆ é™¤',
                            {
                                confirmButtonText: 'ç¡®å®š',
                                cancelButtonText: 'å–æ¶ˆ',
                                type: 'warning'
                            }
                        );
                        
                        await window.api.deleteHistoryItems(this.selectedItems);
                        ElMessage.success('åˆ é™¤æˆåŠŸ');
                        await this.loadData();
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('åˆ é™¤å¤±è´¥:', error);
                            ElMessage.error('åˆ é™¤å¤±è´¥');
                        }
                    }
                },
                
                async clearAllHistory() {
                    try {
                        if (this.activeView === 'all') {
                            await window.api.clearHistory();
                        }
                        ElMessage.success('æ¸…é™¤æˆåŠŸ');
                        await this.loadData();
                    } catch (error) {
                        console.error('æ¸…é™¤å¤±è´¥:', error);
                        ElMessage.error('æ¸…é™¤å¤±è´¥');
                    }
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html> 