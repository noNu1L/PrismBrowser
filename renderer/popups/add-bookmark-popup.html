<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>编辑收藏</title>
    <link rel="stylesheet" href="../styles/theme.css">
    <style>
        body, html {
            margin: 0; padding: 0; 
            overflow: hidden;
            font-family: var(--app-font-family);
            background-color: transparent; /* 透明背景 */
            color: var(--text-color-primary);
        }
        .container {
            width: 320px; /* 固定宽度，更紧凑 */
            padding: 12px 16px; /* 减小内边距 */
            background-color: var(--card-bg);
            border-radius: 6px;
            border: 1px solid var(--border-color-secondary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            box-sizing: border-box;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px; /* 减小底部间距 */
        }
        header h1 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }
        #close-btn {
             font-size: 20px;
             background: none;
             border: none;
             cursor: pointer;
             opacity: 0.6;
        }
        .form-group {
            margin-bottom: 12px; /* 减小表单组间距 */
            display: flex;
            align-items: center;
        }
        .form-group label {
            width: 45px; /* 减小标签宽度 */
            font-size: 13px; /* 稍微减小字体 */
            font-weight: 500;
            flex-shrink: 0;
        }
        .form-group input, .form-group select {
            flex-grow: 1;
            height: 32px; /* 减小输入框高度 */
            padding: 0 8px; /* 减小内边距 */
            border-radius: 4px;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            font-size: 13px;
        }
        footer {
            margin-top: 16px; /* 减小顶部间距 */
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        button {
            padding: 6px 12px; /* 减小按钮内边距 */
            font-size: 13px;
            font-weight: 500;
            border-radius: 4px;
            border: 1px solid var(--input-border);
            cursor: pointer;
        }
        //#done-btn {
        //    background-color: var(--button-primary-bg);
        //    border-color: var(--button-primary-bg);
        //    color: white;
        //}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>已添加到收藏夹</h1>
            <button id="close-btn">&times;</button>
        </header>

        <div class="form-group">
            <label for="name-input">名称</label>
            <input type="text" id="name-input">
        </div>
        <div class="form-group">
            <label for="folder-select">文件夹</label>
            <select id="folder-select">
                <!-- Folder options will be populated by script -->
            </select>
        </div>

        <footer>
            <button id="remove-btn" class="btn-back">删除</button>
            <button id="done-btn" class="btn-confirm">完成</button>
        </footer>
    </div>
    <script>
        const nameInput = document.getElementById('name-input');
        const folderSelect = document.getElementById('folder-select');
        const doneBtn = document.getElementById('done-btn');
        const removeBtn = document.getElementById('remove-btn');
        const closeBtn = document.getElementById('close-btn');

        let pageData = null;

        // 从书签树填充文件夹下拉列表
        function populateFolders(nodes, level = 0) {
            nodes.forEach(node => {
                if (node.type === 'folder') {
                    const option = document.createElement('option');
                    option.value = node.id;
                    // 添加缩进以实现视觉层次结构
                    option.textContent = '  '.repeat(level) + node.title;
                    folderSelect.appendChild(option);
                    if (node.children) {
                        populateFolders(node.children, level + 1);
                    }
                }
            });
        }
        
        // 查找现有书签的父文件夹ID
        function findParentFolderId(nodes, bookmarkId, parentId = 'root') {
             for (const node of nodes) {
                if (node.id === bookmarkId) return parentId;
                if (node.type === 'folder' && node.children) {
                    const foundId = findParentFolderId(node.children, bookmarkId, node.id);
                    if (foundId) return foundId;
                }
            }
            return null;
        }

        window.api.onPopupData((data) => {
            pageData = data;
            console.log('[书签弹窗] 接收到的数据:', data);
            
            nameInput.value = data.title;
            populateFolders(data.bookmarksTree);

            if (data.bookmark) { // 现有书签
                console.log('[书签弹窗] 编辑现有书签:', data.bookmark);
                const parentId = findParentFolderId(data.bookmarksTree, data.bookmark.id);
                folderSelect.value = parentId || 'root';
                removeBtn.style.display = 'block';
            } else { // 新书签
                console.log('[书签弹窗] 添加新书签，favicon:', data.favicon);
                folderSelect.value = 'toolbar'; // 默认为工具栏
                removeBtn.style.display = 'none';
            }
        });
        
        doneBtn.addEventListener('click', async () => {
            const name = nameInput.value;
            const parentId = folderSelect.value;

            if (pageData.bookmark) { // 更新现有
                console.log('[书签弹窗] 更新书签，包含favicon:', pageData.favicon);
                await window.api.updateBookmark({
                    id: pageData.bookmark.id,
                    title: name,
                    url: pageData.url, // URL不变，但明确指出
                    favicon: pageData.favicon // 添加favicon信息
                });
                // 注意：此步骤未实现移动文件夹
            } else { // 添加新的
                console.log('[书签弹窗] 添加新书签，favicon:', pageData.favicon);
                await window.api.addBookmark({
                    parentId,
                    title: name,
                    url: pageData.url,
                    favicon: pageData.favicon // 添加favicon信息
                });
            }
            window.api.closePopupAndRefresh();
        });

        removeBtn.addEventListener('click', async () => {
            if (pageData.bookmark) {
                await window.api.deleteBookmarks([pageData.bookmark.id]);
                window.api.closePopupAndRefresh();
            }
        });

        closeBtn.addEventListener('click', () => {
            // 直接关闭而不保存
             window.api.closePopupAndRefresh();
        });
    </script>
</body>
</html> 