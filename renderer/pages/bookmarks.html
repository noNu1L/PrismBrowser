<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Êî∂ËóèÂ§π</title>
    <link rel="stylesheet" href="../styles/theme.css">
    <link rel="stylesheet" href="../vendor/element-plus.css">
    <link rel="stylesheet" href="../styles/page-theme.css">
    <script src="../vendor/vue.global.js"></script>
    <script src="../vendor/element-plus.full.js"></script>
    <script src="../vendor/element-plus-icons.js"></script>
</head>
<body>
    <div id="app">
        <!-- ‰æßËæπÊ†è -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1 class="sidebar-title">Êî∂ËóèÂ§π</h1>
                <p class="sidebar-subtitle">ÁÆ°ÁêÜÊÇ®ÁöÑ‰π¶Á≠æÂíåÊñá‰ª∂Â§π</p>
            </div>
            
            <div class="search-container">
                <el-input
                    v-model="searchQuery"
                    placeholder="ÊêúÁ¥¢Êî∂ËóèÂ§π..."
                    prefix-icon="Search"
                    clearable
                    @input="handleSearch"
                />
            </div>

            <div class="folder-tree">
                <el-tree
                    :data="treeData"
                    :props="treeProps"
                    node-key="id"
                    :current-node-key="currentFolderId"
                    @node-click="handleFolderClick"
                >
                    <template #default="{ node, data }">
                        <span style="display: flex; align-items: center; width: 100%;">
                            <el-icon style="margin-right: 8px;">
                                <Folder />
                            </el-icon>
                            <span style="flex: 1;">{{ node.label }}</span>
                            <span style="color: #909399; font-size: 12px;">
                                {{ getItemCount(data) }}
                            </span>
                        </span>
                    </template>
                </el-tree>
            </div>
        </div>

        <!-- ‰∏ªÂÜÖÂÆπ -->
        <div class="main-content">
            <div class="content-header">
                <h1 class="page-title">{{ currentFolderName }}</h1>
                <div class="header-actions">
                    <el-button 
                        v-if="selectedItems.length > 0"
                        type="danger"
                        icon="Delete"
                        @click="deleteSelected"
                    >
                        Âà†Èô§ÈÄâ‰∏≠ ({{ selectedItems.length }})
                    </el-button>
                    <el-button 
                        type="primary" 
                        class="custom-button"
                        icon="Link"
                        @click="showAddBookmarkDialog"
                    >
                        Ê∑ªÂä†Êî∂Ëóè
                    </el-button>
                    <el-button 
                        type="primary" 
                        class="custom-button"
                        icon="Folder"
                        @click="showAddFolderDialog"
                    >
                        Ê∑ªÂä†Êñá‰ª∂Â§π
                    </el-button>
                </div>
            </div>

            <div class="content-container">
                <div class="breadcrumb-container">
                    <el-breadcrumb separator="/">
                        <el-breadcrumb-item 
                            v-for="item in breadcrumbItems" 
                            :key="item.id"
                            :to="{ path: item.id }"
                            @click="navigateToFolder(item.id)"
                        >
                            {{ item.title }}
                        </el-breadcrumb-item>
                    </el-breadcrumb>
                </div>

                <!-- Á©∫Áä∂ÊÄÅ -->
                <div v-if="!loading && filteredItems.length === 0" class="empty-state">
                    <div class="empty-icon">üìö</div>
                    <p class="empty-text">{{ emptyStateText }}</p>
                </div>

                <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
                <div v-if="loading" style="text-align: center; padding: 80px;">
                    <el-icon class="is-loading" size="32">
                        <Loading />
                    </el-icon>
                    <p style="margin-top: 16px; color: #909399;">Âä†ËΩΩ‰∏≠...</p>
                </div>

                <!-- Êî∂ËóèÂ§πÁΩëÊ†º -->
                <div v-if="!loading && filteredItems.length > 0" class="bookmark-grid">
                    <div 
                        v-for="item in filteredItems" 
                        :key="item.id"
                        class="bookmark-item"
                        :class="{ 'folder-item': item.type === 'folder' }"
                        @click="handleItemClick(item)"
                    >
                        <div class="bookmark-header">
                            <el-icon v-if="item.type === 'folder'" class="bookmark-favicon" size="24">
                                <Folder />
                            </el-icon>
                            <img 
                                v-else-if="item.favicon"
                                :src="item.favicon"
                                class="bookmark-favicon"
                                @error="$event.target.style.display='none'"
                            />
                            <el-icon v-else class="bookmark-favicon" size="24" color="#909399">
                                <Globe />
                            </el-icon>
                            <h4 class="bookmark-title">{{ item.title }}</h4>
                            <div class="bookmark-actions">
                                <el-checkbox
                                    :model-value="selectedItems.includes(item.id)"
                                    @change="toggleItemSelection(item.id, $event)"
                                    @click.stop
                                />
                                <el-button
                                    v-if="item.type === 'bookmark'"
                                    icon="Edit"
                                    size="small"
                                    text
                                    @click.stop="editBookmark(item)"
                                />
                                <el-button
                                    icon="Delete"
                                    size="small"
                                    type="danger"
                                    text
                                    @click.stop="deleteItem(item.id)"
                                />
                            </div>
                        </div>
                        <p class="bookmark-url">
                            {{ item.type === 'folder' ? `${getItemCount(item)} È°π` : getHostname(item.url) }}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ê∑ªÂä†/ÁºñËæë‰π¶Á≠æÂØπËØùÊ°Ü -->
        <el-dialog
            v-model="bookmarkDialogVisible"
            :title="bookmarkDialogTitle"
            width="500px"
            @close="resetBookmarkForm"
        >
            <el-form :model="bookmarkForm" label-width="80px">
                <el-form-item label="Ê†áÈ¢ò">
                    <el-input v-model="bookmarkForm.title" placeholder="ËØ∑ËæìÂÖ•‰π¶Á≠æÊ†áÈ¢ò" />
                </el-form-item>
                <el-form-item label="ÁΩëÂùÄ">
                    <el-input v-model="bookmarkForm.url" placeholder="ËØ∑ËæìÂÖ•ÁΩëÂùÄ" />
                </el-form-item>
                <el-form-item label="Êñá‰ª∂Â§π">
                    <el-select v-model="bookmarkForm.parentId" placeholder="ÈÄâÊã©Êñá‰ª∂Â§π">
                        <el-option
                            v-for="folder in allFolders"
                            :key="folder.id"
                            :label="folder.title"
                            :value="folder.id"
                        />
                    </el-select>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="bookmarkDialogVisible = false">ÂèñÊ∂à</el-button>
                    <el-button type="primary" class="custom-button" @click="saveBookmark">
                        ‰øùÂ≠ò
                    </el-button>
                </span>
            </template>
        </el-dialog>

        <!-- Êñ∞Âª∫Êñá‰ª∂Â§πÂØπËØùÊ°Ü -->
        <el-dialog
            v-model="folderDialogVisible"
            title="Êñ∞Âª∫Êñá‰ª∂Â§π"
            width="400px"
            @close="resetFolderForm"
        >
            <el-form :model="folderForm" label-width="80px">
                <el-form-item label="ÂêçÁß∞">
                    <el-input v-model="folderForm.title" placeholder="ËØ∑ËæìÂÖ•Êñá‰ª∂Â§πÂêçÁß∞" />
                </el-form-item>
                <el-form-item label="‰ΩçÁΩÆ">
                    <el-select v-model="folderForm.parentId" placeholder="ÈÄâÊã©‰ΩçÁΩÆ">
                        <el-option
                            v-for="folder in allFolders"
                            :key="folder.id"
                            :label="folder.title"
                            :value="folder.id"
                        />
                    </el-select>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="folderDialogVisible = false">ÂèñÊ∂à</el-button>
                    <el-button type="primary" class="custom-button" @click="saveFolder">
                        ÂàõÂª∫
                    </el-button>
                </span>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        const app = createApp({
            data() {
                return {
                    searchQuery: '',
                    loading: true,
                    bookmarksData: [],
                    currentFolderId: 'toolbar',
                    selectedItems: [],
                    bookmarkDialogVisible: false,
                    folderDialogVisible: false,
                    isEditing: false,
                    editingBookmarkId: null,
                    bookmarkForm: {
                        title: '',
                        url: '',
                        parentId: 'toolbar'
                    },
                    folderForm: {
                        title: '',
                        parentId: 'toolbar'
                    },
                    treeProps: {
                        children: 'children',
                        label: 'title'
                    }
                };
            },
            computed: {
                currentFolder() {
                    return this.findItemById(this.bookmarksData, this.currentFolderId);
                },
                currentFolderName() {
                    return this.currentFolder?.title || 'Êî∂ËóèÂ§π';
                },
                currentItems() {
                    return this.currentFolder?.children || [];
                },
                filteredItems() {
                    if (!this.searchQuery) {
                        return this.currentItems;
                    }
                    const query = this.searchQuery.toLowerCase();
                    return this.searchAllItems(this.bookmarksData).filter(item =>
                        item.title.toLowerCase().includes(query) ||
                        (item.url && item.url.toLowerCase().includes(query))
                    );
                },
                emptyStateText() {
                    if (this.searchQuery) {
                        return 'Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÊî∂ËóèÂ§π';
                    }
                    return 'Ê≠§Êñá‰ª∂Â§π‰∏∫Á©∫';
                },
                treeData() {
                    return this.bookmarksData.filter(item => item.type === 'folder');
                },
                allFolders() {
                    const folders = [];
                    const addFolders = (items) => {
                        items.forEach(item => {
                            if (item.type === 'folder') {
                                folders.push(item);
                                if (item.children) {
                                    addFolders(item.children);
                                }
                            }
                        });
                    };
                    addFolders(this.bookmarksData);
                    return folders;
                },
                breadcrumbItems() {
                    const items = [];
                    let current = this.currentFolder;
                    while (current) {
                        items.unshift(current);
                        current = this.findParentFolder(current.id);
                    }
                    return items;
                },
                bookmarkDialogTitle() {
                    return this.isEditing ? 'ÁºñËæë‰π¶Á≠æ' : 'Ê∑ªÂä†‰π¶Á≠æ';
                }
            },
            async mounted() {
                await this.loadBookmarks();
                
                // ÁõëÂê¨‰π¶Á≠æÊõ¥Êñ∞
                if (window.api?.onBookmarkUpdated) {
                    window.api.onBookmarkUpdated(() => {
                        this.loadBookmarks();
                    });
                }
            },
            methods: {
                async loadBookmarks() {
                    this.loading = true;
                    try {
                        this.bookmarksData = await window.api.getBookmarksTree() || [];
                        this.selectedItems = [];
                    } catch (error) {
                        console.error('Âä†ËΩΩÊî∂ËóèÂ§πÂ§±Ë¥•:', error);
                        ElMessage.error('Âä†ËΩΩÊî∂ËóèÂ§πÂ§±Ë¥•');
                    } finally {
                        this.loading = false;
                    }
                },
                findItemById(items, id) {
                    for (const item of items) {
                        if (item.id === id) return item;
                        if (item.children) {
                            const found = this.findItemById(item.children, id);
                            if (found) return found;
                        }
                    }
                    return null;
                },
                findParentFolder(childId) {
                    const findParent = (items, targetId, parent = null) => {
                        for (const item of items) {
                            if (item.id === targetId) return parent;
                            if (item.children) {
                                const found = findParent(item.children, targetId, item);
                                if (found) return found;
                            }
                        }
                        return null;
                    };
                    return findParent(this.bookmarksData, childId);
                },
                searchAllItems(items) {
                    const result = [];
                    const search = (items) => {
                        items.forEach(item => {
                            if (item.type === 'bookmark') {
                                result.push(item);
                            }
                            if (item.children) {
                                search(item.children);
                            }
                        });
                    };
                    search(items);
                    return result;
                },
                getItemCount(folder) {
                    if (!folder.children) return 0;
                    return folder.children.length;
                },
                getHostname(url) {
                    try {
                        return new URL(url).hostname;
                    } catch {
                        return url;
                    }
                },
                handleFolderClick(folder) {
                    this.currentFolderId = folder.id;
                    this.selectedItems = [];
                },
                navigateToFolder(folderId) {
                    this.currentFolderId = folderId;
                    this.selectedItems = [];
                },
                handleItemClick(item) {
                    if (item.type === 'folder') {
                        this.currentFolderId = item.id;
                    } else if (item.type === 'bookmark') {
                        window.api.openInNewTab(item.url);
                    }
                },
                handleSearch() {
                    this.selectedItems = [];
                },
                toggleItemSelection(id, checked) {
                    if (checked) {
                        if (!this.selectedItems.includes(id)) {
                            this.selectedItems.push(id);
                        }
                    } else {
                        const index = this.selectedItems.indexOf(id);
                        if (index > -1) {
                            this.selectedItems.splice(index, 1);
                        }
                    }
                },
                showAddBookmarkDialog() {
                    this.isEditing = false;
                    this.editingBookmarkId = null;
                    this.bookmarkForm = {
                        title: '',
                        url: '',
                        parentId: this.currentFolderId
                    };
                    this.bookmarkDialogVisible = true;
                },
                editBookmark(bookmark) {
                    this.isEditing = true;
                    this.editingBookmarkId = bookmark.id;
                    this.bookmarkForm = {
                        title: bookmark.title,
                        url: bookmark.url,
                        parentId: this.findParentFolder(bookmark.id)?.id || this.currentFolderId
                    };
                    this.bookmarkDialogVisible = true;
                },
                showAddFolderDialog() {
                    this.folderForm = {
                        title: '',
                        parentId: this.currentFolderId
                    };
                    this.folderDialogVisible = true;
                },
                resetBookmarkForm() {
                    this.bookmarkForm = {
                        title: '',
                        url: '',
                        parentId: 'toolbar'
                    };
                    this.isEditing = false;
                    this.editingBookmarkId = null;
                },
                resetFolderForm() {
                    this.folderForm = {
                        title: '',
                        parentId: 'toolbar'
                    };
                },
                async saveBookmark() {
                    if (!this.bookmarkForm.title || !this.bookmarkForm.url) {
                        ElMessage.error('ËØ∑Â°´ÂÜôÂÆåÊï¥‰ø°ÊÅØ');
                        return;
                    }

                    try {
                        if (this.isEditing) {
                            await window.api.updateBookmark({
                                id: this.editingBookmarkId,
                                title: this.bookmarkForm.title,
                                url: this.bookmarkForm.url
                            });
                            ElMessage.success('‰π¶Á≠æÂ∑≤Êõ¥Êñ∞');
                        } else {
                            await window.api.addBookmark({
                                parentId: this.bookmarkForm.parentId,
                                title: this.bookmarkForm.title,
                                url: this.bookmarkForm.url
                            });
                            ElMessage.success('‰π¶Á≠æÂ∑≤Ê∑ªÂä†');
                        }
                        
                        this.bookmarkDialogVisible = false;
                        await this.loadBookmarks();
                    } catch (error) {
                        console.error('‰øùÂ≠ò‰π¶Á≠æÂ§±Ë¥•:', error);
                        ElMessage.error('‰øùÂ≠ò‰π¶Á≠æÂ§±Ë¥•');
                    }
                },
                async saveFolder() {
                    if (!this.folderForm.title) {
                        ElMessage.error('ËØ∑ËæìÂÖ•Êñá‰ª∂Â§πÂêçÁß∞');
                        return;
                    }

                    try {
                        await window.api.addBookmarkFolder({
                            parentId: this.folderForm.parentId,
                            title: this.folderForm.title
                        });
                        
                        ElMessage.success('Êñá‰ª∂Â§πÂ∑≤ÂàõÂª∫');
                        this.folderDialogVisible = false;
                        await this.loadBookmarks();
                    } catch (error) {
                        console.error('ÂàõÂª∫Êñá‰ª∂Â§πÂ§±Ë¥•:', error);
                        ElMessage.error('ÂàõÂª∫Êñá‰ª∂Â§πÂ§±Ë¥•');
                    }
                },
                async deleteItem(id) {
                    try {
                        await ElMessageBox.confirm(
                            'Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™È°πÁõÆÂêóÔºü',
                            'Á°ÆËÆ§Âà†Èô§',
                            {
                                confirmButtonText: 'Á°ÆÂÆö',
                                cancelButtonText: 'ÂèñÊ∂à',
                                type: 'warning'
                            }
                        );
                        
                        await window.api.deleteBookmarks([id]);
                        ElMessage.success('Âà†Èô§ÊàêÂäü');
                        await this.loadBookmarks();
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('Âà†Èô§Â§±Ë¥•:', error);
                            ElMessage.error('Âà†Èô§Â§±Ë¥•');
                        }
                    }
                },
                async deleteSelected() {
                    if (this.selectedItems.length === 0) return;
                    
                    try {
                        await ElMessageBox.confirm(
                            `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${this.selectedItems.length} È°πÂêóÔºü`,
                            'Á°ÆËÆ§Âà†Èô§',
                            {
                                confirmButtonText: 'Á°ÆÂÆö',
                                cancelButtonText: 'ÂèñÊ∂à',
                                type: 'warning'
                            }
                        );
                        
                        await window.api.deleteBookmarks(this.selectedItems);
                        ElMessage.success('Âà†Èô§ÊàêÂäü');
                        await this.loadBookmarks();
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('Âà†Èô§Â§±Ë¥•:', error);
                            ElMessage.error('Âà†Èô§Â§±Ë¥•');
                        }
                    }
                }
            }
        });

        // Ê≥®ÂÜåÊâÄÊúâElement PlusÂõæÊ†á
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
            app.component(key, component);
        }

        app.use(ElementPlus).mount('#app');
    </script>
</body>
</html> 