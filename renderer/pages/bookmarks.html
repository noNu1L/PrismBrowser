<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æ”¶è—å¤¹</title>
    <link rel="stylesheet" href="../styles/theme.css">
    <link rel="stylesheet" href="../vendor/element-plus.css">
    <link rel="stylesheet" href="../styles/page-theme.css">
    <script src="../vendor/vue.global.js"></script>
    <script src="../vendor/element-plus.full.js"></script>
    <script src="../vendor/element-plus-icons.js"></script>
</head>
<body>
    <div id="app">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1 class="sidebar-title">æ”¶è—å¤¹</h1>
                <p class="sidebar-subtitle">ç®¡ç†æ‚¨çš„ä¹¦ç­¾å’Œæ–‡ä»¶å¤¹</p>
            </div>
            
            <div class="search-container">
                <el-input
                    v-model="searchQuery"
                    placeholder="æœç´¢æ”¶è—å¤¹..."
                    prefix-icon="Search"
                    clearable
                    @input="handleSearch"
                />
            </div>

            <div class="folder-tree">
                <el-tree
                    :data="treeData"
                    :props="treeProps"
                    node-key="id"
                    :current-node-key="currentFolderId"
                    :default-expand-all="true"
                    @node-click="handleFolderClick"
                >
                    <template #default="{ node, data }">
                        <span style="display: flex; align-items: center; width: 100%;">
                            <el-icon style="margin-right: 8px;">
                                <Folder />
                            </el-icon>
                            <span style="flex: 1;">{{ node.label }}</span>
                            <span style="color: #909399; font-size: 12px;">
                                {{ getItemCount(data) }}
                            </span>
                        </span>
                    </template>
                </el-tree>
            </div>
        </div>

        <!-- ä¸»å†…å®¹ -->
        <div class="main-content">
            <div class="content-header">
                <h1 class="page-title">{{ currentFolderName }}</h1>
                <div class="header-actions">
                    <el-button 
                        v-if="selectedItems.length > 0"
                        type="danger"
                        icon="Delete"
                        @click="deleteSelected"
                    >
                        åˆ é™¤é€‰ä¸­ ({{ selectedItems.length }})
                    </el-button>
                    <el-button 
                        type="primary" 
                        class="btn-base"
                        icon="Plus"
                        @click="showAddBookmarkDialog"
                    >
                        æ·»åŠ æ”¶è—
                    </el-button>
                    <el-button 
                        type="primary" 
                        class="btn-base"
                        icon="Folder"
                        @click="showAddFolderDialog"
                    >
                        æ·»åŠ æ–‡ä»¶å¤¹
                    </el-button>
                </div>
            </div>

            <div class="content-container">
                <div class="breadcrumb-container">
                    <el-breadcrumb separator="/">
                        <el-breadcrumb-item 
                            v-for="item in breadcrumbItems" 
                            :key="item.id"
                            :to="{ path: item.id }"
                            @click="navigateToFolder(item.id)"
                        >
                            {{ item.title }}
                        </el-breadcrumb-item>
                    </el-breadcrumb>
                </div>

                <!-- ç©ºçŠ¶æ€ -->
                <div v-if="!loading && filteredItems.length === 0" class="empty-state">
                    <div class="empty-icon">ğŸ“š</div>
                    <p class="empty-text">{{ emptyStateText }}</p>
                </div>

                <!-- åŠ è½½çŠ¶æ€ -->
                <div v-if="loading" style="text-align: center; padding: 80px;">
                    <el-icon class="is-loading" size="32">
                        <Loading />
                    </el-icon>
                    <p style="margin-top: 16px; color: #909399;">åŠ è½½ä¸­...</p>
                </div>

                <!-- æ”¶è—å¤¹ç½‘æ ¼ -->
                <div v-if="!loading && filteredItems.length > 0" class="bookmark-grid">
                    <div 
                        v-for="item in filteredItems" 
                        :key="item.id"
                        class="bookmark-item"
                        :class="{ 'folder-item': item.type === 'folder' }"
                        @click="handleItemClick(item)"
                    >
                        <div class="bookmark-header">
                            <el-icon v-if="item.type === 'folder'" class="bookmark-favicon" size="24">
                                <Folder />
                            </el-icon>
                            <!-- ç½‘ç«™å›¾æ ‡ï¼šä¼˜åŒ–æ˜¾ç¤ºé€»è¾‘ -->
                            <template v-else>
                                <img 
                                    v-if="item.favicon && !faviconErrors[item.id]"
                                    :src="item.favicon"
                                    class="bookmark-favicon"
                                    @error="handleFaviconError($event, item.id)"
                                    @load="handleFaviconLoad"
                                />
                                <!-- é»˜è®¤åœ°çƒå›¾æ ‡ï¼šæ²¡æœ‰faviconæˆ–åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤º -->
                                <div 
                                    v-else
                                    class="bookmark-favicon default-globe-icon" 
                                    v-html="getDefaultGlobeIcon()"
                                    :title="item.favicon ? 'Favicon åŠ è½½å¤±è´¥' : 'æ²¡æœ‰ç½‘ç«™å›¾æ ‡'"
                                ></div>
                            </template>
                            <h4 class="bookmark-title">{{ item.title }}</h4>
                            <div class="bookmark-actions">
                                <el-checkbox
                                    :model-value="selectedItems.includes(item.id)"
                                    @change="toggleItemSelection(item.id, $event)"
                                    @click.stop
                                />
                                <el-button
                                    v-if="item.type === 'bookmark'"
                                    icon="Edit"
                                    size="small"
                                    text
                                    @click.stop="editBookmark(item)"
                                />
                                <el-button
                                    icon="Delete"
                                    size="small"
                                    type="danger"
                                    text
                                    @click.stop="deleteItem(item.id)"
                                />
                            </div>
                        </div>
                        <p class="bookmark-url">
                            {{ item.type === 'folder' ? `${getItemCount(item)} é¡¹` : getHostname(item.url) }}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ /ç¼–è¾‘ä¹¦ç­¾å¯¹è¯æ¡† -->
        <el-dialog
            v-model="bookmarkDialogVisible"
            :title="bookmarkDialogTitle"
            width="500px"
            @close="resetBookmarkForm"
        >
            <el-form :model="bookmarkForm" label-width="80px">
                <el-form-item label="æ ‡é¢˜">
                    <el-input v-model="bookmarkForm.title" placeholder="è¯·è¾“å…¥ä¹¦ç­¾æ ‡é¢˜" />
                </el-form-item>
                <el-form-item label="ç½‘å€">
                    <el-input v-model="bookmarkForm.url" placeholder="è¯·è¾“å…¥ç½‘å€" />
                </el-form-item>
                <el-form-item label="æ–‡ä»¶å¤¹">
                    <el-select v-model="bookmarkForm.parentId" placeholder="é€‰æ‹©æ–‡ä»¶å¤¹">
                        <el-option
                            v-for="folder in allFolders"
                            :key="folder.id"
                            :label="folder.title"
                            :value="folder.id"
                        />
                    </el-select>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button class="btn-back" @click="bookmarkDialogVisible = false">å–æ¶ˆ</el-button>
                    <el-button class="btn-confirm" @click="saveBookmark">
                        ä¿å­˜
                    </el-button>
                </span>
            </template>
        </el-dialog>

        <!-- æ–°å»ºæ–‡ä»¶å¤¹å¯¹è¯æ¡† -->
        <el-dialog
            v-model="folderDialogVisible"
            title="æ–°å»ºæ–‡ä»¶å¤¹"
            width="400px"
            @close="resetFolderForm"
        >
            <el-form :model="folderForm" label-width="80px">
                <el-form-item label="åç§°">
                    <el-input v-model="folderForm.title" placeholder="è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°" />
                </el-form-item>
                <el-form-item label="ä½ç½®">
                    <el-select v-model="folderForm.parentId" placeholder="é€‰æ‹©ä½ç½®">
                        <el-option
                            v-for="folder in allFolders"
                            :key="folder.id"
                            :label="folder.title"
                            :value="folder.id"
                        />
                    </el-select>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button class="btn-back" @click="folderDialogVisible = false">å–æ¶ˆ</el-button>
                    <el-button class="btn-confirm" @click="saveFolder">
                        åˆ›å»º
                    </el-button>
                </span>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        const app = createApp({
            data() {
                return {
                    searchQuery: '',
                    loading: true,
                    bookmarksData: [],
                    currentFolderId: 'toolbar',
                    selectedItems: [],
                    bookmarkDialogVisible: false,
                    folderDialogVisible: false,
                    isEditing: false,
                    editingBookmarkId: null,
                    faviconErrors: {},
                    bookmarkForm: {
                        title: '',
                        url: '',
                        parentId: 'toolbar'
                    },
                    folderForm: {
                        title: '',
                        parentId: 'toolbar'
                    },
                    treeProps: {
                        children: 'children',
                        label: 'title'
                    }
                };
            },
            computed: {
                currentFolder() {
                    return this.findItemById(this.bookmarksData, this.currentFolderId);
                },
                currentFolderName() {
                    return this.currentFolder?.title || 'æ”¶è—å¤¹';
                },
                currentItems() {
                    return this.currentFolder?.children || [];
                },
                filteredItems() {
                    if (!this.searchQuery) {
                        return this.currentItems;
                    }
                    const query = this.searchQuery.toLowerCase();
                    return this.searchAllItems(this.bookmarksData).filter(item =>
                        item.title.toLowerCase().includes(query) ||
                        (item.url && item.url.toLowerCase().includes(query))
                    );
                },
                emptyStateText() {
                    if (this.searchQuery) {
                        return 'æœªæ‰¾åˆ°åŒ¹é…çš„æ”¶è—å¤¹';
                    }
                    return 'æ­¤æ–‡ä»¶å¤¹ä¸ºç©º';
                },
                treeData() {
                    const buildFolderTree = (items) => {
                        const folders = [];
                        items.forEach(item => {
                            if (item.type === 'folder') {
                                const folder = {
                                    ...item,
                                    children: item.children ? buildFolderTree(item.children) : []
                                };
                                folders.push(folder);
                            }
                        });
                        return folders;
                    };
                    return buildFolderTree(this.bookmarksData);
                },
                allFolders() {
                    const folders = [];
                    const addFolders = (items) => {
                        items.forEach(item => {
                            if (item.type === 'folder') {
                                folders.push(item);
                                if (item.children) {
                                    addFolders(item.children);
                                }
                            }
                        });
                    };
                    addFolders(this.bookmarksData);
                    return folders;
                },
                breadcrumbItems() {
                    const items = [];
                    let current = this.currentFolder;
                    while (current) {
                        items.unshift(current);
                        current = this.findParentFolder(current.id);
                    }
                    return items;
                },
                bookmarkDialogTitle() {
                    return this.isEditing ? 'ç¼–è¾‘ä¹¦ç­¾' : 'æ·»åŠ ä¹¦ç­¾';
                }
            },
            async mounted() {
                await this.loadBookmarks();
                
                // ç›‘å¬ä¹¦ç­¾æ›´æ–°
                if (window.api?.onBookmarkUpdated) {
                    window.api.onBookmarkUpdated(() => {
                        this.loadBookmarks();
                    });
                }
            },
            methods: {
                async loadBookmarks() {
                    this.loading = true;
                    try {
                        // é‡ç½®faviconé”™è¯¯çŠ¶æ€
                        this.resetFaviconErrors();
                        
                        this.bookmarksData = await window.api.getBookmarksTree() || [];
                        this.selectedItems = [];
                        
                        // æ·»åŠ æ—¥å¿—ï¼šæ£€æŸ¥æ”¶è—å¤¹æ•°æ®ç»“æ„
                        console.log('[æ”¶è—å¤¹] åŠ è½½çš„æ”¶è—å¤¹æ•°æ®:', this.bookmarksData);
                        
                        // è¯¦ç»†æ£€æŸ¥æ¯ä¸ªä¹¦ç­¾çš„faviconä¿¡æ¯
                        const allBookmarks = this.searchAllItems(this.bookmarksData);
                        console.log('[æ”¶è—å¤¹] æ‰€æœ‰ä¹¦ç­¾æ•°é‡:', allBookmarks.length);
                        
                        allBookmarks.forEach((bookmark, index) => {
                            console.log(`[æ”¶è—å¤¹] ä¹¦ç­¾ ${index + 1}:`, {
                                id: bookmark.id,
                                title: bookmark.title,
                                url: bookmark.url,
                                favicon: bookmark.favicon,
                                hasFavicon: !!bookmark.favicon,
                                faviconType: typeof bookmark.favicon
                            });
                        });
                        
                    } catch (error) {
                        console.error('åŠ è½½æ”¶è—å¤¹å¤±è´¥:', error);
                        ElMessage.error('åŠ è½½æ”¶è—å¤¹å¤±è´¥');
                    } finally {
                        this.loading = false;
                    }
                },
                // æ£€æŸ¥faviconæ˜¯å¦åŠ è½½å¤±è´¥
                getFaviconErrorState(id) {
                    return this.faviconErrors[id] || false;
                },
                // å¤„ç† favicon åŠ è½½å¤±è´¥çš„æƒ…å†µ
                handleFaviconError(event, id) {
                    const target = event.target;
                    console.log('[æ”¶è—å¤¹] FaviconåŠ è½½å¤±è´¥:', {
                        src: target.src,
                        id: id,
                        error: event
                    });
                    
                    // æ›´æ–°é”™è¯¯çŠ¶æ€ï¼Œè§¦å‘Vueé‡æ–°æ¸²æŸ“
                    this.$set(this.faviconErrors, id, true);
                    console.log('[æ”¶è—å¤¹] å·²æ ‡è®°faviconä¸ºå¤±è´¥çŠ¶æ€ï¼Œå°†æ˜¾ç¤ºé»˜è®¤å›¾æ ‡');
                },
                // å¤„ç† favicon åŠ è½½æˆåŠŸçš„æƒ…å†µ
                handleFaviconLoad(event) {
                    const target = event.target;
                    console.log('[æ”¶è—å¤¹] FaviconåŠ è½½æˆåŠŸ:', {
                        src: target.src,
                        naturalWidth: target.naturalWidth,
                        naturalHeight: target.naturalHeight
                    });
                },
                // é‡ç½®faviconé”™è¯¯çŠ¶æ€
                resetFaviconErrors() {
                    this.faviconErrors = {};
                },
                getDefaultFavicon(url) {
                    try {
                        const urlObj = new URL(url);
                        const defaultFavicon = `${urlObj.protocol}//${urlObj.host}/favicon.ico`;
                        console.log('[æ”¶è—å¤¹] ç”Ÿæˆé»˜è®¤favicon URL:', defaultFavicon);
                        return defaultFavicon;
                    } catch (error) {
                        console.log('[æ”¶è—å¤¹] æ— æ³•è§£æURLç”Ÿæˆé»˜è®¤favicon:', url, error);
                        return null;
                    }
                },
                findItemById(items, id) {
                    for (const item of items) {
                        if (item.id === id) return item;
                        if (item.children) {
                            const found = this.findItemById(item.children, id);
                            if (found) return found;
                        }
                    }
                    return null;
                },
                findParentFolder(childId) {
                    const findParent = (items, targetId, parent = null) => {
                        for (const item of items) {
                            if (item.id === targetId) return parent;
                            if (item.children) {
                                const found = findParent(item.children, targetId, item);
                                if (found) return found;
                            }
                        }
                        return null;
                    };
                    return findParent(this.bookmarksData, childId);
                },
                searchAllItems(items) {
                    const result = [];
                    const search = (items) => {
                        items.forEach(item => {
                            if (item.type === 'bookmark') {
                                result.push(item);
                            }
                            if (item.children) {
                                search(item.children);
                            }
                        });
                    };
                    search(items);
                    return result;
                },
                getItemCount(folder) {
                    if (!folder.children) return 0;
                    return folder.children.length;
                },
                getHostname(url) {
                    try {
                        return new URL(url).hostname;
                    } catch {
                        return url;
                    }
                },
                handleFolderClick(folder) {
                    this.currentFolderId = folder.id;
                    this.selectedItems = [];
                },
                navigateToFolder(folderId) {
                    this.currentFolderId = folderId;
                    this.selectedItems = [];
                },
                handleItemClick(item) {
                    if (item.type === 'folder') {
                        this.currentFolderId = item.id;
                    } else if (item.type === 'bookmark') {
                        window.api.openInNewTab(item.url);
                    }
                },
                handleSearch() {
                    this.selectedItems = [];
                },
                toggleItemSelection(id, checked) {
                    if (checked) {
                        if (!this.selectedItems.includes(id)) {
                            this.selectedItems.push(id);
                        }
                    } else {
                        const index = this.selectedItems.indexOf(id);
                        if (index > -1) {
                            this.selectedItems.splice(index, 1);
                        }
                    }
                },
                showAddBookmarkDialog() {
                    this.isEditing = false;
                    this.editingBookmarkId = null;
                    this.bookmarkForm = {
                        title: '',
                        url: '',
                        parentId: this.currentFolderId
                    };
                    this.bookmarkDialogVisible = true;
                },
                editBookmark(bookmark) {
                    this.isEditing = true;
                    this.editingBookmarkId = bookmark.id;
                    this.bookmarkForm = {
                        title: bookmark.title,
                        url: bookmark.url,
                        parentId: this.findParentFolder(bookmark.id)?.id || this.currentFolderId
                    };
                    this.bookmarkDialogVisible = true;
                },
                showAddFolderDialog() {
                    this.folderForm = {
                        title: '',
                        parentId: this.currentFolderId
                    };
                    this.folderDialogVisible = true;
                },
                resetBookmarkForm() {
                    this.bookmarkForm = {
                        title: '',
                        url: '',
                        parentId: 'toolbar'
                    };
                    this.isEditing = false;
                    this.editingBookmarkId = null;
                },
                resetFolderForm() {
                    this.folderForm = {
                        title: '',
                        parentId: 'toolbar'
                    };
                },
                async saveBookmark() {
                    if (!this.bookmarkForm.title || !this.bookmarkForm.url) {
                        ElMessage.error('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                        return;
                    }

                    try {
                        if (this.isEditing) {
                            console.log('[æ”¶è—å¤¹ç®¡ç†] æ›´æ–°ä¹¦ç­¾:', {
                                id: this.editingBookmarkId,
                                title: this.bookmarkForm.title,
                                url: this.bookmarkForm.url,
                                favicon: null // ç®¡ç†é¡µé¢æš‚æ—¶ä¸å¤„ç†faviconæ›´æ–°
                            });
                            
                            await window.api.updateBookmark({
                                id: this.editingBookmarkId,
                                title: this.bookmarkForm.title,
                                url: this.bookmarkForm.url
                                // æ³¨æ„ï¼šç®¡ç†é¡µé¢æš‚æ—¶ä¸æ›´æ–°faviconï¼Œä¿æŒåŸæœ‰çš„favicon
                            });
                            ElMessage.success('ä¹¦ç­¾å·²æ›´æ–°');
                        } else {
                            console.log('[æ”¶è—å¤¹ç®¡ç†] æ·»åŠ æ–°ä¹¦ç­¾:', {
                                parentId: this.bookmarkForm.parentId,
                                title: this.bookmarkForm.title,
                                url: this.bookmarkForm.url,
                                favicon: null // æ–°å»ºä¹¦ç­¾æ—¶ï¼Œæš‚æ—¶ä¸è®¾ç½®favicon
                            });
                            
                            await window.api.addBookmark({
                                parentId: this.bookmarkForm.parentId,
                                title: this.bookmarkForm.title,
                                url: this.bookmarkForm.url,
                                favicon: null // æ–°å»ºä¹¦ç­¾æ—¶è®¾ç½®ä¸ºnullï¼Œåç»­å¯èƒ½ä¼šè‡ªåŠ¨è·å–
                            });
                            ElMessage.success('ä¹¦ç­¾å·²æ·»åŠ ');
                        }
                        
                        this.bookmarkDialogVisible = false;
                        await this.loadBookmarks();
                    } catch (error) {
                        console.error('ä¿å­˜ä¹¦ç­¾å¤±è´¥:', error);
                        ElMessage.error('ä¿å­˜ä¹¦ç­¾å¤±è´¥');
                    }
                },
                async saveFolder() {
                    if (!this.folderForm.title) {
                        ElMessage.error('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°');
                        return;
                    }

                    try {
                        await window.api.addBookmarkFolder({
                            parentId: this.folderForm.parentId,
                            title: this.folderForm.title
                        });
                        
                        ElMessage.success('æ–‡ä»¶å¤¹å·²åˆ›å»º');
                        this.folderDialogVisible = false;
                        await this.loadBookmarks();
                    } catch (error) {
                        console.error('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥:', error);
                        ElMessage.error('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥');
                    }
                },
                async deleteItem(id) {
                    try {
                        await ElMessageBox.confirm(
                            'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿ',
                            'ç¡®è®¤åˆ é™¤',
                            {
                                confirmButtonText: 'ç¡®å®š',
                                cancelButtonText: 'å–æ¶ˆ',
                                type: 'warning'
                            }
                        );
                        
                        await window.api.deleteBookmarks([id]);
                        ElMessage.success('åˆ é™¤æˆåŠŸ');
                        await this.loadBookmarks();
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('åˆ é™¤å¤±è´¥:', error);
                            ElMessage.error('åˆ é™¤å¤±è´¥');
                        }
                    }
                },
                async deleteSelected() {
                    if (this.selectedItems.length === 0) return;
                    
                    try {
                        await ElMessageBox.confirm(
                            `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${this.selectedItems.length} é¡¹å—ï¼Ÿ`,
                            'ç¡®è®¤åˆ é™¤',
                            {
                                confirmButtonText: 'ç¡®å®š',
                                cancelButtonText: 'å–æ¶ˆ',
                                type: 'warning'
                            }
                        );
                        
                        await window.api.deleteBookmarks(this.selectedItems);
                        ElMessage.success('åˆ é™¤æˆåŠŸ');
                        await this.loadBookmarks();
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('åˆ é™¤å¤±è´¥:', error);
                            ElMessage.error('åˆ é™¤å¤±è´¥');
                        }
                    }
                },
                // è·å–é»˜è®¤åœ°çƒå›¾æ ‡SVG
                getDefaultGlobeIcon() {
                    // ä½¿ç”¨ä¸æ ‡ç­¾æ ç›¸åŒçš„åœ°çƒå›¾æ ‡SVG
                    return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width: 24px; height: 24px; color: #909399;"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>`;
                }
            }
        });

        // æ³¨å†Œæ‰€æœ‰Element Pluså›¾æ ‡
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
            app.component(key, component);
        }

        app.use(ElementPlus).mount('#app');
    </script>
</body>
</html> 