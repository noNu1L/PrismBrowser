<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>下载管理</title>
    <link rel="stylesheet" href="../styles/theme.css">
    <style>
        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden;
            display: flex;
            background-color: var(--app-bg-color-light);
            color: var(--text-color-primary);
        }

        #sidebar {
            width: 240px;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 20px 12px;
            box-sizing: border-box;
            background-color: var(--app-bg-color);
            border-right: 1px solid var(--card-border);
        }
        #main-content {
            flex-grow: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #sidebar h1 {
            font-size: 22px;
            font-weight: 600;
            margin: 0 0 30px 12px;
        }

        .nav-item {
            display: flex; align-items: center; padding: 10px 12px; border-radius: 6px;
            cursor: pointer; font-size: 15px; font-weight: 500;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .nav-item:hover { background-color: var(--button-hover-bg); }
        .nav-item.active { 
            background-color: var(--button-primary-bg); 
            color: white; 
        }
        .nav-item svg { 
            width: 20px; height: 20px; margin-right: 14px; 
            stroke: var(--text-color-secondary);
        }
        .nav-item.active svg { stroke: white; }

        #content-header {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            border-bottom: 1px solid var(--card-border);
        }
        #content-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        #downloads-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 16px 32px;
        }

        .download-item {
            display: flex; align-items: center;
            padding: 16px;
            border-radius: 8px;
            background-color: var(--card-bg);
            margin-bottom: 8px;
        }
        .download-item {
            display: flex; align-items: center;
            padding: 16px;
            border-radius: 8px;
            background-color: var(--card-bg);
            border: 1px solid transparent;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            margin-bottom: 8px;
            transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .download-item:hover {
            border-color: #ccc;
            background-color: var(--item-hover-bg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .download-item-icon {
            width: 32px; height: 32px;
            margin-right: 16px;
            background-color: var(--button-primary-bg);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .download-item-icon svg {
            width: 16px; height: 16px;
            stroke: white;
        }
        .download-item-main {
            display: flex; 
            flex-direction: column;
            flex-grow: 1;
            gap: 4px;
        }
        .download-item-filename {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .download-item-url {
            color: var(--text-color-secondary);
            font-size: 12px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .download-item-status {
            font-size: 12px;
            color: var(--text-color-secondary);
            margin-top: 2px;
        }
        .download-item-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 16px;
        }
        .download-item-actions button {
            width: 24px; height: 24px;
            border: none; background: transparent;
            padding: 0; 
            cursor: pointer; 
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }
        .download-item-actions button:hover {
            opacity: 1;
        }
        .download-item-actions button svg {
            width: 16px; height: 16px;
            stroke: var(--text-color-secondary);
        }
        .no-results {
            text-align: center; margin-top: 50px;
            color: var(--text-color-secondary);
        }
    </style>
</head>
<body>
    <aside id="sidebar">
        <h1>下载管理</h1>
        <nav>
            <div class="nav-item active" data-view="all">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                <span>全部下载</span>
            </div>
        </nav>
    </aside>

    <main id="main-content">
        <header id="content-header">
            <h2>全部下载</h2>
        </header>
        <div id="downloads-container">
            <div class="no-results">暂无下载文件。</div>
        </div>
    </main>

    <script>
        console.log('下载管理页面已加载');
        
        const downloadIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`;
        
        const downloadsContainer = document.getElementById('downloads-container');
        
        // 辅助函数
        const formatFileSize = (bytes) => {
            if (!bytes) return '0 B';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        };

        const getHostname = (url) => {
            try { return new URL(url).hostname; } catch (e) { return url; }
        };

        // 渲染下载列表
        function renderDownloads(downloads) {
            if (downloads.length === 0) {
                downloadsContainer.innerHTML = '<div class="no-results">暂无下载文件。</div>';
                return;
            }

            const html = downloads.map(item => `
                <div class="download-item">
                    <div class="download-item-icon">
                        ${downloadIcon}
                    </div>
                    <div class="download-item-main">
                        <div class="download-item-filename">${item.filename}</div>
                        <div class="download-item-url">${getHostname(item.url)}</div>
                        <div class="download-item-status">
                            ${item.status === 'completed' ? 
                              `${formatFileSize(item.totalBytes)} - 已完成` : 
                              item.status === 'downloading' ? '正在下载...' :
                              item.status === 'error' ? '下载失败' : '未知状态'}
                        </div>
                    </div>
                    <div class="download-item-actions">
                        ${item.status === 'completed' ? `
                            <button title="打开文件" onclick="openDownloadFile('${item.id}')">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                            </button>
                        ` : ''}
                        <button title="删除" onclick="deleteDownload('${item.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                </div>
            `).join('');
            
            downloadsContainer.innerHTML = html;
        }

        // 操作函数
        async function openDownloadFile(downloadId) {
            try {
                await window.api.openDownloadFile(downloadId);
            } catch (error) {
                console.error('打开文件失败:', error);
            }
        }

        async function deleteDownload(downloadId) {
            try {
                await window.api.deleteDownload(downloadId);
                fetchData(); // 重新获取数据
            } catch (error) {
                console.error('删除下载失败:', error);
            }
        }

        // 获取下载数据
        async function fetchData() {
            try {
                const downloads = await window.api.getDownloads() || [];
                console.log('下载数据:', downloads);
                renderDownloads(downloads);
            } catch (error) {
                console.error('获取下载数据失败:', error);
                downloadsContainer.innerHTML = '<div class="no-results">获取下载数据失败。</div>';
            }
        }

        // 暴露函数到全局作用域供onclick使用
        window.openDownloadFile = openDownloadFile;
        window.deleteDownload = deleteDownload;

        window.addEventListener('DOMContentLoaded', fetchData);
    </script>
</body>
</html> 