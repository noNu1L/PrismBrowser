<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PrismBrowser</title>
    <link rel="stylesheet" href="../../styles/theme.css">
    <link rel="stylesheet" href="tabs/tabs.css">
    <link rel="stylesheet" href="addressbar/addressbar.css">
    <link rel="stylesheet" href="bookmarks-bar/bookmarks-bar.css">
    <link rel="stylesheet" href="log-viewer/log-viewer.css">
    <style>
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; 
            font-family: sans-serif; display: flex; flex-direction: column; 
            background-color: var(--app-bg-color); 
            -webkit-app-region: drag; /* ä½¿æ•´ä¸ªèƒŒæ™¯å¯æ‹–æ‹½ */ 
        }

        #window-controls {
            display: flex;
            position: absolute;
            top: 0;
            right: 0;
            height: 35px;
            -webkit-app-region: no-drag;
            z-index: 9999;
        }
        #window-controls button {
            width: 46px;
            height: 100%;
            border: none;
            background-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #window-controls button svg {
            width: 10px;
            height: 10px;
            fill: var(--text-color-primary);
        }
        #window-controls button:hover {
            background-color: var(--window-control-hover-bg);
        }
        #window-controls #close-btn:hover {
            background-color: var(--window-close-hover-bg);
            color: var(--window-close-hover-text);
        }

        /* --- ä¸»è¦å†…å®¹åŒºåŸŸ --- */
        #main-content { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column;
            position: relative;
            -webkit-app-region: no-drag;
        }
        #webview-container { position: relative; flex-grow: 1; background-color: var(--content-bg-color); }
        webview { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: inline-flex !important; 
            visibility: hidden;
        }
        webview.active {
            visibility: visible;
        }
        #error-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--error-page-bg);
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-family: sans-serif;
        }
        #error-page h1 { font-size: 24px; color: var(--error-page-title-color); margin-bottom: 10px; }
        #error-page p { font-size: 16px; color: var(--error-page-text-color); }
        #error-page button { margin-top: 20px; padding: 10px 20px; font-size: 16px; border: 1px solid var(--border-color-secondary); border-radius: 4px; }

    </style>
</head>
<body>
    <div id="window-controls">
        <button id="minimize-btn" title="æœ€å°åŒ–">
            <svg x="0px" y="0px" viewBox="0 0 10.2 1"><rect x="0" y="0" width="10.2" height="1"></rect></svg>
        </button>
        <button id="maximize-btn" title="æœ€å¤§åŒ–">
            <svg x="0px" y="0px" viewBox="0 0 10.2 10.2"><path d="M0,0v10.2h10.2V0H0z M9.2,9.2H1V1h8.2V9.2z"></path></svg>
        </button>
        <button id="close-btn" title="å…³é—­">
            <svg x="0px" y="0px" viewBox="0 0 10.2 10.2"><polygon points="10.2,0.7 9.5,0 5.1,4.4 0.7,0 0,0.7 4.4,5.1 0,9.5 0.7,10.2 5.1,5.8 9.5,10.2 10.2,9.5 5.8,5.1"></polygon></svg>
        </button>
    </div>
    
    <!-- ç»„ä»¶å®¹å™¨ï¼Œå°†é€šè¿‡åŠ¨æ€åŠ è½½å¡«å…… -->
    <div id="tabs-bar-container"></div>
    <div id="addressbar-container"></div>
    <div id="bookmarks-bar-container"></div>
    <div id="main-content">
        <div id="webview-container">
            <!-- ç½‘é¡µè§†å›¾å°†åœ¨è¿™é‡ŒåŠ¨æ€æ’å…¥ -->
        </div>
        <div id="error-page">
            <h1>æ— æ³•è®¿é—®æ­¤ç½‘ç«™</h1>
            <p id="error-desc"></p>
            <button id="reload-failed-url">é‡æ–°åŠ è½½</button>
        </div>
        <div id="log-viewer-container"></div>
    </div>

    <!-- ç»„ä»¶è„šæœ¬ -->
    <script src="tabs/tabs.js"></script>
    <script src="addressbar/addressbar.js"></script>
    <script src="bookmarks-bar/bookmarks-bar.js"></script>
    <script src="log-viewer/log-viewer.js"></script>
    
    <script>
        // --- å…¨å±€å˜é‡å’Œå¸¸é‡ ---
        let lastFailedURL = '';

        // --- å†…éƒ¨åè®®æ˜ å°„ ---
        const INTERNAL_PROTOCOLS = {
            'prism://settings': { file: '../settings.html', title: 'è®¾ç½®', icon: 'settings' },
            'prism://history': { file: '../history.html', title: 'å†å²è®°å½•', icon: 'history' },
            'prism://bookmarks': { file: '../bookmarks.html', title: 'æ”¶è—å¤¹', icon: 'bookmarks' },
            'prism://dashboard': { file: '../dashboard/index.html', title: 'ä»£ç†é¢æ¿', icon: 'dashboard' }
        };

        // ç³»ç»Ÿé¡µé¢å›¾æ ‡
        const SYSTEM_ICONS = {
            settings: `<svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.25C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.25c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.25c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.25c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>`,
            history: `<svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/></svg>`,
            bookmarks: `<svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`,
            dashboard: `<svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 2a10 10 0 0 0-3.38 19.33M12 2a10 10 0 0 1 3.38 19.33"/><path d="M2 12h20M2.67 7h18.66M2.67 17h18.66"/></svg>`
        };

        const defaultGlobeIcon = `<svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>`;

        // --- URL è§„èŒƒåŒ–è¾…åŠ©å‡½æ•° ---
        const normalizeUrl = (url) => {
            if (!url || url === 'about:blank' || url.startsWith('http') || url.startsWith('file://')) {
                return url;
            }
            return 'http://' + url;
        };

        // --- æå–ä¸»æœºåè¾…åŠ©å‡½æ•° ---
        const getHostname = (url) => {
            try {
                return new URL(url).hostname;
            } catch (e) {
                return url;
            }
        };

        // --- å…¨å±€å˜é‡è®¾ç½®åˆ° window å¯¹è±¡ ---
        window.INTERNAL_PROTOCOLS = INTERNAL_PROTOCOLS;
        window.SYSTEM_ICONS = SYSTEM_ICONS;
        window.defaultGlobeIcon = defaultGlobeIcon;
        window.normalizeUrl = normalizeUrl;
        window.getHostname = getHostname;

        // --- DOM å…ƒç´ å¼•ç”¨ ---
        const minimizeBtn = document.getElementById('minimize-btn');
        const maximizeBtn = document.getElementById('maximize-btn');
        const closeBtn = document.getElementById('close-btn');
        const errorPage = document.getElementById('error-page');
        const errorDesc = document.getElementById('error-desc');
        const reloadFailedButton = document.getElementById('reload-failed-url');

        // --- ç»„ä»¶ç®¡ç†å™¨å®ä¾‹ ---
        let tabsManager;
        let addressBarManager;
        let bookmarksBarManager;
        let logViewerManager;

        // --- Webview äº‹ä»¶ç›‘å¬å™¨ ---
        const addWebviewListeners = (tab) => {
            const { webview, el, id } = tab;
            const titleEl = el.querySelector('.tab-title');

            webview.addEventListener('page-favicon-updated', (e) => {
                if (e.favicons && e.favicons.length > 0) {
                    const bestFavicon = e.favicons[0];
                    tab.favicon = bestFavicon;
                    tabsManager.setTabIcon(el, `<img class="tab-icon" src="${bestFavicon}">`);
                }
            });

            webview.addEventListener('page-title-updated', (e) => { 
                titleEl.textContent = e.title; 
                titleEl.title = e.title; 
            });
            
            webview.addEventListener('did-start-loading', () => { 
                tabsManager.showLoadingIndicator(el, true);
                if (titleEl.textContent === 'æ–°æ ‡ç­¾é¡µ') {
                    const url = webview.getURL() || webview.src;
                    titleEl.textContent = getHostname(url);
                }
                addressBarManager.updateNavButtonsState(); 
            });

            webview.addEventListener('did-finish-load', async () => {
                tabsManager.showLoadingIndicator(el, false);
                const url = webview.getURL();
                const title = webview.getTitle();
                if (url && title && url !== 'about:blank' && !url.startsWith('file://')) {
                    window.api.addHistory({ url, title, favicon: tab.favicon, timestamp: new Date().toISOString() });
                }

                const currentIcon = el.querySelector('.tab-icon');
                if (currentIcon && currentIcon.classList.contains('loading-spinner')) {
                    try {
                        const faviconURL = await webview.executeJavaScript(`
                            (() => {
                                const icon = document.querySelector('link[rel="icon"], link[rel="shortcut icon"]');
                                return icon ? icon.href : null;
                            })();
                        `);
                        if (faviconURL) {
                            tab.favicon = faviconURL;
                            tabsManager.setTabIcon(el, `<img class="tab-icon" src="${faviconURL}">`);
                        } else {
                            tabsManager.setTabIcon(el, defaultGlobeIcon);
                        }
                    } catch (error) {
                        console.error('é€šè¿‡ JS è·å–ç½‘ç«™å›¾æ ‡æ—¶å‡ºé”™:', error);
                        tabsManager.setTabIcon(el, defaultGlobeIcon);
                    }
                }
            });

            webview.addEventListener('did-stop-loading', () => {
                tabsManager.showLoadingIndicator(el, false);
                addressBarManager.updateNavButtonsState();
            });

            webview.addEventListener('did-navigate', (e) => {
                if (id === tabsManager.activeTabId) {
                    const displayUrl = tab.internalUrl || e.url;
                    addressBarManager.urlInput.value = displayUrl;
                    addressBarManager.updateBookmarkStar(e.url);
                }
                addressBarManager.updateNavButtonsState();
            });

            webview.addEventListener('did-fail-load', (e) => {
                if (e.errorCode === -3) return;
                tabsManager.showLoadingIndicator(el, false);
                
                titleEl.textContent = getHostname(e.validatedURL);

                if (id === tabsManager.activeTabId) {
                    lastFailedURL = e.validatedURL;
                    errorDesc.textContent = `ç½‘å€ä¸º ${e.validatedURL} çš„ç½‘é¡µå¯èƒ½æš‚æ—¶æ— æ³•è¿æ¥...`;
                    errorPage.style.display = 'flex';
                }
            });
        };

        // è®¾ç½®å…¨å±€å‡½æ•°å¯è®¿é—®
        window.addWebviewListeners = addWebviewListeners;

        // --- é”™è¯¯é¡µé¢é‡æ–°åŠ è½½æŒ‰é’® ---
        reloadFailedButton.addEventListener('click', () => {
            const tab = tabsManager.getActiveTab();
            if (tab && lastFailedURL) {
                tab.webview.loadURL(lastFailedURL);
            }
        });

        // ç›‘å¬æ¥è‡ªå…¶ä»–çª—å£çš„æ–°æ ‡ç­¾é¡µè¯·æ±‚
        window.api.onNewTabRequest((url) => {
            tabsManager.createNewTab(url);
        });

        // --- çª—å£æ§åˆ¶æŒ‰é’® ---
        minimizeBtn.addEventListener('click', () => window.api.sendWindowControl('minimize'));
        maximizeBtn.addEventListener('click', () => window.api.sendWindowControl('maximize'));
        closeBtn.addEventListener('click', () => window.api.sendWindowControl('close'));

        // --- ç»„ä»¶åŠ è½½å‡½æ•° ---
        async function loadComponents() {
            try {
                console.log('ğŸ”„ å¼€å§‹åŠ è½½ç»„ä»¶...');
                
                // åŠ è½½æ ‡ç­¾æ ç»„ä»¶
                const tabsResponse = await fetch('tabs/tabs.html');
                if (!tabsResponse.ok) {
                    throw new Error(`åŠ è½½ tabs.html å¤±è´¥: ${tabsResponse.status}`);
                }
                const tabsHTML = await tabsResponse.text();
                document.getElementById('tabs-bar-container').innerHTML = tabsHTML;
                console.log('âœ… æ ‡ç­¾æ ç»„ä»¶åŠ è½½å®Œæˆ');

                // åŠ è½½åœ°å€æ ç»„ä»¶
                const addressbarResponse = await fetch('addressbar/addressbar.html');
                if (!addressbarResponse.ok) {
                    throw new Error(`åŠ è½½ addressbar.html å¤±è´¥: ${addressbarResponse.status}`);
                }
                const addressbarHTML = await addressbarResponse.text();
                document.getElementById('addressbar-container').innerHTML = addressbarHTML;
                console.log('âœ… åœ°å€æ ç»„ä»¶åŠ è½½å®Œæˆ');

                // åŠ è½½æ”¶è—å¤¹æ ç»„ä»¶
                const bookmarksResponse = await fetch('bookmarks-bar/bookmarks-bar.html');
                if (!bookmarksResponse.ok) {
                    throw new Error(`åŠ è½½ bookmarks-bar.html å¤±è´¥: ${bookmarksResponse.status}`);
                }
                const bookmarksHTML = await bookmarksResponse.text();
                document.getElementById('bookmarks-bar-container').innerHTML = bookmarksHTML;
                console.log('âœ… æ”¶è—å¤¹æ ç»„ä»¶åŠ è½½å®Œæˆ');

                // åŠ è½½æ—¥å¿—æŸ¥çœ‹å™¨ç»„ä»¶
                const logViewerResponse = await fetch('log-viewer/log-viewer.html');
                if (!logViewerResponse.ok) {
                    throw new Error(`åŠ è½½ log-viewer.html å¤±è´¥: ${logViewerResponse.status}`);
                }
                const logViewerHTML = await logViewerResponse.text();
                document.getElementById('log-viewer-container').innerHTML = logViewerHTML;
                console.log('âœ… æ—¥å¿—æŸ¥çœ‹å™¨ç»„ä»¶åŠ è½½å®Œæˆ');
                
                console.log('âœ… æ‰€æœ‰ç»„ä»¶åŠ è½½å®Œæˆ');
                return true;
            } catch (error) {
                console.error('âŒ ç»„ä»¶åŠ è½½å¤±è´¥:', error);
                // ä¸æŠ›å‡ºé”™è¯¯ï¼Œè€Œæ˜¯è¿”å› falseï¼Œè®©åº”ç”¨ç¨‹åºç»§ç»­è¿è¡Œ
                return false;
            }
        }

        // --- ä¸»åˆå§‹åŒ–å‡½æ•° ---
        const init = async () => {
            try {
                console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–åº”ç”¨ç¨‹åº...');
                
                // 1. é¦–å…ˆåŠ è½½ç»„ä»¶ HTML
                const componentsLoaded = await loadComponents();
                if (!componentsLoaded) {
                    console.warn('âš ï¸ ç»„ä»¶åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ¨¡å¼');
                    // å¦‚æœç»„ä»¶åŠ è½½å¤±è´¥ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å¤‡ç”¨HTML
                    return;
                }
                
                // 2. åˆå§‹åŒ–ç»„ä»¶ç®¡ç†å™¨
                console.log('ğŸ”§ åˆå§‹åŒ–ç»„ä»¶ç®¡ç†å™¨...');
                tabsManager = new TabsManager();
                addressBarManager = new AddressBarManager();
                bookmarksBarManager = new BookmarksBarManager();
                logViewerManager = new LogViewerManager();
                
                // è®¾ç½®å…¨å±€å¼•ç”¨
                window.tabsManager = tabsManager;
                window.addressBarManager = addressBarManager;
                window.bookmarksBarManager = bookmarksBarManager;
                window.logViewerManager = logViewerManager;
                
                // æ ¹æ®å¯åŠ¨æ—¶è®¾ç½®å†³å®šæ‰“å¼€ä»€ä¹ˆé¡µé¢
                const startupOption = await window.api.getSetting('settings.startupOption') || 'homepage';
                let startupUrl;
                
                if (startupOption === 'homepage') {
                    const homepageOption = await window.api.getSetting('settings.homepageOption') || 'custom';
                    if (homepageOption === 'newtab') {
                        const newtabOption = await window.api.getSetting('settings.newtabOption') || 'blank';
                        startupUrl = newtabOption === 'blank' ? 'about:blank' : 
                                    (await window.api.getSetting('settings.newtabCustomUrl') || 'https://www.google.com');
                    } else {
                        startupUrl = await window.api.getSetting('settings.homepageCustomUrl') || 'https://www.google.com';
                    }
                } else if (startupOption === 'newtab') {
                    const newtabOption = await window.api.getSetting('settings.newtabOption') || 'blank';
                    startupUrl = newtabOption === 'blank' ? 'about:blank' : 
                                (await window.api.getSetting('settings.newtabCustomUrl') || 'https://www.google.com');
                } else if (startupOption === 'custom') {
                    startupUrl = await window.api.getSetting('settings.startupCustomUrl') || 'https://www.google.com';
                } else {
                    startupUrl = await window.api.getSetting('settings.homepageCustomUrl') || 'https://www.google.com';
                }
                
                tabsManager.createNewTab(startupUrl);
                console.log('âœ… åº”ç”¨ç¨‹åºåˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('âŒ åº”ç”¨ç¨‹åºåˆå§‹åŒ–å¤±è´¥:', error);
            }
        };

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);

        // ç›‘å¬æ¥è‡ªå…¶ä»–çª—å£çš„æ”¶è—å¤¹æ›´æ–°è¯·æ±‚
        window.api.onBookmarkUpdated(() => {
            if (window.bookmarksBarManager) {
                window.bookmarksBarManager.refreshBookmarks();
            }
        });
    </script>
</body>
</html> 