<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PrismBrowser</title>
    <link rel="stylesheet" href="../../styles/theme.css">
    <link rel="stylesheet" href="tabs/tabs.css">
    <link rel="stylesheet" href="addressbar/addressbar.css">
    <link rel="stylesheet" href="bookmarks-bar/bookmarks-bar.css">
    <link rel="stylesheet" href="log-viewer/log-viewer.css">
    <style>
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; 
            font-family: sans-serif; display: flex; flex-direction: column; 
            background-color: var(--app-bg-color); 
            -webkit-app-region: drag; /* 使整个背景可拖拽 */ 
        }

        #window-controls {
            display: flex;
            position: absolute;
            top: 0;
            right: 0;
            height: 35px;
            -webkit-app-region: no-drag;
            z-index: 9999;
        }
        #window-controls button {
            width: 46px;
            height: 100%;
            border: none;
            background-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #window-controls button svg {
            width: 10px;
            height: 10px;
            fill: var(--text-color-primary);
        }
        #window-controls button:hover {
            background-color: var(--window-control-hover-bg);
        }
        #window-controls #close-btn:hover {
            background-color: var(--window-close-hover-bg);
            color: var(--window-close-hover-text);
        }

        /* --- 主要内容区域 --- */
        #main-content { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column;
            position: relative;
            -webkit-app-region: no-drag;
        }
        #webview-container { position: relative; flex-grow: 1; background-color: var(--content-bg-color); }
        webview { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: inline-flex !important; 
            visibility: hidden;
        }
        webview.active {
            visibility: visible;
        }
        #error-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--error-page-bg);
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-family: sans-serif;
        }
        #error-page h1 { font-size: 24px; color: var(--error-page-title-color); margin-bottom: 10px; }
        #error-page p { font-size: 16px; color: var(--error-page-text-color); }
        #error-page button { margin-top: 20px; padding: 10px 20px; font-size: 16px; border: 1px solid var(--border-color-secondary); border-radius: 4px; }

        /* --- 主菜单弹窗 --- */
        .popup-menu {
            position: fixed;
            z-index: 10000;
            background-color: var(--card-bg);
            border-radius: 6px;
            border: 1px solid var(--border-color-secondary);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 8px;
            min-width: 200px;
        }
        .popup-menu-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-color-primary);
        }
        .popup-menu-item:hover {
            background-color: var(--button-hover-bg);
        }
        .popup-menu-item svg {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            stroke: var(--text-color-secondary);
            fill: none;
        }
        .popup-menu-separator {
            height: 1px;
            background-color: var(--border-color-secondary);
            margin: 8px -8px;
        }



        /* --- 下载弹窗 --- */
        .downloads-popup {
            position: fixed;
            z-index: 10000;
            background-color: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color-secondary);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 360px;
            max-width: calc(100vw - 40px);
            max-height: 500px;
            overflow-y: auto;
        }

        .downloads-popup-header {
            padding: 16px 20px 12px;
            border-bottom: 1px solid var(--border-color-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .downloads-popup-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color-primary);
        }

        .downloads-popup-btn {
            background-color: var(--button-primary-bg);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .downloads-popup-btn:hover {
            background-color: var(--button-primary-hover-bg);
        }

        .downloads-section {
            padding: 0 20px;
        }

        .downloads-section h4 {
            margin: 16px 0 8px 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color-secondary);
        }

        .download-popup-item {
            display: flex;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color-light);
            gap: 12px;
        }

        .download-popup-item:last-child {
            border-bottom: none;
        }

        .file-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 16px;
            flex-shrink: 0;
        }

        .file-icon.pdf { background-color: #ffebee; }
        .file-icon.doc { background-color: #e3f2fd; }
        .file-icon.xls { background-color: #e8f5e8; }
        .file-icon.zip { background-color: #fff3e0; }
        .file-icon.exe { background-color: #f3e5f5; }
        .file-icon.default { background-color: #f5f5f5; }

        .download-popup-info {
            flex-grow: 1;
            min-width: 0;
        }

        .download-popup-filename {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-color-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }

        .download-popup-source {
            font-size: 12px;
            color: var(--text-color-secondary);
            margin-bottom: 4px;
        }

        .download-popup-status {
            font-size: 12px;
            color: var(--text-color-secondary);
        }

        .download-popup-progress {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .progress-bar {
            flex-grow: 1;
            height: 4px;
            background-color: var(--input-border);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--button-primary-bg);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 11px;
            color: var(--text-color-secondary);
            min-width: 30px;
            text-align: right;
        }

        .download-popup-actions {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .download-action-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .download-action-btn:hover {
            opacity: 1;
        }

        .downloads-empty {
            padding: 40px 20px;
            text-align: center;
        }

        .downloads-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .downloads-empty p {
            margin: 0;
            color: var(--text-color-secondary);
            font-size: 14px;
        }

    </style>
</head>
<body>
    <div id="window-controls">
        <button id="minimize-btn" title="最小化">
            <svg x="0px" y="0px" viewBox="0 0 10.2 1"><rect x="0" y="0" width="10.2" height="1"></rect></svg>
        </button>
        <button id="maximize-btn" title="最大化">
            <svg x="0px" y="0px" viewBox="0 0 10.2 10.2"><path d="M0,0v10.2h10.2V0H0z M9.2,9.2H1V1h8.2V9.2z"></path></svg>
        </button>
        <button id="close-btn" title="关闭">
            <svg x="0px" y="0px" viewBox="0 0 10.2 10.2"><polygon points="10.2,0.7 9.5,0 5.1,4.4 0.7,0 0,0.7 4.4,5.1 0,9.5 0.7,10.2 5.1,5.8 9.5,10.2 10.2,9.5 5.8,5.1"></polygon></svg>
        </button>
    </div>
    
    <!-- 组件容器，将通过动态加载填充 -->
    <div id="tabs-bar-container"></div>
    <div id="addressbar-container"></div>
    <div id="bookmarks-bar-container"></div>
    <div id="main-content">
        <div id="webview-container">
            <!-- 网页视图将在这里动态插入 -->
        </div>
        <div id="error-page">
            <h1>无法访问此网站</h1>
            <p id="error-desc"></p>
            <button id="reload-failed-url">重新加载</button>
        </div>
        <div id="log-viewer-container"></div>
    </div>
    <div id="main-menu-popup" class="popup-menu" style="display: none;">
        <!-- 菜单项将在这里动态生成 -->
    </div>

    <!-- 下载弹窗 -->
    <div id="downloads-popup" class="downloads-popup" style="display: none;">
        <!-- 内容将动态生成 -->
    </div>



    <!-- 组件脚本 -->
    <script src="tabs/tabs.js"></script>
    <script src="addressbar/addressbar.js"></script>
    <script src="bookmarks-bar/bookmarks-bar.js"></script>
    <script src="log-viewer/log-viewer.js"></script>
    
    <script>
        // --- 全局变量和常量 ---
        let lastFailedURL = '';

        // --- 内部协议映射 ---
        const INTERNAL_PROTOCOLS = {
            'prism://settings': { file: '../settings.html', title: '设置', icon: 'settings' },
            'prism://history': { file: '../history.html', title: '历史记录', icon: 'history' },
            'prism://bookmarks': { file: '../bookmarks.html', title: '收藏夹', icon: 'bookmarks' },
            'prism://downloads': { file: '../downloads.html', title: '下载管理', icon: 'downloads' },
            'prism://dashboard': { file: '../../dashboard/index.html', title: '代理面板', icon: 'dashboard' }
        };

        // 系统页面图标
        const SYSTEM_ICONS = {
            settings: `<svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.25C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.25c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.25c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.25c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>`,
            history: `<svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/></svg>`,
            bookmarks: `<svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`,
            downloads: `<svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`,
            dashboard: `<svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 2a10 10 0 0 0-3.38 19.33M12 2a10 10 0 0 1 3.38 19.33"/><path d="M2 12h20M2.67 7h18.66M2.67 17h18.66"/></svg>`
        };

        const defaultGlobeIcon = `<svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>`;

        // --- URL 规范化辅助函数 ---
        const normalizeUrl = (url) => {
            if (!url || url === 'about:blank' || url.startsWith('http') || url.startsWith('file://')) {
                return url;
            }
            return 'http://' + url;
        };

        // --- 提取主机名辅助函数 ---
        const getHostname = (url) => {
            try {
                return new URL(url).hostname;
            } catch (e) {
                return url;
            }
        };

        // --- 全局变量设置到 window 对象 ---
        window.INTERNAL_PROTOCOLS = INTERNAL_PROTOCOLS;
        window.SYSTEM_ICONS = SYSTEM_ICONS;
        window.defaultGlobeIcon = defaultGlobeIcon;
        window.normalizeUrl = normalizeUrl;
        window.getHostname = getHostname;

        // --- DOM 元素引用 ---
        const minimizeBtn = document.getElementById('minimize-btn');
        const maximizeBtn = document.getElementById('maximize-btn');
        const closeBtn = document.getElementById('close-btn');
        const errorPage = document.getElementById('error-page');
        const errorDesc = document.getElementById('error-desc');
        const reloadFailedButton = document.getElementById('reload-failed-url');

        // --- 组件管理器实例 ---
        let tabsManager;
        let addressBarManager;
        let bookmarksBarManager;
        let logViewerManager;

        // --- Webview 事件监听器 ---
        const addWebviewListeners = (tab) => {
            const { webview, el, id } = tab;
            const titleEl = el.querySelector('.tab-title');

            webview.addEventListener('page-favicon-updated', (e) => {
                if (e.favicons && e.favicons.length > 0) {
                    const bestFavicon = e.favicons[0];
                    tab.favicon = bestFavicon;
                    tabsManager.setTabIcon(el, `<img class="tab-icon" src="${bestFavicon}">`);
                }
            });

            webview.addEventListener('page-title-updated', (e) => { 
                titleEl.textContent = e.title; 
                titleEl.title = e.title; 
            });
            
            webview.addEventListener('did-start-loading', () => { 
                tabsManager.showLoading(el);
                if (titleEl.textContent === '新标签页') {
                    try {
                        const url = (webview.getURL && webview.getURL()) || webview.src || '';
                        if (url) {
                            titleEl.textContent = getHostname(url);
                        }
                    } catch (error) {
                        console.error('Error getting URL for title update:', error);
                        // 保持原标题或使用默认值
                    }
                }
                addressBarManager.updateNavButtonsState(); 
            });

            webview.addEventListener('did-stop-loading', () => {
                tabsManager.hideLoading(el);
                addressBarManager.updateNavButtonsState();
            });

            webview.addEventListener('did-navigate', (e) => {
                if (id === tabsManager.activeTabId) {
                    const displayUrl = tab.internalUrl || e.url;
                    addressBarManager.urlInput.value = displayUrl;
                    try {
                        // 安全地获取URL用于更新收藏星标
                        const bookmarkUrl = e.url || (webview.getURL ? webview.getURL() : '');
                        addressBarManager.updateBookmarkStar(bookmarkUrl);
                    } catch (error) {
                        console.error('Error updating bookmark star on navigate:', error);
                        addressBarManager.updateBookmarkStar('');
                    }
                }
                addressBarManager.updateNavButtonsState();
            });

            webview.addEventListener('did-fail-load', (e) => {
                if (e.errorCode === -3) return; // -3 is ABORTED, we can ignore it.
                
                titleEl.textContent = getHostname(e.validatedURL);

                if (id === tabsManager.activeTabId) {
                    lastFailedURL = e.validatedURL;
                    errorDesc.textContent = `网址为 ${e.validatedURL} 的网页可能暂时无法连接...`;
                    errorPage.style.display = 'flex';
                }
            });

            // Handle new windows (e.g., target="_blank")
            webview.addEventListener('new-window', (e) => {
                e.preventDefault(); // Prevent default Electron window behavior
                tabsManager.createNewTab(e.url);
            });
        };

        // 设置全局函数可访问
        window.addWebviewListeners = addWebviewListeners;

        // --- 会话状态管理 ---
        let sessionSaveTimer = null;
        
        // 保存当前会话状态
        async function saveCurrentSession() {
            try {
                // 检查是否有标签页管理器和标签页
                if (!tabsManager || !tabsManager.tabs || tabsManager.tabs.length === 0) {
                    // 没有标签页时，清除会话状态而不是保存空状态
                    await window.api.clearSessionState();
                    return;
                }

                const tabs = tabsManager.tabs.map(tab => {
                    let url = 'about:blank';
                    try {
                        if (tab.internalUrl) {
                            url = tab.internalUrl;
                        } else if (tab.webview && typeof tab.webview.getURL === 'function') {
                            const webviewUrl = tab.webview.getURL();
                            if (webviewUrl && webviewUrl !== '' && !webviewUrl.startsWith('file://')) {
                                url = webviewUrl;
                            }
                        }
                    } catch (error) {
                        console.warn('获取标签页URL失败:', error);
                    }
                    
                    return {
                        url: url,
                        title: tab.el.querySelector('.tab-title').textContent || '新标签页'
                    };
                });
                
                // 只保存有效的标签页（非空白页和非文件协议）
                const validTabs = tabs.filter(tab => 
                    tab.url !== 'about:blank' && 
                    !tab.url.startsWith('file://') &&
                    tab.url !== ''
                );
                
                if (validTabs.length > 0) {
                    const activeTabIndex = tabsManager.tabs.findIndex(tab => tab.id === tabsManager.activeTabId);
                    const sessionData = {
                        tabs: validTabs,
                        activeTabIndex: Math.max(0, activeTabIndex) // 确保索引有效
                    };
                    await window.api.saveSessionState(sessionData);
                } else {
                    // 没有有效标签页时，清除会话状态
                    await window.api.clearSessionState();
                }
            } catch (error) {
                console.error('保存会话状态失败:', error);
            }
        }
        
        // 设置会话状态自动保存
        function setupSessionSaving() {
            // 每30秒自动保存一次会话状态
            sessionSaveTimer = setInterval(() => {
                saveCurrentSession();
            }, 30000);
            
            // 监听页面卸载事件，在关闭前保存会话
            window.addEventListener('beforeunload', () => {
                saveCurrentSession();
            });
            
            // 监听标签页变化，对于关闭操作立即保存，其他操作延迟保存
            const debouncedSave = debounce(saveCurrentSession, 5000);
            
            // 重写 TabsManager 的方法以触发会话保存
            const originalCreateNewTab = tabsManager.createNewTab.bind(tabsManager);
            const originalCloseTab = tabsManager.closeTab.bind(tabsManager);
            const originalSwitchToTab = tabsManager.switchToTab.bind(tabsManager);
            
            tabsManager.createNewTab = function(...args) {
                const result = originalCreateNewTab(...args);
                debouncedSave(); // 创建新标签页使用防抖
                return result;
            };
            
            tabsManager.closeTab = function(...args) {
                const result = originalCloseTab(...args);
                // 标签页关闭后立即保存会话状态（如果还有标签页的话）
                if (this.tabs.length > 0) {
                    saveCurrentSession();
                }
                return result;
            };
            
            tabsManager.switchToTab = function(...args) {
                const result = originalSwitchToTab(...args);
                debouncedSave(); // 切换标签页使用防抖
                return result;
            };
        }
        
        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }



        // --- 错误页面重新加载按钮 ---
        reloadFailedButton.addEventListener('click', () => {
            const tab = tabsManager.getActiveTab();
            if (tab && lastFailedURL) {
                tab.webview.loadURL(lastFailedURL);
            }
        });

        // 监听来自其他窗口的新标签页请求
        window.api.onNewTabRequest((url) => {
            tabsManager.createNewTab(url);
        });

        // 监听下载事件
        window.api.onDownloadStarted((downloadItem) => {
            // 自动显示下载弹窗，稍微延迟以确保组件已完全初始化
            setTimeout(() => {
                if (window.addressBarManager && window.addressBarManager.showDownloadsPopup) {
                    window.addressBarManager.showDownloadsPopup();
                }
            }, 500);
        });

        window.api.onDownloadProgress((downloadItem) => {
            // 如果下载弹窗打开，刷新内容
            const popup = document.getElementById('downloads-popup');
            if (popup && popup.style.display === 'block' && window.addressBarManager) {
                window.addressBarManager.showDownloadsPopup();
            }
        });

        window.api.onDownloadCompleted((downloadItem) => {
            // 如果下载弹窗打开，刷新内容
            const popup = document.getElementById('downloads-popup');
            if (popup && popup.style.display === 'block' && window.addressBarManager) {
                window.addressBarManager.showDownloadsPopup();
            }
        });

        // --- 窗口控制按钮 ---
        minimizeBtn.addEventListener('click', () => window.api.sendWindowControl('minimize'));
        maximizeBtn.addEventListener('click', () => window.api.sendWindowControl('maximize'));
        closeBtn.addEventListener('click', () => window.api.sendWindowControl('close'));

        // --- 异常关闭恢复对话框 ---
        async function showCrashRecoveryDialog() {
            return new Promise((resolve) => {
                // 创建模态对话框
                const dialog = document.createElement('div');
                dialog.className = 'crash-recovery-dialog';
                dialog.innerHTML = `
                    <div class="dialog-overlay">
                        <div class="dialog-content">
                            <h2>恢复会话</h2>
                            <p>检测到浏览器上次异常关闭，是否恢复上次的浏览会话？</p>
                            <div class="dialog-buttons">
                                <button id="restore-session-btn" class="primary-btn">恢复会话</button>
                                <button id="new-session-btn" class="secondary-btn">重新开始</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // 添加样式
                const style = document.createElement('style');
                style.textContent = `
                    .crash-recovery-dialog {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        z-index: 10000;
                    }
                    .dialog-overlay {
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    .dialog-content {
                        background: #fff;
                        border-radius: 8px;
                        padding: 24px;
                        width: 400px;
                        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                    }
                    .dialog-content h2 {
                        margin: 0 0 12px 0;
                        color: #333;
                        font-size: 18px;
                    }
                    .dialog-content p {
                        margin: 0 0 20px 0;
                        color: #666;
                        line-height: 1.4;
                    }
                    .dialog-buttons {
                        display: flex;
                        gap: 12px;
                        justify-content: flex-end;
                    }
                    .dialog-buttons button {
                        padding: 8px 16px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 14px;
                    }
                    .primary-btn {
                        background: #007acc;
                        color: white;
                    }
                    .primary-btn:hover {
                        background: #005f99;
                    }
                    .secondary-btn {
                        background: #f1f1f1;
                        color: #333;
                    }
                    .secondary-btn:hover {
                        background: #e0e0e0;
                    }
                `;
                
                document.head.appendChild(style);
                document.body.appendChild(dialog);
                
                // 绑定按钮事件
                document.getElementById('restore-session-btn').addEventListener('click', () => {
                    document.body.removeChild(dialog);
                    document.head.removeChild(style);
                    resolve(true);
                });
                
                document.getElementById('new-session-btn').addEventListener('click', () => {
                    document.body.removeChild(dialog);
                    document.head.removeChild(style);
                    resolve(false);
                });
            });
        }

        // --- 应用关闭前处理 ---
        window.api.onAppBeforeQuit(async () => {
            // 只有在还有标签页的情况下才保存会话状态
            if (window.tabsManager && window.tabsManager.tabs.length > 0) {
                await saveCurrentSession();
            } else {
                // 如果没有标签页，清除会话状态
                await window.api.clearSessionState();
            }
            // 确认关闭
            window.api.confirmAppClose();
        });

        // --- 组件加载函数 ---
        async function loadComponents() {
            try {
                // 加载标签栏组件
                const tabsResponse = await fetch('tabs/tabs.html');
                if (!tabsResponse.ok) {
                    throw new Error(`加载 tabs.html 失败: ${tabsResponse.status}`);
                }
                const tabsHTML = await tabsResponse.text();
                document.getElementById('tabs-bar-container').innerHTML = tabsHTML;

                // 加载地址栏组件
                const addressbarResponse = await fetch('addressbar/addressbar.html');
                if (!addressbarResponse.ok) {
                    throw new Error(`加载 addressbar.html 失败: ${addressbarResponse.status}`);
                }
                const addressbarHTML = await addressbarResponse.text();
                document.getElementById('addressbar-container').innerHTML = addressbarHTML;

                // 加载收藏夹栏组件
                const bookmarksResponse = await fetch('bookmarks-bar/bookmarks-bar.html');
                if (!bookmarksResponse.ok) {
                    throw new Error(`加载 bookmarks-bar.html 失败: ${bookmarksResponse.status}`);
                }
                const bookmarksHTML = await bookmarksResponse.text();
                document.getElementById('bookmarks-bar-container').innerHTML = bookmarksHTML;

                // 加载日志查看器组件
                const logViewerResponse = await fetch('log-viewer/log-viewer.html');
                if (!logViewerResponse.ok) {
                    throw new Error(`加载 log-viewer.html 失败: ${logViewerResponse.status}`);
                }
                const logViewerHTML = await logViewerResponse.text();
                document.getElementById('log-viewer-container').innerHTML = logViewerHTML;
                
                return true;
            } catch (error) {
                console.error('❌ 组件加载失败:', error);
                // 不抛出错误，而是返回 false，让应用程序继续运行
                return false;
            }
        }

        // --- 主初始化函数 ---
        const init = async () => {
            try {
                // 0. 检查是否需要异常关闭恢复
                const crashRecovery = await window.api.checkCrashRecovery();
                if (crashRecovery.crashed) {
                    const shouldRestore = await showCrashRecoveryDialog();
                    if (shouldRestore) {
                        // 用户选择恢复，设置启动选项为恢复模式
                        await window.api.setSetting('tempStartupOption', 'restore');
                    } else {
                        // 用户选择不恢复，清除会话状态
                        await window.api.clearSessionState();
                        await window.api.setSetting('tempStartupOption', 'normal');
                    }
                }
                
                // 1. 首先加载组件 HTML
                const componentsLoaded = await loadComponents();
                if (!componentsLoaded) {
                    console.warn('⚠️ 组件加载失败，使用备用模式');
                    // 如果组件加载失败，可以在这里添加备用HTML
                    return;
                }
                
                // 2. 初始化组件管理器
                tabsManager = new TabsManager();
                addressBarManager = new AddressBarManager();
                bookmarksBarManager = new BookmarksBarManager();
                logViewerManager = new LogViewerManager();
                
                // 设置全局引用
                window.tabsManager = tabsManager;
                window.addressBarManager = addressBarManager;
                window.bookmarksBarManager = bookmarksBarManager;
                window.logViewerManager = logViewerManager;
                
                // 根据启动时设置决定打开什么页面
                const tempStartupOption = await window.api.getSetting('tempStartupOption');
                const startupOption = tempStartupOption || await window.api.getSetting('settings.startupOption') || 'homepage';
                
                // 清除临时启动选项
                if (tempStartupOption) {
                    await window.api.setSetting('tempStartupOption', null);
                }
                
                if (startupOption === 'restore') {
                    // 会话恢复模式
                    try {
                        const sessionState = await window.api.getSessionState();
                        if (sessionState && sessionState.tabs && sessionState.tabs.length > 0) {
                            // 恢复所有标签页 - 加入延迟避免ID冲突
                            for (let i = 0; i < sessionState.tabs.length; i++) {
                                const tab = sessionState.tabs[i];
                                
                                // 第一个标签页不隐藏，其他隐藏 - 让TabsManager自然处理激活状态
                                const shouldHide = i > 0;
                                
                                // 添加微小延迟确保每个标签页有唯一的时间戳
                                if (i > 0) {
                                    await new Promise(resolve => setTimeout(resolve, 1));
                                }
                                
                                tabsManager.createNewTab(tab.url, shouldHide);
                            }
                        } else {
                            // 没有会话数据，创建默认标签页
                            const homepageOption = await window.api.getSetting('settings.homepageOption') || 'custom';
                            const defaultUrl = homepageOption === 'blank' ? 'about:blank' : 
                                              await window.api.getSetting('settings.homepageCustomUrl') || 'https://www.bing.com';
                            tabsManager.createNewTab(defaultUrl);
                        }
                    } catch (error) {
                        console.error('恢复会话失败:', error);
                        // 出错时创建默认标签页
                        tabsManager.createNewTab('https://www.bing.com');
                    }
                } else {
                    // 正常启动模式
                    let startupUrl;
                    
                    if (startupOption === 'blank') {
                        startupUrl = 'about:blank';
                    } else if (startupOption === 'homepage') {
                        const homepageOption = await window.api.getSetting('settings.homepageOption') || 'custom';
                        if (homepageOption === 'blank') {
                            startupUrl = 'about:blank';
                        } else {
                            startupUrl = await window.api.getSetting('settings.homepageCustomUrl') || 'https://www.bing.com';
                        }
                    } else if (startupOption === 'custom') {
                        startupUrl = await window.api.getSetting('settings.startupCustomUrl') || 'https://www.bing.com';
                    } else {
                        // 默认回退到主页
                        const homepageOption = await window.api.getSetting('settings.homepageOption') || 'custom';
                        if (homepageOption === 'blank') {
                            startupUrl = 'about:blank';
                        } else {
                            startupUrl = await window.api.getSetting('settings.homepageCustomUrl') || 'https://www.bing.com';
                        }
                    }
                    
                    tabsManager.createNewTab(startupUrl);
                }
                // 设置会话状态保存
                setupSessionSaving();
            } catch (error) {
                console.error('❌ 应用程序初始化失败:', error);
            }
        };

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);

        // 监听来自其他窗口的收藏夹更新请求
        window.api.onBookmarkUpdated(() => {
            if (window.bookmarksBarManager) {
                window.bookmarksBarManager.refreshBookmarks();
            }
        });

        // 页面卸载时清理资源
        window.addEventListener('beforeunload', () => {
            if (window.tabsManager && window.tabsManager.cleanup) {
                window.tabsManager.cleanup();
            }
        });
    </script>
</body>
</html> 