<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PrismBrowser</title>
    <link rel="stylesheet" href="../../styles/theme.css">
    <link rel="stylesheet" href="tabs/tabs.css">
    <link rel="stylesheet" href="addressbar/addressbar.css">
    <link rel="stylesheet" href="bookmarks-bar/bookmarks-bar.css">
    <link rel="stylesheet" href="log-viewer/log-viewer.css">
    <style>
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; 
            font-family: sans-serif; display: flex; flex-direction: column; 
            background-color: var(--app-bg-color); 
            -webkit-app-region: drag; /* ‰ΩøÊï¥‰∏™ËÉåÊôØÂèØÊãñÊãΩ */ 
        }

        #window-controls {
            display: flex;
            position: absolute;
            top: 0;
            right: 0;
            height: 35px;
            -webkit-app-region: no-drag;
            z-index: 9999;
        }
        #window-controls button {
            width: 46px;
            height: 100%;
            border: none;
            background-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #window-controls button svg {
            width: 10px;
            height: 10px;
            fill: var(--text-color-primary);
        }
        #window-controls button:hover {
            background-color: var(--window-control-hover-bg);
        }
        #window-controls #close-btn:hover {
            background-color: var(--window-close-hover-bg);
            color: var(--window-close-hover-text);
        }

        /* --- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü --- */
        #main-content { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column;
            position: relative;
            -webkit-app-region: no-drag;
        }
        #webview-container { position: relative; flex-grow: 1; background-color: var(--content-bg-color); }
        webview { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: inline-flex !important; 
            visibility: hidden;
        }
        webview.active {
            visibility: visible;
        }
        #error-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--error-page-bg);
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-family: sans-serif;
        }
        #error-page h1 { font-size: 24px; color: var(--error-page-title-color); margin-bottom: 10px; }
        #error-page p { font-size: 16px; color: var(--error-page-text-color); }
        #error-page button { margin-top: 20px; padding: 10px 20px; font-size: 16px; border: 1px solid var(--border-color-secondary); border-radius: 4px; }

        /* --- ‰∏ªËèúÂçïÂºπÁ™ó --- */
        .popup-menu {
            position: fixed;
            z-index: 10000;
            background-color: var(--card-bg);
            border-radius: 6px;
            border: 1px solid var(--border-color-secondary);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 8px;
            min-width: 200px;
        }
        .popup-menu-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-color-primary);
        }
        .popup-menu-item:hover {
            background-color: var(--button-hover-bg);
        }
        .popup-menu-item svg {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            stroke: var(--text-color-secondary);
            fill: none;
        }
        .popup-menu-separator {
            height: 1px;
            background-color: var(--border-color-secondary);
            margin: 8px -8px;
        }



        /* --- ‰∏ãËΩΩÂºπÁ™ó --- */
        .downloads-popup {
            position: fixed;
            z-index: 10000;
            background-color: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color-secondary);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 360px;
            max-width: calc(100vw - 40px);
            max-height: 500px;
            overflow-y: auto;
        }

        .downloads-popup-header {
            padding: 16px 20px 12px;
            border-bottom: 1px solid var(--border-color-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .downloads-popup-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color-primary);
        }

        .downloads-popup-btn {
            background-color: var(--button-primary-bg);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .downloads-popup-btn:hover {
            background-color: var(--button-primary-hover-bg);
        }

        .downloads-section {
            padding: 0 20px;
        }

        .downloads-section h4 {
            margin: 16px 0 8px 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color-secondary);
        }

        .download-popup-item {
            display: flex;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color-light);
            gap: 12px;
        }

        .download-popup-item:last-child {
            border-bottom: none;
        }

        .file-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 16px;
            flex-shrink: 0;
        }

        .file-icon.pdf { background-color: #ffebee; }
        .file-icon.doc { background-color: #e3f2fd; }
        .file-icon.xls { background-color: #e8f5e8; }
        .file-icon.zip { background-color: #fff3e0; }
        .file-icon.exe { background-color: #f3e5f5; }
        .file-icon.default { background-color: #f5f5f5; }

        .download-popup-info {
            flex-grow: 1;
            min-width: 0;
        }

        .download-popup-filename {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-color-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }

        .download-popup-source {
            font-size: 12px;
            color: var(--text-color-secondary);
            margin-bottom: 4px;
        }

        .download-popup-status {
            font-size: 12px;
            color: var(--text-color-secondary);
        }

        .download-popup-progress {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .progress-bar {
            flex-grow: 1;
            height: 4px;
            background-color: var(--input-border);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--button-primary-bg);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 11px;
            color: var(--text-color-secondary);
            min-width: 30px;
            text-align: right;
        }

        .download-popup-actions {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .download-action-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .download-action-btn:hover {
            opacity: 1;
        }

        .downloads-empty {
            padding: 40px 20px;
            text-align: center;
        }

        .downloads-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .downloads-empty p {
            margin: 0;
            color: var(--text-color-secondary);
            font-size: 14px;
        }

    </style>
</head>
<body>
    <div id="window-controls">
        <button id="minimize-btn" title="ÊúÄÂ∞èÂåñ">
            <svg x="0px" y="0px" viewBox="0 0 10.2 1"><rect x="0" y="0" width="10.2" height="1"></rect></svg>
        </button>
        <button id="maximize-btn" title="ÊúÄÂ§ßÂåñ">
            <svg x="0px" y="0px" viewBox="0 0 10.2 10.2"><path d="M0,0v10.2h10.2V0H0z M9.2,9.2H1V1h8.2V9.2z"></path></svg>
        </button>
        <button id="close-btn" title="ÂÖ≥Èó≠">
            <svg x="0px" y="0px" viewBox="0 0 10.2 10.2"><polygon points="10.2,0.7 9.5,0 5.1,4.4 0.7,0 0,0.7 4.4,5.1 0,9.5 0.7,10.2 5.1,5.8 9.5,10.2 10.2,9.5 5.8,5.1"></polygon></svg>
        </button>
    </div>
    
    <!-- ÁªÑ‰ª∂ÂÆπÂô®ÔºåÂ∞ÜÈÄöËøáÂä®ÊÄÅÂä†ËΩΩÂ°´ÂÖÖ -->
    <div id="tabs-bar-container"></div>
    <div id="addressbar-container"></div>
    <div id="bookmarks-bar-container"></div>
    <div id="main-content">
        <div id="webview-container">
            <!-- ÁΩëÈ°µËßÜÂõæÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÊèíÂÖ• -->
        </div>
        <div id="error-page">
            <h1>Êó†Ê≥ïËÆøÈóÆÊ≠§ÁΩëÁ´ô</h1>
            <p id="error-desc"></p>
            <button id="reload-failed-url">ÈáçÊñ∞Âä†ËΩΩ</button>
        </div>
        <div id="log-viewer-container"></div>
    </div>
    <div id="main-menu-popup" class="popup-menu" style="display: none;">
        <!-- ËèúÂçïÈ°πÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
    </div>

    <!-- ‰∏ãËΩΩÂºπÁ™ó -->
    <div id="downloads-popup" class="downloads-popup" style="display: none;">
        <!-- ÂÜÖÂÆπÂ∞ÜÂä®ÊÄÅÁîüÊàê -->
    </div>



    <!-- ÁªÑ‰ª∂ËÑöÊú¨ -->
    <script src="tabs/tabs.js"></script>
    <script src="addressbar/addressbar.js"></script>
    <script src="bookmarks-bar/bookmarks-bar.js"></script>
    <script src="log-viewer/log-viewer.js"></script>
    
    <script>
        // --- ÂÖ®Â±ÄÂèòÈáèÂíåÂ∏∏Èáè ---
        let lastFailedURL = '';

        // --- ÂÜÖÈÉ®ÂçèËÆÆÊò†Â∞Ñ ---
        const INTERNAL_PROTOCOLS = {
            'prism://settings': { file: '../settings.html', title: 'ËÆæÁΩÆ', icon: 'settings' },
            'prism://history': { file: '../history.html', title: 'ÂéÜÂè≤ËÆ∞ÂΩï', icon: 'history' },
            'prism://bookmarks': { file: '../bookmarks.html', title: 'Êî∂ËóèÂ§π', icon: 'bookmarks' },
            'prism://downloads': { file: '../downloads.html', title: '‰∏ãËΩΩÁÆ°ÁêÜ', icon: 'downloads' },
            'prism://dashboard': { file: '../../dashboard/index.html', title: '‰ª£ÁêÜÈù¢Êùø', icon: 'dashboard' }
        };

        // Á≥ªÁªüÈ°µÈù¢ÂõæÊ†á
        const SYSTEM_ICONS = {
            settings: `<svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.25C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.25c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.25c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.25c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>`,
            history: `<svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/></svg>`,
            bookmarks: `<svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`,
            downloads: `<svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`,
            dashboard: `<svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 2a10 10 0 0 0-3.38 19.33M12 2a10 10 0 0 1 3.38 19.33"/><path d="M2 12h20M2.67 7h18.66M2.67 17h18.66"/></svg>`
        };

        const defaultGlobeIcon = `<svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>`;

        // --- URL ËßÑËåÉÂåñËæÖÂä©ÂáΩÊï∞ ---
        const normalizeUrl = (url) => {
            if (!url || url === 'about:blank' || url.startsWith('http') || url.startsWith('file://')) {
                return url;
            }
            return 'http://' + url;
        };

        // --- ÊèêÂèñ‰∏ªÊú∫ÂêçËæÖÂä©ÂáΩÊï∞ ---
        const getHostname = (url) => {
            try {
                return new URL(url).hostname;
            } catch (e) {
                return url;
            }
        };

        // --- ÂÖ®Â±ÄÂèòÈáèËÆæÁΩÆÂà∞ window ÂØπË±° ---
        window.INTERNAL_PROTOCOLS = INTERNAL_PROTOCOLS;
        window.SYSTEM_ICONS = SYSTEM_ICONS;
        window.defaultGlobeIcon = defaultGlobeIcon;
        window.normalizeUrl = normalizeUrl;
        window.getHostname = getHostname;

        // --- DOM ÂÖÉÁ¥†ÂºïÁî® ---
        const minimizeBtn = document.getElementById('minimize-btn');
        const maximizeBtn = document.getElementById('maximize-btn');
        const closeBtn = document.getElementById('close-btn');
        const errorPage = document.getElementById('error-page');
        const errorDesc = document.getElementById('error-desc');
        const reloadFailedButton = document.getElementById('reload-failed-url');

        // --- ÁªÑ‰ª∂ÁÆ°ÁêÜÂô®ÂÆû‰æã ---
        let tabsManager;
        let addressBarManager;
        let bookmarksBarManager;
        let logViewerManager;

        // --- Webview ‰∫ã‰ª∂ÁõëÂê¨Âô® ---
        const addWebviewListeners = (tab) => {
            const { webview, el, id } = tab;
            const titleEl = el.querySelector('.tab-title');

            webview.addEventListener('page-favicon-updated', (e) => {
                if (e.favicons && e.favicons.length > 0) {
                    const bestFavicon = e.favicons[0];
                    tab.favicon = bestFavicon;
                    tabsManager.setTabIcon(el, `<img class="tab-icon" src="${bestFavicon}">`);
                }
            });

            webview.addEventListener('page-title-updated', (e) => { 
                titleEl.textContent = e.title; 
                titleEl.title = e.title; 
            });
            
            webview.addEventListener('did-start-loading', () => { 
                tabsManager.showLoadingIndicator(el, true);
                if (titleEl.textContent === 'Êñ∞Ê†áÁ≠æÈ°µ') {
                    const url = webview.getURL() || webview.src;
                    titleEl.textContent = getHostname(url);
                }
                addressBarManager.updateNavButtonsState(); 
            });

            webview.addEventListener('did-finish-load', async () => {
                tabsManager.showLoadingIndicator(el, false);
                const url = webview.getURL();
                const title = webview.getTitle();
                if (url && title && url !== 'about:blank' && !url.startsWith('file://')) {
                    window.api.addHistory({ url, title, favicon: tab.favicon, timestamp: new Date().toISOString() });
                }

                const currentIcon = el.querySelector('.tab-icon');
                if (currentIcon && currentIcon.classList.contains('loading-spinner')) {
                    try {
                        const faviconURL = await webview.executeJavaScript(`
                            (() => {
                                const icon = document.querySelector('link[rel="icon"], link[rel="shortcut icon"]');
                                return icon ? icon.href : null;
                            })();
                        `);
                        if (faviconURL) {
                            tab.favicon = faviconURL;
                            tabsManager.setTabIcon(el, `<img class="tab-icon" src="${faviconURL}">`);
                        } else {
                            tabsManager.setTabIcon(el, defaultGlobeIcon);
                        }
                    } catch (error) {
                        console.error('ÈÄöËøá JS Ëé∑ÂèñÁΩëÁ´ôÂõæÊ†áÊó∂Âá∫Èîô:', error);
                        tabsManager.setTabIcon(el, defaultGlobeIcon);
                    }
                }
            });

            webview.addEventListener('did-stop-loading', () => {
                tabsManager.showLoadingIndicator(el, false);
                addressBarManager.updateNavButtonsState();
            });

            webview.addEventListener('did-navigate', (e) => {
                if (id === tabsManager.activeTabId) {
                    const displayUrl = tab.internalUrl || e.url;
                    addressBarManager.urlInput.value = displayUrl;
                    addressBarManager.updateBookmarkStar(e.url);
                }
                addressBarManager.updateNavButtonsState();
            });

            webview.addEventListener('did-fail-load', (e) => {
                if (e.errorCode === -3) return;
                tabsManager.showLoadingIndicator(el, false);
                
                titleEl.textContent = getHostname(e.validatedURL);

                if (id === tabsManager.activeTabId) {
                    lastFailedURL = e.validatedURL;
                    errorDesc.textContent = `ÁΩëÂùÄ‰∏∫ ${e.validatedURL} ÁöÑÁΩëÈ°µÂèØËÉΩÊöÇÊó∂Êó†Ê≥ïËøûÊé•...`;
                    errorPage.style.display = 'flex';
                }
            });

            // Â§ÑÁêÜÊñ∞Á™óÂè£/Êñ∞Ê†áÁ≠æÈ°µËØ∑Ê±Ç
            webview.addEventListener('new-window', (e) => {
                console.log('new-window ‰∫ã‰ª∂Ëß¶Âèë:', e.url, 'disposition:', e.disposition);
                e.preventDefault(); // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
                // Âú®Êñ∞Ê†áÁ≠æÈ°µ‰∏≠ÊâìÂºÄÈìæÊé•
                tabsManager.createNewTab(e.url);
            });

            // Ê∑ªÂä†È¢ùÂ§ñÁöÑDOMÂ∞±Áª™‰∫ã‰ª∂ÁõëÂê¨Âô®Êù•Ê≥®ÂÖ•ÈìæÊé•Êã¶Êà™ËÑöÊú¨
            webview.addEventListener('dom-ready', () => {
                // Ê≥®ÂÖ•JavaScriptÊù•Êã¶Êà™ÁõÆÊ†á‰∏∫_blankÁöÑÈìæÊé•Âíå‰∏≠ÈîÆÁÇπÂáª
                webview.executeJavaScript(`
                    (function() {
                        console.log('ÈìæÊé•Êã¶Êà™ËÑöÊú¨Â∑≤Ê≥®ÂÖ•');
                        
                        // Êã¶Êà™ÊâÄÊúâÈìæÊé•ÁÇπÂáª
                        document.addEventListener('click', function(e) {
                            const link = e.target.closest('a');
                            if (link) {
                                const href = link.href || link.getAttribute('href');
                                // Ê£ÄÊü•ÊòØÂê¶Â∫îËØ•Âú®Êñ∞Ê†áÁ≠æÈ°µÊâìÂºÄ
                                const shouldOpenNewTab = link.target === '_blank' || 
                                                        e.ctrlKey || 
                                                        e.metaKey || 
                                                        e.button === 1; // ‰∏≠ÈîÆÁÇπÂáª
                                                        
                                if (shouldOpenNewTab && href && (href.startsWith('http') || href.startsWith('https'))) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    console.log('Êã¶Êà™Âà∞Êñ∞Ê†áÁ≠æÈ°µÈìæÊé•:', href);
                                    
                                    // ÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂ÁöÑÊ†áËÆ∞ÂÖÉÁ¥†Êù•Ëß¶Âèë‰∫ã‰ª∂
                                    const marker = document.createElement('div');
                                    marker.style.display = 'none';
                                    marker.setAttribute('data-new-tab-url', href);
                                    marker.setAttribute('data-event-type', 'link-click');
                                    document.body.appendChild(marker);
                                    
                                    // Á´ãÂç≥ÁßªÈô§Ê†áËÆ∞ÂÖÉÁ¥†
                                    setTimeout(() => {
                                        if (marker.parentNode) {
                                            marker.parentNode.removeChild(marker);
                                        }
                                    }, 100);
                                }
                            }
                        }, true);

                        // Êã¶Êà™Èº†Ê†á‰∏≠ÈîÆÁÇπÂáª
                        document.addEventListener('auxclick', function(e) {
                            if (e.button === 1) { // ‰∏≠ÈîÆ
                                const link = e.target.closest('a');
                                if (link) {
                                    const href = link.href || link.getAttribute('href');
                                    if (href && (href.startsWith('http') || href.startsWith('https'))) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        console.log('Êã¶Êà™Âà∞‰∏≠ÈîÆÁÇπÂáªÈìæÊé•:', href);
                                        
                                        const marker = document.createElement('div');
                                        marker.style.display = 'none';
                                        marker.setAttribute('data-new-tab-url', href);
                                        marker.setAttribute('data-event-type', 'middle-click');
                                        document.body.appendChild(marker);
                                        
                                        setTimeout(() => {
                                            if (marker.parentNode) {
                                                marker.parentNode.removeChild(marker);
                                            }
                                        }, 100);
                                    }
                                }
                            }
                        }, true);

                        // Êã¶Êà™window.openË∞ÉÁî®
                        const originalOpen = window.open;
                        window.open = function(url, target, features) {
                            if (url && (url.startsWith('http') || url.startsWith('https'))) {
                                console.log('Êã¶Êà™Âà∞window.openË∞ÉÁî®:', url);
                                
                                const marker = document.createElement('div');
                                marker.style.display = 'none';
                                marker.setAttribute('data-new-tab-url', url);
                                marker.setAttribute('data-event-type', 'window-open');
                                document.body.appendChild(marker);
                                
                                setTimeout(() => {
                                    if (marker.parentNode) {
                                        marker.parentNode.removeChild(marker);
                                    }
                                }, 100);
                                
                                return null; // ÈòªÊ≠¢ÂéüÂßãÁöÑwindow.open
                            }
                            return originalOpen.call(this, url, target, features);
                        };
                    })();
                `).catch(error => {
                    console.error('Ê≥®ÂÖ•ÈìæÊé•Êã¶Êà™ËÑöÊú¨Â§±Ë¥•:', error);
                });
            });

            // ÂÆöÊúüÊ£ÄÊü•webview‰∏≠ÁöÑÊñ∞Ê†áÁ≠æÈ°µËØ∑Ê±ÇÊ†áËÆ∞
            const checkForNewTabRequests = () => {
                webview.executeJavaScript(`
                    (() => {
                        const markers = document.querySelectorAll('[data-new-tab-url]');
                        const urls = [];
                        markers.forEach(marker => {
                            urls.push(marker.getAttribute('data-new-tab-url'));
                            marker.remove();
                        });
                        return urls;
                    })();
                `).then(urls => {
                    urls.forEach(url => {
                        if (url) {
                            console.log('Ê£ÄÊµãÂà∞Êñ∞Ê†áÁ≠æÈ°µËØ∑Ê±Ç:', url);
                            tabsManager.createNewTab(url);
                        }
                    });
                }).catch(error => {
                    // ÂøΩÁï•ÊâßË°åÈîôËØØÔºåÂèØËÉΩÊòØÈ°µÈù¢ËøòÊ≤°ÂáÜÂ§áÂ•Ω
                });
            };

            // ÊØè100msÊ£ÄÊü•‰∏ÄÊ¨°Êñ∞Ê†áÁ≠æÈ°µËØ∑Ê±Ç
            const newTabCheckInterval = setInterval(checkForNewTabRequests, 100);
            
            // ÂΩìwebviewÈîÄÊØÅÊó∂Ê∏ÖÁêÜÂÆöÊó∂Âô®
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.removedNodes.forEach((node) => {
                        if (node === webview) {
                            clearInterval(newTabCheckInterval);
                            observer.disconnect();
                        }
                    });
                });
            });
            observer.observe(document.getElementById('webview-container'), { childList: true });

            // ÁõëÂê¨consoleÊ∂àÊÅØÊù•Ë∞ÉËØï
            webview.addEventListener('console-message', (e) => {
                if (e.message.includes('Êã¶Êà™Âà∞') || e.message.includes('ÈìæÊé•Êã¶Êà™ËÑöÊú¨')) {
                    console.log('Webview console:', e.message);
                }
            });


        };

        // ËÆæÁΩÆÂÖ®Â±ÄÂáΩÊï∞ÂèØËÆøÈóÆ
        window.addWebviewListeners = addWebviewListeners;



        // --- ÈîôËØØÈ°µÈù¢ÈáçÊñ∞Âä†ËΩΩÊåâÈíÆ ---
        reloadFailedButton.addEventListener('click', () => {
            const tab = tabsManager.getActiveTab();
            if (tab && lastFailedURL) {
                tab.webview.loadURL(lastFailedURL);
            }
        });

        // ÁõëÂê¨Êù•Ëá™ÂÖ∂‰ªñÁ™óÂè£ÁöÑÊñ∞Ê†áÁ≠æÈ°µËØ∑Ê±Ç
        window.api.onNewTabRequest((url) => {
            tabsManager.createNewTab(url);
        });

        // ÁõëÂê¨‰∏ãËΩΩ‰∫ã‰ª∂
        window.api.onDownloadStarted((downloadItem) => {
            console.log('Renderer received download started event:', downloadItem);
            // Ëá™Âä®ÊòæÁ§∫‰∏ãËΩΩÂºπÁ™óÔºåÁ®çÂæÆÂª∂Ëøü‰ª•Á°Æ‰øùÁªÑ‰ª∂Â∑≤ÂÆåÂÖ®ÂàùÂßãÂåñ
            setTimeout(() => {
                console.log('Attempting to show downloads popup, addressBarManager:', !!window.addressBarManager);
                if (window.addressBarManager && window.addressBarManager.showDownloadsPopup) {
                    console.log('Calling showDownloadsPopup...');
                    window.addressBarManager.showDownloadsPopup();
                } else {
                    console.error('addressBarManager or showDownloadsPopup method not available');
                }
            }, 500);
        });

        window.api.onDownloadProgress((downloadItem) => {
            console.log('Download progress updated:', downloadItem);
            // Â¶ÇÊûú‰∏ãËΩΩÂºπÁ™óÊâìÂºÄÔºåÂà∑Êñ∞ÂÜÖÂÆπ
            const popup = document.getElementById('downloads-popup');
            if (popup && popup.style.display === 'block' && window.addressBarManager) {
                window.addressBarManager.showDownloadsPopup();
            }
        });

        window.api.onDownloadCompleted((downloadItem) => {
            console.log('Download completed:', downloadItem);
            // Â¶ÇÊûú‰∏ãËΩΩÂºπÁ™óÊâìÂºÄÔºåÂà∑Êñ∞ÂÜÖÂÆπ
            const popup = document.getElementById('downloads-popup');
            if (popup && popup.style.display === 'block' && window.addressBarManager) {
                window.addressBarManager.showDownloadsPopup();
            }
        });

        // --- Á™óÂè£ÊéßÂà∂ÊåâÈíÆ ---
        minimizeBtn.addEventListener('click', () => window.api.sendWindowControl('minimize'));
        maximizeBtn.addEventListener('click', () => window.api.sendWindowControl('maximize'));
        closeBtn.addEventListener('click', () => window.api.sendWindowControl('close'));

        // --- ÁªÑ‰ª∂Âä†ËΩΩÂáΩÊï∞ ---
        async function loadComponents() {
            try {
                console.log('üîÑ ÂºÄÂßãÂä†ËΩΩÁªÑ‰ª∂...');
                
                // Âä†ËΩΩÊ†áÁ≠æÊ†èÁªÑ‰ª∂
                const tabsResponse = await fetch('tabs/tabs.html');
                if (!tabsResponse.ok) {
                    throw new Error(`Âä†ËΩΩ tabs.html Â§±Ë¥•: ${tabsResponse.status}`);
                }
                const tabsHTML = await tabsResponse.text();
                document.getElementById('tabs-bar-container').innerHTML = tabsHTML;
                console.log('‚úÖ Ê†áÁ≠æÊ†èÁªÑ‰ª∂Âä†ËΩΩÂÆåÊàê');

                // Âä†ËΩΩÂú∞ÂùÄÊ†èÁªÑ‰ª∂
                const addressbarResponse = await fetch('addressbar/addressbar.html');
                if (!addressbarResponse.ok) {
                    throw new Error(`Âä†ËΩΩ addressbar.html Â§±Ë¥•: ${addressbarResponse.status}`);
                }
                const addressbarHTML = await addressbarResponse.text();
                document.getElementById('addressbar-container').innerHTML = addressbarHTML;
                console.log('‚úÖ Âú∞ÂùÄÊ†èÁªÑ‰ª∂Âä†ËΩΩÂÆåÊàê');

                // Âä†ËΩΩÊî∂ËóèÂ§πÊ†èÁªÑ‰ª∂
                const bookmarksResponse = await fetch('bookmarks-bar/bookmarks-bar.html');
                if (!bookmarksResponse.ok) {
                    throw new Error(`Âä†ËΩΩ bookmarks-bar.html Â§±Ë¥•: ${bookmarksResponse.status}`);
                }
                const bookmarksHTML = await bookmarksResponse.text();
                document.getElementById('bookmarks-bar-container').innerHTML = bookmarksHTML;
                console.log('‚úÖ Êî∂ËóèÂ§πÊ†èÁªÑ‰ª∂Âä†ËΩΩÂÆåÊàê');

                // Âä†ËΩΩÊó•ÂøóÊü•ÁúãÂô®ÁªÑ‰ª∂
                const logViewerResponse = await fetch('log-viewer/log-viewer.html');
                if (!logViewerResponse.ok) {
                    throw new Error(`Âä†ËΩΩ log-viewer.html Â§±Ë¥•: ${logViewerResponse.status}`);
                }
                const logViewerHTML = await logViewerResponse.text();
                document.getElementById('log-viewer-container').innerHTML = logViewerHTML;
                console.log('‚úÖ Êó•ÂøóÊü•ÁúãÂô®ÁªÑ‰ª∂Âä†ËΩΩÂÆåÊàê');
                
                console.log('‚úÖ ÊâÄÊúâÁªÑ‰ª∂Âä†ËΩΩÂÆåÊàê');
                return true;
            } catch (error) {
                console.error('‚ùå ÁªÑ‰ª∂Âä†ËΩΩÂ§±Ë¥•:', error);
                // ‰∏çÊäõÂá∫ÈîôËØØÔºåËÄåÊòØËøîÂõû falseÔºåËÆ©Â∫îÁî®Á®ãÂ∫èÁªßÁª≠ËøêË°å
                return false;
            }
        }

        // --- ‰∏ªÂàùÂßãÂåñÂáΩÊï∞ ---
        const init = async () => {
            try {
                console.log('üöÄ ÂºÄÂßãÂàùÂßãÂåñÂ∫îÁî®Á®ãÂ∫è...');
                
                // 1. È¶ñÂÖàÂä†ËΩΩÁªÑ‰ª∂ HTML
                const componentsLoaded = await loadComponents();
                if (!componentsLoaded) {
                    console.warn('‚ö†Ô∏è ÁªÑ‰ª∂Âä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®Ê®°Âºè');
                    // Â¶ÇÊûúÁªÑ‰ª∂Âä†ËΩΩÂ§±Ë¥•ÔºåÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†Â§áÁî®HTML
                    return;
                }
                
                // 2. ÂàùÂßãÂåñÁªÑ‰ª∂ÁÆ°ÁêÜÂô®
                console.log('üîß ÂàùÂßãÂåñÁªÑ‰ª∂ÁÆ°ÁêÜÂô®...');
                tabsManager = new TabsManager();
                addressBarManager = new AddressBarManager();
                bookmarksBarManager = new BookmarksBarManager();
                logViewerManager = new LogViewerManager();
                
                // ËÆæÁΩÆÂÖ®Â±ÄÂºïÁî®
                window.tabsManager = tabsManager;
                window.addressBarManager = addressBarManager;
                window.bookmarksBarManager = bookmarksBarManager;
                window.logViewerManager = logViewerManager;
                
                // Ê†πÊçÆÂêØÂä®Êó∂ËÆæÁΩÆÂÜ≥ÂÆöÊâìÂºÄ‰ªÄ‰πàÈ°µÈù¢
                const startupOption = await window.api.getSetting('settings.startupOption') || 'homepage';
                let startupUrl;
                
                if (startupOption === 'homepage') {
                    const homepageOption = await window.api.getSetting('settings.homepageOption') || 'custom';
                    if (homepageOption === 'newtab') {
                        const newtabOption = await window.api.getSetting('settings.newtabOption') || 'blank';
                        startupUrl = newtabOption === 'blank' ? 'about:blank' : 
                                    (await window.api.getSetting('settings.newtabCustomUrl') || 'https://www.google.com');
                    } else {
                        startupUrl = await window.api.getSetting('settings.homepageCustomUrl') || 'https://www.google.com';
                    }
                } else if (startupOption === 'newtab') {
                    const newtabOption = await window.api.getSetting('settings.newtabOption') || 'blank';
                    startupUrl = newtabOption === 'blank' ? 'about:blank' : 
                                (await window.api.getSetting('settings.newtabCustomUrl') || 'https://www.google.com');
                } else if (startupOption === 'custom') {
                    startupUrl = await window.api.getSetting('settings.startupCustomUrl') || 'https://www.google.com';
                } else {
                    startupUrl = await window.api.getSetting('settings.homepageCustomUrl') || 'https://www.google.com';
                }
                
                tabsManager.createNewTab(startupUrl);
                console.log('‚úÖ Â∫îÁî®Á®ãÂ∫èÂàùÂßãÂåñÂÆåÊàê');
                
                // ÊµãËØï‰∏ãËΩΩÂºπÁ™óÊòØÂê¶Â∑•‰ΩúÔºàË∞ÉËØïÁî®Ôºâ
                setTimeout(() => {
                    console.log('Testing downloads popup functionality...');
                    if (window.addressBarManager && window.addressBarManager.showDownloadsPopup) {
                        console.log('addressBarManager.showDownloadsPopup available');
                        
                        // Ê∑ªÂä†ÊµãËØïÂø´Êç∑ÈîÆ Ctrl+Shift+D Êù•ÊâãÂä®Ëß¶Âèë‰∏ãËΩΩÂºπÁ™ó
                        document.addEventListener('keydown', (e) => {
                            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                                console.log('Manual test: showing downloads popup...');
                                window.addressBarManager.showDownloadsPopup();
                            }
                        });
                        
                    } else {
                        console.error('addressBarManager.showDownloadsPopup not available during init');
                    }
                }, 2000);
            } catch (error) {
                console.error('‚ùå Â∫îÁî®Á®ãÂ∫èÂàùÂßãÂåñÂ§±Ë¥•:', error);
            }
        };

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', init);

        // ÁõëÂê¨Êù•Ëá™ÂÖ∂‰ªñÁ™óÂè£ÁöÑÊî∂ËóèÂ§πÊõ¥Êñ∞ËØ∑Ê±Ç
        window.api.onBookmarkUpdated(() => {
            if (window.bookmarksBarManager) {
                window.bookmarksBarManager.refreshBookmarks();
            }
        });
    </script>
</body>
</html> 