<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PrismBrowser</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: sans-serif; display: flex; flex-direction: column; background-color: #dcdcdc; }
        
        /* --- Tabs Bar --- */
        #tabs-bar {
            display: flex;
            align-items: center;
            background-color: #dcdcdc;
            padding: 5px 5px 0 5px;
            flex-shrink: 0;
        }
        #tabs-container {
            display: flex;
            flex-grow: 1;
            overflow-x: auto;
        }
        .tab-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            border: 1px solid #bbb;
            border-bottom: none;
            border-radius: 6px 6px 0 0;
            background-color: #d0d0d0;
            margin-right: -1px;
            position: relative;
            cursor: pointer;
            flex-shrink: 0;
            max-width: 200px;
        }
        .tab-item.active {
            background-color: #f0f0f0;
            z-index: 2;
        }
        .tab-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 13px;
        }
        .close-tab {
            margin-left: 8px;
            width: 16px;
            height: 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            opacity: 0.5;
            padding: 0;
            border-radius: 50%;
            font-size: 12px;
            line-height: 16px;
            text-align: center;
        }
        .close-tab:hover {
            opacity: 1;
            background-color: #c0c0c0;
        }
        #new-tab-btn {
            width: 28px;
            height: 28px;
            font-size: 18px;
            margin-left: 5px;
            border: 1px solid #bbb;
            border-radius: 4px;
            background-color: #d0d0d0;
            flex-shrink: 0;
        }

        /* --- Controls Bar --- */
        #controls { display: flex; align-items: center; padding: 8px 5px; background-color: #f0f0f0; border-bottom: 1px solid #ccc; flex-shrink: 0; position: relative; z-index: 1; }
        #nav-buttons { display: flex; }
        #nav-buttons button { 
            width: 32px; 
            height: 32px; 
            margin-right: 4px; 
            border: 1px solid transparent; 
            border-radius: 4px; 
            background-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        #nav-buttons button:hover {
            background-color: #e0e0e0;
        }
        #nav-buttons button svg {
            width: 20px;
            height: 20px;
            stroke: #333;
        }
        #url-container {
            flex-grow: 1;
            position: relative;
            display: flex;
            align-items: center;
        }
        #url-input { flex-grow: 1; height: 28px; padding: 0 30px 0 15px; border-radius: 16px; border: 1px solid #ccc; margin-right: 5px; }
        #add-bookmark {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            border: none;
            background: transparent;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #add-bookmark svg {
            width: 16px;
            height: 16px;
        }
        #add-bookmark .star-fill {
            fill: #666;
            stroke: #666;
        }
        #add-bookmark .star-outline {
            fill: none;
            stroke: #666;
        }
        #toggle-logs { margin-left: 5px; height: 32px; }

        /* --- Bookmarks Bar --- */
        #bookmarks-bar {
            background-color: #fff;
            padding: 4px 8px;
            border-bottom: 1px solid #ccc;
            flex-shrink: 0;
            white-space: nowrap;
            overflow-x: auto;
        }
        .bookmark-item {
            display: inline-flex;
            align-items: center;
            padding: 5px 8px;
            border-radius: 4px;
            margin-right: 5px;
            font-size: 13px;
            cursor: pointer;
            text-decoration: none;
            color: #333;
        }
        .bookmark-item:hover {
            background-color: #e0e0e0;
        }
        .bookmark-title {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .bookmark-delete {
            margin-left: 8px;
            width: 16px;
            height: 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            opacity: 0.5;
            padding: 0;
        }
        .bookmark-delete:hover {
            opacity: 1;
        }
        
        /* --- Main Content --- */
        #main-content { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column;
            position: relative; /* Needed for error page positioning */
        }
        #webview-container { position: relative; flex-grow: 1; background-color: #fff; }
        webview { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: inline-flex !important; 
            visibility: hidden; /* Hide by default */
        }
        webview.active {
            visibility: visible;
        }
        #error-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f9f9f9;
            z-index: 100;
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-family: sans-serif;
        }
        #error-page h1 { font-size: 24px; color: #333; margin-bottom: 10px; }
        #error-page p { font-size: 16px; color: #666; }
        #error-page button { margin-top: 20px; padding: 10px 20px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; }
        #log-viewer { height: 200px; background-color: #2b2b2b; color: #f1f1f1; font-family: monospace; overflow-y: scroll; padding: 5px; white-space: pre-wrap; word-wrap: break-word; flex-shrink: 0; display: none; }
        .log-entry { margin: 0; padding: 2px 0; border-bottom: 1px solid #444; }
    </style>
</head>
<body>
    <div id="tabs-bar">
        <div id="tabs-container">
            <!-- Tabs will be dynamically inserted here -->
        </div>
        <button id="new-tab-btn" title="新建标签页">+</button>
    </div>
    <div id="controls">
        <div id="nav-buttons">
            <button id="back" title="后退">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <button id="forward" title="前进">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
            </button>
            <button id="reload" title="刷新">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
            </button>
            <button id="home" title="主页">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            </button>
        </div>
        <div id="url-container">
            <input type="text" id="url-input">
            <button id="add-bookmark" title="添加/移除收藏"></button>
        </div>
        <button id="toggle-logs">切换日志</button>
    </div>
    <div id="bookmarks-bar"></div>
    <div id="main-content">
        <div id="webview-container">
            <!-- Webviews will be dynamically inserted here -->
        </div>
        <div id="error-page">
            <h1>无法访问此网站</h1>
            <p id="error-desc"></p>
            <button id="reload-failed-url">重新加载</button>
        </div>
        <div id="log-viewer"></div>
    </div>

    <script>
        // --- Element References ---
        const tabsContainer = document.getElementById('tabs-container');
        const newTabBtn = document.getElementById('new-tab-btn');
        const webviewContainer = document.getElementById('webview-container');
        const urlInput = document.getElementById('url-input');
        const backButton = document.getElementById('back');
        const forwardButton = document.getElementById('forward');
        const reloadButton = document.getElementById('reload');
        const homeButton = document.getElementById('home');
        const addBookmarkButton = document.getElementById('add-bookmark');
        const bookmarksBar = document.getElementById('bookmarks-bar');
        const errorPage = document.getElementById('error-page');
        const errorDesc = document.getElementById('error-desc');
        const reloadFailedButton = document.getElementById('reload-failed-url');
        const toggleLogsButton = document.getElementById('toggle-logs');
        const logViewer = document.getElementById('log-viewer');
        
        let tabs = [];
        let activeTabId = null;
        let lastFailedURL = '';
        let currentBookmarks = [];
        const homeURL = 'https://www.google.com';

        const getActiveTab = () => tabs.find(t => t.id === activeTabId);

        // --- Tab Management ---
        const createNewTab = (urlToLoad = homeURL, isHidden = false) => {
            const tabId = `tab-${Date.now()}`;
            
            const tabEl = document.createElement('div');
            tabEl.className = 'tab-item';
            tabEl.dataset.tabId = tabId;
            tabEl.innerHTML = `<span class="tab-title">New Tab</span><button class="close-tab" title="关闭标签页">&#x2715;</button>`;
            tabsContainer.appendChild(tabEl);

            const webviewEl = document.createElement('webview');
            webviewEl.dataset.tabId = tabId;
            webviewEl.src = urlToLoad; // Set src directly. This is more reliable for initial load.
            webviewContainer.appendChild(webviewEl);
            
            const newTab = { id: tabId, el: tabEl, webview: webviewEl };
            tabs.push(newTab);

            tabEl.addEventListener('click', () => switchToTab(tabId));
            tabEl.querySelector('.close-tab').addEventListener('click', (e) => {
                e.stopPropagation();
                closeTab(tabId);
            });
            addWebviewListeners(newTab);
            
            if (!isHidden) {
                switchToTab(tabId);
            }
        };

        const switchToTab = (tabId) => {
            const tabToActivate = tabs.find(t => t.id === tabId);
            if (!tabToActivate) return;

            activeTabId = tabId;

            tabs.forEach(tab => {
                tab.el.classList.toggle('active', tab.id === tabId);
                tab.webview.classList.toggle('active', tab.id === tabId);
            });
            
            urlInput.value = tabToActivate.webview.getURL() || tabToActivate.webview.src;
            updateNavButtonsState();
            updateBookmarkStar(tabToActivate.webview.getURL());
            errorPage.style.display = 'none';
        };

        const closeTab = (tabId) => {
            const tabIndex = tabs.findIndex(t => t.id === tabId);
            if (tabIndex === -1) return;

            const tabToClose = tabs[tabIndex];
            tabToClose.el.remove();
            webviewContainer.removeChild(tabToClose.webview); // Proper removal
            tabs.splice(tabIndex, 1);
            
            if (activeTabId === tabId) {
                if (tabs.length > 0) {
                    const newActiveIndex = Math.max(0, tabIndex - 1);
                    switchToTab(tabs[newActiveIndex].id);
                } else {
                    createNewTab(); // Always have at least one tab
                }
            }
        };

        const updateNavButtonsState = () => {
            const tab = getActiveTab();
            if (!tab) return;
            backButton.disabled = !tab.webview.canGoBack();
            forwardButton.disabled = !tab.webview.canGoForward();
        };

        const addWebviewListeners = (tab) => {
            const { webview, el, id } = tab;
            const titleEl = el.querySelector('.tab-title');

            webview.addEventListener('page-title-updated', (e) => { titleEl.textContent = e.title; titleEl.title = e.title; });
            webview.addEventListener('did-start-loading', () => { titleEl.textContent = 'Loading...'; updateNavButtonsState(); });
            webview.addEventListener('did-stop-loading', updateNavButtonsState);
            webview.addEventListener('did-navigate', (e) => {
                if (id === activeTabId) {
                    urlInput.value = e.url;
                    updateBookmarkStar(e.url);
                }
                updateNavButtonsState();
            });
            webview.addEventListener('did-fail-load', (e) => {
                if (e.errorCode === -3) return;
                if (id === activeTabId) {
                    lastFailedURL = e.validatedURL;
                    errorDesc.textContent = `网址为 ${e.validatedURL} 的网页可能暂时无法连接...`;
                    errorPage.style.display = 'flex';
                }
            });
        };

        // --- Controls Event Listeners ---
        newTabBtn.addEventListener('click', () => createNewTab());
        backButton.addEventListener('click', () => getActiveTab()?.webview.goBack());
        forwardButton.addEventListener('click', () => getActiveTab()?.webview.goForward());
        reloadButton.addEventListener('click', () => {
            const tab = getActiveTab();
            if (!tab) return;
            // The error page has its own reload button, so this one can be simple.
            tab.webview.reload();
        });
        reloadFailedButton.addEventListener('click', () => {
            const tab = getActiveTab();
            if (tab && lastFailedURL) {
                tab.webview.loadURL(lastFailedURL);
            }
        });
        homeButton.addEventListener('click', () => {
            const tab = getActiveTab();
            if (tab) {
                tab.webview.loadURL(homeURL);
            }
        });
        urlInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const tab = getActiveTab();
                if (!tab) return;
                let url = urlInput.value;
                if (!url.startsWith('http')) {
                    url = 'https://' + url;
                }
                tab.webview.loadURL(url);
            }
        });

        // --- Bookmark Logic ---
        const renderBookmarks = (bookmarks) => {
            currentBookmarks = bookmarks;
            bookmarksBar.innerHTML = '';
            bookmarks.forEach(bookmark => {
                const item = document.createElement('a');
                item.className = 'bookmark-item';
                item.href = bookmark.url;
                item.title = `${bookmark.title}\\n${bookmark.url}`;
                
                const titleSpan = document.createElement('span');
                titleSpan.className = 'bookmark-title';
                titleSpan.textContent = bookmark.title;
                item.appendChild(titleSpan);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'bookmark-delete';
                deleteBtn.innerHTML = '&#x2715;';
                deleteBtn.title = '删除收藏';
                deleteBtn.addEventListener('click', async (e) => {
                    e.preventDefault(); e.stopPropagation();
                    const updatedBookmarks = await window.api.deleteBookmark(bookmark.url);
                    renderBookmarks(updatedBookmarks);
                    updateBookmarkStar(getActiveTab()?.webview.getURL());
                });
                item.appendChild(deleteBtn);
                item.addEventListener('click', (e) => { e.preventDefault(); createNewTab(item.href); });
                bookmarksBar.appendChild(item);
            });
        };

        const updateBookmarkStar = (url) => {
            if (!url) {
                addBookmarkButton.innerHTML = ''; return;
            }
            const isBookmarked = currentBookmarks.some(b => b.url === url);
            addBookmarkButton.innerHTML = isBookmarked
                ? `<svg class="star-fill" viewBox="0 0 24 24" stroke-width="1.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`
                : `<svg class="star-outline" viewBox="0 0 24 24" stroke-width="1.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`;
        };

        addBookmarkButton.addEventListener('click', async () => {
            const activeTab = getActiveTab();
            if (!activeTab) return;
            const url = activeTab.webview.getURL();
            const title = activeTab.webview.getTitle();
            if (!url || !title) return;

            const isBookmarked = currentBookmarks.some(b => b.url === url);
            const updatedBookmarks = isBookmarked
                ? await window.api.deleteBookmark(url)
                : await window.api.addBookmark({ url, title });
            
            renderBookmarks(updatedBookmarks);
            updateBookmarkStar(url);
        });

        // --- Log Viewer Logic ---
        toggleLogsButton.addEventListener('click', () => {
            logViewer.style.display = logViewer.style.display === 'none' ? 'block' : 'none';
        });

        window.api.onMihomoLog((log) => {
            const lines = log.trim().split(/\\r?\\n/);
            lines.forEach(line => {
                if (line.trim() === '') return;
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.textContent = line;
                if (line.includes('error') || line.includes('failed')) logEntry.style.color = '#ff6b6b';
                logViewer.appendChild(logEntry);
                logViewer.scrollTop = logViewer.scrollHeight;
            });
        });

        // --- Init ---
        const init = async () => {
            const bookmarks = await window.api.getBookmarks();
            renderBookmarks(bookmarks);
            createNewTab();
        };

        init();
    </script>
</body>
</html> 