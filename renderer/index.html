<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PrismBrowser</title>
    <link rel="stylesheet" href="theme.css">
    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: sans-serif; display: flex; flex-direction: column; background-color: var(--app-bg-color); -webkit-app-region: drag; /* Make the whole background draggable */ }
        
        /* --- Tabs Bar --- */
        #tabs-bar {
            display: flex;
            align-items: flex-end; /* Align to bottom for better look */
            background-color: var(--app-bg-color);
            padding: 5px 140px 0 5px; /* Right padding reserves space for window controls */
            flex-shrink: 0;
            /* -webkit-app-region: drag; // Moved to body */
        }
        #tabs-container {
            flex-shrink: 1;
            display: flex;
            overflow-x: auto;
            overflow-y: hidden; /* Prevent vertical scrollbar */
            -webkit-app-region: no-drag; /* Exclude scrollable area from drag */
            /* Hide scrollbar by default, will be styled below */
            scrollbar-width: none; /* For Firefox */
        }
        #tabs-container::-webkit-scrollbar {
            height: 4px; /* Set height of the scrollbar */
        }
        #tabs-container::-webkit-scrollbar-track {
            background: transparent; /* Make the track invisible */
        }
        #tabs-container::-webkit-scrollbar-thumb {
            background-color: #aaa; /* Color of the scroll thumb */
            border-radius: 2px;
        }
        #tabs-container::-webkit-scrollbar-thumb:hover {
            background-color: #888; /* Color on hover */
        }
        .tab-item {
            display: flex;
            align-items: center; /* Vertically align icon/spinner and title */
            padding: 8px 10px;
            border: 0;
            border-bottom: none;
            border-radius: 6px 6px 0 0;
            background-color: var(--tab-bg-color);
            margin-right: -1px;
            position: relative;
            cursor: pointer;
            flex-shrink: 1;   /* Allow tabs to shrink */
            min-width: 80px; /* But not too much */
            max-width: 180px; /* And not too large */
            width: 180px;     /* Default width */
            box-sizing: border-box; /* Ensure padding is included in the width */
            -webkit-app-region: no-drag; /* Tabs are clickable */
            transition: background-color 0.2s ease-in-out, width 0.15s ease-in-out; /* Add smooth transition */
        }
        .tab-item:not(.active):hover {
            background-color: var(--tab-hover-bg-color); /* Use the new theme variable */
        }
        .tab-item:not(.active):not(:hover) + .tab-item:not(.active):not(:hover)::before {
            content: '';
            position: absolute;
            left: -1px;
            top: 8px;
            bottom: 8px;
            width: 1px;
            background-color: var(--border-color-primary);
        }
        .tab-item.active {
            background-color: var(--tab-bg-color-active);
            z-index: 2;
        }
        .tab-icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            flex-shrink: 0;
        }
        .loading-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(136, 136, 136, 0.3);
            border-radius: 50%;
            border-top-color: #eee;
            animation: spin 0.8s linear infinite;
            flex-shrink: 0;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .tab-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 13px;
            flex-grow: 1; /* Allow title to take up available space */
        }
        .close-tab {
            margin-left: auto; /* Push the close button to the far right */
            width: 16px;
            height: 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            opacity: 0.5;
            padding: 0;
            border-radius: 50%;
            font-size: 12px;
            line-height: 16px;
            text-align: center;
        }
        .close-tab:hover {
            opacity: 1;
            background-color: var(--tab-close-button-hover-bg);
        }
        #new-tab-btn {
            width: 34px; /* Adjust width to be more like a square */
            height: 34px; /* Match the visual height of the tabs */
            font-size: 18px;
            margin-left: 2px;
            border: 0;
            border-radius: 4px;
            background-color: var(--tab-bg-color);
            flex-shrink: 0;
            -webkit-app-region: no-drag; /* New tab button is clickable */
            padding: 0; /* Reset padding */
            box-sizing: border-box; /* Ensure border is included */
            align-self: flex-end; /* Align to the bottom of the flex container */
            transition: background-color 0.2s ease-in-out; /* Add smooth transition */
        }
        #new-tab-btn:hover {
            background-color: var(--new-tab-button-hover-bg);
        }

        #window-controls {
            display: flex;
            position: absolute;
            top: 0;
            right: 0;
            height: 30px; /* Adjust as needed */
            -webkit-app-region: no-drag; /* These are clickable */
            z-index: 9999;
        }
        #window-controls button {
            width: 46px;
            height: 100%;
            border: none;
            background-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #window-controls button svg {
            width: 10px;
            height: 10px;
            fill: var(--text-color-primary);
        }
        #window-controls button:hover {
            background-color: var(--window-control-hover-bg);
        }
        #window-controls #close-btn:hover {
            background-color: var(--window-close-hover-bg);
            color: var(--window-close-hover-text);
        }

        /* --- Controls Bar --- */
        #controls { display: flex; align-items: center; padding: 8px 5px; background-color: var(--app-bg-color-light); border-bottom: 1px solid var(--border-color-secondary); flex-shrink: 0; position: relative; z-index: 1; -webkit-app-region: no-drag; }
        #nav-buttons { display: flex; }
        #nav-buttons button { 
            width: 32px; 
            height: 32px; 
            margin-right: 4px; 
            border: 1px solid transparent; 
            border-radius: 4px; 
            background-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        #nav-buttons button:hover {
            background-color: var(--button-hover-bg);
        }
        #nav-buttons button svg {
            width: 20px;
            height: 20px;
            stroke: var(--button-icon-color);
        }
        #url-container {
            flex-grow: 1;
            position: relative;
            display: flex;
            align-items: center;
        }
        #url-input { 
            flex-grow: 1; 
            height: 32px; /* Increased height */ 
            padding: 0 30px 0 15px; 
            border-radius: 16px; 
            border: 1px solid var(--border-color-secondary); 
            margin-right: 5px; 
            font-size: 14px; /* Slightly larger font */
        }
        #add-bookmark {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            border: none;
            background: transparent;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #add-bookmark svg {
            width: 16px;
            height: 16px;
        }
        #add-bookmark .star-fill {
            fill: var(--bookmark-star-color);
            stroke: var(--bookmark-star-color);
        }
        #add-bookmark .star-outline {
            fill: none;
            stroke: var(--bookmark-star-color);
        }
        #toggle-logs {
            height: 32px;
            width: 32px; /* Make it a square button */
            margin-left: 5px;
            border: none;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
            border-radius: 4px;
        }
        #toggle-logs:hover {
            background-color: var(--button-hover-bg);
        }
        #toggle-logs svg {
            width: 20px;
            height: 20px;
            stroke: var(--button-icon-color);
        }

        /* --- Bookmarks Bar --- */
        #bookmarks-bar {
            background-color: #fff;
            padding: 4px 8px;
            border-bottom: 1px solid var(--border-color-secondary);
            flex-shrink: 0;
            white-space: nowrap;
            overflow-x: auto;
            -webkit-app-region: no-drag;
        }
        .bookmark-item {
            display: inline-flex;
            align-items: center;
            padding: 5px 8px;
            border-radius: 4px;
            margin-right: 5px;
            font-size: 13px;
            cursor: pointer;
            text-decoration: none;
            color: var(--text-color-secondary);
        }
        .bookmark-item:hover {
            background-color: var(--button-hover-bg);
        }
        .bookmark-title {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .bookmark-delete {
            margin-left: 8px;
            width: 16px;
            height: 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            opacity: 0.5;
            padding: 0;
        }
        .bookmark-delete:hover {
            opacity: 1;
        }
        
        /* --- Main Content --- */
        #main-content { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column;
            position: relative; /* Needed for error page positioning */
            -webkit-app-region: no-drag;
        }
        #webview-container { position: relative; flex-grow: 1; background-color: #fff; }
        webview { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: inline-flex !important; 
            visibility: hidden; /* Hide by default */
        }
        webview.active {
            visibility: visible;
        }
        #error-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--error-page-bg);
            z-index: 100;
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-family: sans-serif;
        }
        #error-page h1 { font-size: 24px; color: var(--error-page-title-color); margin-bottom: 10px; }
        #error-page p { font-size: 16px; color: var(--error-page-text-color); }
        #error-page button { margin-top: 20px; padding: 10px 20px; font-size: 16px; border: 1px solid var(--border-color-secondary); border-radius: 4px; cursor: pointer; }
        #log-viewer { 
            height: 200px; 
            background-color: var(--log-viewer-bg); 
            flex-shrink: 0; 
            display: none; /* Hidden by default */
            flex-direction: column; /* To stack header and content */
        }
        #log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 8px;
            background-color: #3a3a3a;
            color: var(--text-color-light);
            flex-shrink: 0;
        }
        #log-header-title {
            font-family: sans-serif;
            font-size: 13px;
        }
        #close-log-btn {
            background: transparent;
            border: none;
            color: var(--text-color-light);
            cursor: pointer;
            font-size: 18px;
            padding: 0 4px;
        }
        #log-content {
            font-family: monospace; 
            overflow-y: scroll; 
            padding: 5px; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            flex-grow: 1; /* Take up remaining space */
            color: var(--text-color-light);
        }
        .log-entry { 
            margin: 0; 
            padding: 2px 0; 
            border-bottom: 1px solid var(--log-viewer-border);
        }
        .log-entry[style*="color"] { /* A bit of a hack to ensure error color is applied */
            color: var(--log-error-text) !important;
        }

        #actions-container {
            display: flex;
            align-items: center;
            margin-left: 5px;
        }
        #actions-container button {
            height: 32px;
            width: 32px;
            margin-left: 2px;
            border: none;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
            border-radius: 4px;
        }
        #actions-container button:hover {
            background-color: var(--button-hover-bg);
        }
        #actions-container button svg {
            width: 20px;
            height: 20px;
            stroke: var(--button-icon-color);
            fill: none;
        }
    </style>
</head>
<body>
    <div id="window-controls">
        <button id="minimize-btn" title="最小化">
            <svg x="0px" y="0px" viewBox="0 0 10.2 1"><rect x="0" y="0" width="10.2" height="1"></rect></svg>
        </button>
        <button id="maximize-btn" title="最大化">
            <svg x="0px" y="0px" viewBox="0 0 10.2 10.2"><path d="M0,0v10.2h10.2V0H0z M9.2,9.2H1V1h8.2V9.2z"></path></svg>
        </button>
        <button id="close-btn" title="关闭">
            <svg x="0px" y="0px" viewBox="0 0 10.2 10.2"><polygon points="10.2,0.7 9.5,0 5.1,4.4 0.7,0 0,0.7 4.4,5.1 0,9.5 0.7,10.2 5.1,5.8 9.5,10.2 10.2,9.5 5.8,5.1"></polygon></svg>
        </button>
    </div>
    <div id="tabs-bar">
        <div id="tabs-container">
            <!-- Tabs will be dynamically inserted here -->
        </div>
        <button id="new-tab-btn" title="新建标签页">+</button>
    </div>
    <div id="controls">
        <div id="nav-buttons">
            <button id="back" title="后退">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </button>
            <button id="forward" title="前进">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
            </button>
            <button id="reload" title="刷新">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
            </button>
            <button id="home" title="主页">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            </button>
        </div>
        <div id="url-container">
            <input type="text" id="url-input">
            <button id="add-bookmark" title="添加/移除收藏"></button>
        </div>
        <div id="actions-container">
            <button id="toggle-logs-btn" title="切换日志">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 18l6-6-6-6M8 6l-6 6 6 6"/></svg>
            </button>
            <button id="favorites-btn" title="收藏夹 (开发中)">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
            </button>
            <button id="settings-btn" title="设置 (开发中)">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
            </button>
        </div>
    </div>
    <div id="bookmarks-bar"></div>
    <div id="main-content">
        <div id="webview-container">
            <!-- Webviews will be dynamically inserted here -->
        </div>
        <div id="error-page">
            <h1>无法访问此网站</h1>
            <p id="error-desc"></p>
            <button id="reload-failed-url">重新加载</button>
        </div>
        <div id="log-viewer">
            <div id="log-header">
                <span id="log-header-title">日志</span>
                <button id="close-log-btn" title="关闭日志面板">&times;</button>
            </div>
            <div id="log-content"></div>
        </div>
    </div>

    <script>
        // --- Element References ---
        const minimizeBtn = document.getElementById('minimize-btn');
        const maximizeBtn = document.getElementById('maximize-btn');
        const closeBtn = document.getElementById('close-btn');
        const tabsContainer = document.getElementById('tabs-container');
        const newTabBtn = document.getElementById('new-tab-btn');
        const webviewContainer = document.getElementById('webview-container');
        const urlInput = document.getElementById('url-input');
        const backButton = document.getElementById('back');
        const forwardButton = document.getElementById('forward');
        const reloadButton = document.getElementById('reload');
        const homeButton = document.getElementById('home');
        const addBookmarkButton = document.getElementById('add-bookmark');
        const bookmarksBar = document.getElementById('bookmarks-bar');
        const errorPage = document.getElementById('error-page');
        const errorDesc = document.getElementById('error-desc');
        const reloadFailedButton = document.getElementById('reload-failed-url');
        const toggleLogsButton = document.getElementById('toggle-logs-btn');
        const logViewer = document.getElementById('log-viewer');
        const logContent = document.getElementById('log-content');
        const closeLogBtn = document.getElementById('close-log-btn');
        
        let tabs = [];
        let activeTabId = null;
        let lastFailedURL = '';
        let currentBookmarks = [];
        const homeURL = 'https://www.google.com';

        // --- Wheel scrolling for tabs ---
        tabsContainer.addEventListener('wheel', (e) => {
            // e.deltaY is the vertical scroll amount.
            // We prevent the default vertical scroll and apply it horizontally.
            if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
                e.preventDefault();
                tabsContainer.scrollLeft += e.deltaY;
            }
        });

        // --- Icon and Spinner Definitions ---
        const defaultGlobeIcon = `<svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>`;
        const loadingSpinner = `<div class="loading-spinner"></div>`;

        const getActiveTab = () => tabs.find(t => t.id === activeTabId);

        // --- Helper function to extract hostname ---
        const getHostname = (url) => {
            try {
                return new URL(url).hostname;
            } catch (e) {
                return url; // fallback to the original url if it's not valid
            }
        };

        // --- Helper function to set tab icon ---
        const setTabIcon = (tabEl, iconHTML) => {
            const currentIcon = tabEl.querySelector('.tab-icon, .loading-spinner');
            if (currentIcon) {
                const newIcon = new DOMParser().parseFromString(iconHTML, "text/html").body.firstChild;
                currentIcon.parentNode.replaceChild(newIcon, currentIcon);
            }
        };

        // --- Tab Management ---
        const createNewTab = (urlToLoad = homeURL, isHidden = false) => {
            const tabId = `tab-${Date.now()}`;
            
            const tabEl = document.createElement('div');
            tabEl.className = 'tab-item';
            tabEl.dataset.tabId = tabId;
            tabEl.innerHTML = `
                ${defaultGlobeIcon}
                <span class="tab-title">New Tab</span>
                <button class="close-tab" title="关闭标签页">&times;</button>
            `;
            tabsContainer.appendChild(tabEl);

            const webviewEl = document.createElement('webview');
            webviewEl.dataset.tabId = tabId;
            webviewEl.src = urlToLoad; // Restore setting src for reliable initialization.
            
            // It's important to append to DOM before adding listeners in some cases.
            webviewContainer.appendChild(webviewEl);
            
            const newTab = { id: tabId, el: tabEl, webview: webviewEl };
            tabs.push(newTab);

            // Attach listeners before any potential navigation from user input.
            addWebviewListeners(newTab);

            tabEl.addEventListener('click', () => switchToTab(tabId));
            tabEl.querySelector('.close-tab').addEventListener('click', (e) => {
                e.stopPropagation();
                closeTab(tabId);
            });
            
            if (!isHidden) {
                switchToTab(tabId);
            }
            // No need to call loadURL again if src is set.
        };

        const switchToTab = (tabId) => {
            const tabToActivate = tabs.find(t => t.id === tabId);
            if (!tabToActivate) return;

            activeTabId = tabId;

            tabs.forEach(tab => {
                tab.el.classList.toggle('active', tab.id === tabId);
                tab.webview.classList.toggle('active', tab.id === tabId);
            });
            
            // Scroll the active tab into view if it's not fully visible
            const tabEl = tabToActivate.el;
            const container = tabsContainer;
            const tabRect = tabEl.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();

            if (tabRect.left < containerRect.left) {
                container.scrollLeft -= containerRect.left - tabRect.left;
            } else if (tabRect.right > containerRect.right) {
                container.scrollLeft += tabRect.right - containerRect.right;
            }

            urlInput.value = tabToActivate.webview.getURL() || tabToActivate.webview.src;
            updateNavButtonsState();
            updateBookmarkStar(tabToActivate.webview.getURL());
            errorPage.style.display = 'none';
        };

        const closeTab = (tabId) => {
            const tabIndex = tabs.findIndex(t => t.id === tabId);
            if (tabIndex === -1) return;

            const tabToClose = tabs[tabIndex];
            tabToClose.el.remove();
            webviewContainer.removeChild(tabToClose.webview); // Proper removal
            tabs.splice(tabIndex, 1);
            
            if (activeTabId === tabId) {
                if (tabs.length > 0) {
                    const newActiveIndex = Math.max(0, tabIndex - 1);
                    switchToTab(tabs[newActiveIndex].id);
                } else {
                    createNewTab(); // Always have at least one tab
                }
            }
        };

        const updateNavButtonsState = () => {
            const tab = getActiveTab();
            if (!tab) return;
            backButton.disabled = !tab.webview.canGoBack();
            forwardButton.disabled = !tab.webview.canGoForward();
        };

        // --- Event Listeners for Webviews (This is the core change) ---
        const addWebviewListeners = (tab) => {
            const { webview, el, id } = tab;
            const titleEl = el.querySelector('.tab-title');

            webview.addEventListener('page-favicon-updated', (e) => {
                if (e.favicons && e.favicons.length > 0) {
                    const bestFavicon = e.favicons[0];
                    setTabIcon(el, `<img class="tab-icon" src="${bestFavicon}">`);
                }
            });

            webview.addEventListener('page-title-updated', (e) => { titleEl.textContent = e.title; titleEl.title = e.title; });
            
            webview.addEventListener('did-start-loading', () => { 
                // Only set title to hostname if it's a brand new tab.
                // This prevents title flicker on reloads.
                if (titleEl.textContent === 'New Tab') {
                    const url = webview.getURL() || webview.src;
                    titleEl.textContent = getHostname(url);
                }
                setTabIcon(el, loadingSpinner);
                updateNavButtonsState(); 
            });

            webview.addEventListener('did-finish-load', async () => {
                // Proactively check for favicon if the event didn't fire
                const currentIcon = el.querySelector('.tab-icon, .loading-spinner');
                // Only try to fetch if we are still showing a spinner (meaning favicon event failed)
                if (currentIcon && currentIcon.classList.contains('loading-spinner')) {
                    try {
                        const faviconURL = await webview.executeJavaScript(`
                            (() => {
                                const icon = document.querySelector('link[rel="icon"], link[rel="shortcut icon"]');
                                return icon ? icon.href : null;
                            })();
                        `);
                        if (faviconURL) {
                            setTabIcon(el, `<img class="tab-icon" src="${faviconURL}">`);
                        } else {
                            setTabIcon(el, defaultGlobeIcon); // Fallback to globe if not found
                        }
                    } catch (error) {
                        console.error('Error fetching favicon via JS:', error);
                        setTabIcon(el, defaultGlobeIcon); // Fallback on error
                    }
                }
            });

            webview.addEventListener('did-stop-loading', () => {
                updateNavButtonsState();
            });

            webview.addEventListener('did-navigate', (e) => {
                if (id === activeTabId) {
                    urlInput.value = e.url;
                    updateBookmarkStar(e.url);
                }
                updateNavButtonsState();
            });

            webview.addEventListener('did-fail-load', (e) => {
                if (e.errorCode === -3) return; // Ignore user abort
                setTabIcon(el, defaultGlobeIcon); // On failure, show globe
                
                // Explicitly set title to the failed hostname
                titleEl.textContent = getHostname(e.validatedURL);

                if (id === activeTabId) {
                    lastFailedURL = e.validatedURL;
                    errorDesc.textContent = `网址为 ${e.validatedURL} 的网页可能暂时无法连接...`;
                    errorPage.style.display = 'flex';
                }
            });
        };

        // --- Controls Event Listeners ---
        newTabBtn.addEventListener('click', () => createNewTab());
        backButton.addEventListener('click', () => getActiveTab()?.webview.goBack());
        forwardButton.addEventListener('click', () => getActiveTab()?.webview.goForward());
        reloadButton.addEventListener('click', () => {
            const tab = getActiveTab();
            if (!tab) return;
            // The error page has its own reload button, so this one can be simple.
            tab.webview.reload();
        });
        reloadFailedButton.addEventListener('click', () => {
            const tab = getActiveTab();
            if (tab && lastFailedURL) {
                tab.webview.loadURL(lastFailedURL);
            }
        });
        homeButton.addEventListener('click', () => {
            const tab = getActiveTab();
            if (tab) {
                tab.webview.loadURL(homeURL);
            }
        });
        urlInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const tab = getActiveTab();
                if (!tab) return;
                let url = urlInput.value;
                if (!url.startsWith('http')) {
                    url = 'https://' + url;
                }
                tab.webview.loadURL(url);
            }
        });

        // --- Bookmark Logic ---
        const renderBookmarks = (bookmarks) => {
            currentBookmarks = bookmarks;
            bookmarksBar.innerHTML = '';
            bookmarks.forEach(bookmark => {
                const item = document.createElement('a');
                item.className = 'bookmark-item';
                item.href = bookmark.url;
                item.title = `${bookmark.title}\\n${bookmark.url}`;
                
                const titleSpan = document.createElement('span');
                titleSpan.className = 'bookmark-title';
                titleSpan.textContent = bookmark.title;
                item.appendChild(titleSpan);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'bookmark-delete';
                deleteBtn.innerHTML = '&#x2715;';
                deleteBtn.title = '删除收藏';
                deleteBtn.addEventListener('click', async (e) => {
                    e.preventDefault(); e.stopPropagation();
                    const updatedBookmarks = await window.api.deleteBookmark(bookmark.url);
                    renderBookmarks(updatedBookmarks);
                    updateBookmarkStar(getActiveTab()?.webview.getURL());
                });
                item.appendChild(deleteBtn);
                item.addEventListener('click', (e) => { e.preventDefault(); createNewTab(item.href); });
                bookmarksBar.appendChild(item);
            });
        };

        const updateBookmarkStar = (url) => {
            if (!url) {
                addBookmarkButton.innerHTML = ''; return;
            }
            const isBookmarked = currentBookmarks.some(b => b.url === url);
            addBookmarkButton.innerHTML = isBookmarked
                ? `<svg class="star-fill" viewBox="0 0 24 24" stroke-width="1.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`
                : `<svg class="star-outline" viewBox="0 0 24 24" stroke-width="1.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`;
        };

        addBookmarkButton.addEventListener('click', async () => {
            const activeTab = getActiveTab();
            if (!activeTab) return;
            const url = activeTab.webview.getURL();
            const title = activeTab.webview.getTitle();
            if (!url || !title) return;

            const isBookmarked = currentBookmarks.some(b => b.url === url);
            const updatedBookmarks = isBookmarked
                ? await window.api.deleteBookmark(url)
                : await window.api.addBookmark({ url, title });
            
            renderBookmarks(updatedBookmarks);
            updateBookmarkStar(url);
        });

        // --- Log Viewer Logic ---
        toggleLogsButton.addEventListener('click', () => {
            const isCurrentlyHidden = logViewer.style.display !== 'flex'; // It's a flex container now
            logViewer.style.display = isCurrentlyHidden ? 'flex' : 'none';
        });

        closeLogBtn.addEventListener('click', () => {
            logViewer.style.display = 'none';
        });

        window.api.onMihomoLog((log) => {
            const lines = log.trim().split(/\\r?\\n/);
            lines.forEach(line => {
                if (line.trim() === '') return;
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.textContent = line;
                if (line.includes('error') || line.includes('failed')) {
                    logEntry.style.color = 'var(--log-error-text)';
                }
                logContent.appendChild(logEntry); // Append to new content area
                logContent.scrollTop = logContent.scrollHeight; // Scroll new content area
            });
        });

        // --- Window Controls ---
        minimizeBtn.addEventListener('click', () => window.api.sendWindowControl('minimize'));
        maximizeBtn.addEventListener('click', () => window.api.sendWindowControl('maximize'));
        closeBtn.addEventListener('click', () => window.api.sendWindowControl('close'));

        // --- Init ---
        const init = async () => {
            const bookmarks = await window.api.getBookmarks();
            renderBookmarks(bookmarks);
            createNewTab();
        };

        init();
    </script>
</body>
</html> 